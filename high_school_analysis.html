<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊõâÊòéÂ•≥‰∏≠Êï∏Â≠∏ÁßëÂ∞àÊ•≠Ë©¶È°åÂàÜÊûêÁ≥ªÁµ±-È´ò‰∏≠Áâà</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff9800;
            animation: pulse 1.5s infinite;
            margin-right: 10px;
        }
        
        .status-indicator.ready {
            background: #4caf50;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .badge {
            display: inline-block;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 2px;
        }

        .advantage-badge { background: #2196f3; }
        .reasonable-correct-badge { background: #4caf50; }
        .reasonable-wrong-badge { background: #ff9800; }
        .misconception-badge { background: #f44336; }
        .good-badge { background: #4caf50; }
        .acceptable-badge { background: #ffc107; }
        .poor-badge { background: #f44336; }
        
        .misconception-highlight {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 20px;
            background: #e5e7eb;
            border: 2px solid #d1d5db;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .score-table {
            font-size: 0.9em;
            border-collapse: separate;
            border-spacing: 0;
        }

        .score-table thead {
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .score-table th {
            background: #1e40af !important;
            color: white !important;
            font-weight: bold;
            padding: 12px 8px !important;
            border: 1px solid #1e3a8a !important;
            text-align: center;
        }

        .score-table td.correct {
            background-color: #c8e6c9;
            color: #2e7d32;
            font-weight: 700;
            text-align: center;
        }

        .score-table td.incorrect {
            background-color: #ffcdd2;
            color: #c62828;
            font-weight: 700;
            text-align: center;
        }

        .score-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .score-table tbody tr:hover td.correct {
            background-color: #a5d6a7;
        }

        .score-table tbody tr:hover td.incorrect {
            background-color: #ef9a9a;
        }

        .sticky-col-class {
            position: sticky;
            left: 0;
            background: white !important;
            z-index: 15;
            border-right: 3px solid #1e40af !important;
            font-weight: 600;
        }

        .sticky-col-name {
            position: sticky;
            left: 100px;
            background: white !important;
            z-index: 15;
            border-right: 3px solid #1e40af !important;
            font-weight: 600;
        }

        .score-table thead th.sticky-col-class,
        .score-table thead th.sticky-col-name {
            background: #1e40af !important;
            z-index: 25;
        }

        .score-table tfoot td {
            background: #f3f4f6 !important;
            font-weight: 600;
            border: 1px solid #d1d5db !important;
            padding: 10px 8px;
        }

        .table-container {
            max-height: 600px;
            overflow: auto;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .error-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .header-container {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyMCIgaGVpZ2h0PSI0MDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJiZ0dyYWQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMxZTNhOGE7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSI1MCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMyNTYzZWI7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMzg5NWZmO3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjYmdHcmFkKSIvPjwvc3ZnPg==');
            background-size: cover;
            background-position: center;
            border-radius: 20px;
            padding: 60px 40px;
            box-shadow: 0 10px 40px rgba(30, 58, 138, 0.4);
            position: relative;
            overflow: hidden;
        }

        .header-with-image {
            background-image: url('./analysis-bg.png');
            background-size: cover;
            background-position: center left;
            background-repeat: no-repeat;
        }

        .header-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.85) 0%, rgba(37, 99, 235, 0.75) 50%, rgba(56, 149, 255, 0.65) 100%);
            z-index: 1;
        }

        .header-content {
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .school-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            letter-spacing: 4px;
            animation: fadeInDown 1s ease-out;
        }

        .system-title {
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(to right, #fbbf24, #f59e0b, #fde047);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(251, 191, 36, 0.6);
            margin-bottom: 10px;
            letter-spacing: 6px;
            animation: fadeInUp 1s ease-out 0.3s both;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hex-pattern {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0.1;
            z-index: 1;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 35px, rgba(255,255,255,0.1) 35px, rgba(255,255,255,0.1) 36px),
                repeating-linear-gradient(60deg, transparent, transparent 35px, rgba(255,255,255,0.1) 35px, rgba(255,255,255,0.1) 36px),
                repeating-linear-gradient(120deg, transparent, transparent 35px, rgba(255,255,255,0.1) 35px, rgba(255,255,255,0.1) 36px);
        }

        .kidmap-visual {
            background: white;
            border: 2px solid #333;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .kidmap-quadrants {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr 1fr auto;
            min-height: 400px;
            position: relative;
        }
        
        .kidmap-header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .kidmap-footer {
            grid-column: 1 / -1;
            background: #f8f9fa;
            padding: 12px;
            text-align: center;
            border-top: 2px solid #ddd;
            font-size: 0.85em;
            color: #666;
        }
        
        .quadrant {
            padding: 10px;
            border: 1px solid #ddd;
            position: relative;
            overflow-y: auto;
            min-height: 100px;
        }
        
        .quadrant-top-left {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-right: 2px solid #4CAF50;
            border-bottom: 2px solid #4CAF50;
        }
        
        .quadrant-top-right {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-bottom: 2px solid #FF9800;
        }
        
        .quadrant-bottom-left {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-right: 2px solid #2196F3;
        }
        
        .quadrant-bottom-right {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }
        
        .quadrant-title {
            font-weight: 700;
            font-size: 1em;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }
        
        /* ‰øÆÊ≠£ËÉΩÂäõÁ∑öÊ®£Âºè */
        .ability-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
            z-index: 100;
            box-shadow: 0 0 10px rgba(245, 87, 108, 0.5);
            pointer-events: none;
        }
        
        .ability-label {
            position: absolute;
            right: 10px;
            top: -25px;
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        
        .item-badge {
            /* display: inline-block; */ /* <-- ËàäÁöÑ */
            display: inline-flex; /* <-- Êñ∞ÁöÑÔºö‰ΩøÁî® Flexbox */
            align-items: center; /* <-- Êñ∞ÁöÑÔºöÂûÇÁõ¥Â±Ö‰∏≠ */
            justify-content: center; /* <-- Êñ∞ÁöÑÔºöÊ∞¥Âπ≥Â±Ö‰∏≠ */
            position: relative;
            margin: 3px;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.85em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            white-space: nowrap;
            vertical-align: middle;
        }
        /* * ÁßªÈô§‰∫Ü .item-badge > * ÈÅ∏ÊìáÂô®ÔºåÂõ†ÁÇ∫ Flexbox ÊúÉËá™ÂãïËôïÁêÜÂ±Ö‰∏≠
         */
        
        .item-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .item-badge.correct {
            background: #4CAF50;
            color: white;
        }
        
        .item-badge.incorrect {
            background: #f44336;
            color: white;
        }
        
        .item-badge.unexpected {
            animation: pulse-kidmap 2s infinite;
            border: 2px solid #ff6b6b;
        }
        
        @keyframes pulse-kidmap {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
        }
        
        .item-info {
            display: inline;
            vertical-align: middle;
            font-size: 0.75em;
            opacity: 0.8;
            margin-left: 3px;
        }

        /* ÈÄêÈ°åÂàÜÊûêË°®Ê†ºÊ®£Âºè */
        .item-analysis-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }
        
        .item-analysis-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .item-analysis-table th {
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }
        
        .item-analysis-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .item-analysis-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .item-analysis-table .correct-cell {
            color: #4CAF50;
            font-weight: 700;
        }
        
        .item-analysis-table .incorrect-cell {
            color: #f44336;
            font-weight: 700;
        }
        
        .item-analysis-table .unexpected-cell {
            background: #fff3cd;
            font-weight: 700;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            max-width: 1200px;
            margin: 20px auto;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .modal-body {
            padding: 30px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .diagnostic-stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 10px 0;
        }
        
        .diag-card {
            background: white;
            padding: 8px 10px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            border-left: 3px solid #667eea;
        }
        
        .diag-card.warning {
            border-left-color: #FF9800;
            background: #fff8e1;
        }
        
        .diag-card.danger {
            border-left-color: #f44336;
            background: #ffebee;
        }
        
        .diag-card.success {
            border-left-color: #4CAF50;
            background: #e8f5e9;
        }
        
        .diag-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .diag-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #333;
            line-height: 1.2; 
            margin-top: 2px;
            margin-bottom: 2px;
        }

        .student-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .download-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border: 2px solid #4facfe;
            border-radius: 15px;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        
        .download-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
        }
        
        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-container {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #4facfe;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }
        
        .progress-text {
            text-align: center;
            color: #666;
            font-size: 0.95em;
            margin-top: 10px;
        }

        /* PDF Â∞àÁî®Ê®£Âºè */
        .pdf-container {
            position: fixed;
            left: -9999px;
            top: 0;
            width: 210mm;
            background: white;
        }
        
        .pdf-page {
            width: 210mm;
            height: 297mm;
            padding: 15mm;
            background: white;
            page-break-after: always;
            box-sizing: border-box;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/"
  }
}
</script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <header class="header-container header-with-image mb-8">
            <div class="hex-pattern"></div>
            <div class="header-overlay"></div>
            <div class="header-content">
                <h1 class="school-title">ÊõâÊòéÂ•≥‰∏≠Êï∏Â≠∏ÁßëÔºàÈ´ò‰∏≠ÁâàÔºâ</h1>
                <h2 class="system-title">Â∞àÊ•≠Ë©¶È°åÂàÜÊûêÁ≥ªÁµ±</h2>
            </div>
        </header>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <span class="status-indicator" id="statusIndicator"></span>
                    <strong>Á≥ªÁµ±ÁãÄÊÖã:</strong>
                    <span id="statusText">Ê≠£Âú®ÂàùÂßãÂåñ WebR...</span>
                </div>
                <div class="text-sm text-gray-500" id="progressText">0%</div>
            </div>
            <div class="w-full h-2 bg-gray-200 rounded-full mt-3">
                <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all" id="progressBar" style="width: 0%"></div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center gap-4">
                <div class="flex-1 text-center" id="stepIndicator1">
                    <div class="w-12 h-12 mx-auto rounded-full bg-blue-500 text-white flex items-center justify-center font-bold mb-2">1</div>
                    <div class="text-sm font-semibold">‰∏äÂÇ≥CSV</div>
                </div>
                <div class="flex-1 border-t-2 border-gray-300"></div>
                <div class="flex-1 text-center" id="stepIndicator2">
                    <div class="w-12 h-12 mx-auto rounded-full bg-gray-300 text-white flex items-center justify-center font-bold mb-2">2</div>
                    <div class="text-sm font-semibold">Ë®≠ÂÆöÈ°åÂûã</div>
                </div>
                <div class="flex-1 border-t-2 border-gray-300"></div>
                <div class="flex-1 text-center" id="stepIndicator3">
                    <div class="w-12 h-12 mx-auto rounded-full bg-gray-300 text-white flex items-center justify-center font-bold mb-2">3</div>
                    <div class="text-sm font-semibold">Ë©ïÂàÜÊ™¢Êü•</div>
                </div>
                <div class="flex-1 border-t-2 border-gray-300"></div>
                <div class="flex-1 text-center" id="stepIndicator4">
                    <div class="w-12 h-12 mx-auto rounded-full bg-gray-300 text-white flex items-center justify-center font-bold mb-2">4</div>
                    <div class="text-sm font-semibold">Â∞àÊ•≠ÂàÜÊûê</div>
                </div>
            </div>
        </div>

        <div id="mainContent"></div>
    </div>

    <div class="modal" id="kidmapModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="kidmapModalTitle">KIDMAP Ë®∫Êñ∑Â†±Âëä</h2>
                <button class="close-btn" onclick="closeKidmapModal()">√ó</button>
            </div>
            <div class="modal-body" id="kidmapModalBody"></div>
        </div>
    </div>

    <div id="pdfContainer" class="pdf-container"></div>

    <script type="module">
        import { WebR } from 'https://webr.r-wasm.org/latest/webr.mjs';
        
        let webR;
        let isWebRReady = false;
        let currentStep = 1;
        let selectedEncoding = 'BIG5';
        let fileName = '';
        let csvData = [];
        let standardAnswer = '';
        let standardAnswerSource = '';
        let totalGrids = 0;
        let grids = [];
        let selectedGrids = new Set();
        let selectionMode = 'click';
        let currentType = 'single';
        let scoringMatrix = null;
        let rangeStart = '';
        let rangeEnd = '';
        let analysisData = null;

        const multipleChoiceMap = {
            'F': '12', 'G': '13', 'H': '14', 'I': '15', 'J': '23',
            'K': '24', 'L': '25', 'M': '34', 'N': '35', 'O': '45',
            'P': '123', 'Q': '124', 'R': '125', 'S': '134', 'T': '135',
            'U': '145', 'V': '234', 'W': '235', 'X': '245', 'Y': '345',
            'Z': '1234', '*': '1235', '$': '1245', '%': '1345', ',': '2345',
            '#': '12345', '=': '', '?': '?', '.': '.'
        };

        async function initWebR() {
            try {
                updateWebRStatus('Ê≠£Âú®ÂàùÂßãÂåñ WebR...', 10);
                webR = new WebR();
                await webR.init();
                
                updateWebRStatus('Ê≠£Âú®ÂÆâË£ù MASS Â•ó‰ª∂...', 20);
                await webR.installPackages(['MASS']);
                
                updateWebRStatus('Ê≠£Âú®ÂÆâË£ù TAM Â•ó‰ª∂...ÔºàÈÄôÂèØËÉΩÈúÄË¶ÅÂπæÂàÜÈêòÔºâ', 35);
                await webR.installPackages(['TAM']);
                
                updateWebRStatus('Ê≠£Âú®ÂÆâË£ù WrightMap Â•ó‰ª∂...', 55);
                await webR.installPackages(['WrightMap']);
                
                updateWebRStatus('Ê≠£Âú®ËºâÂÖ•Â•ó‰ª∂...', 75);
                await webR.evalR('library(MASS)');
                await webR.evalR('library(TAM)');
                await webR.evalR('library(WrightMap)');
                
                updateWebRStatus('Á≥ªÁµ±Ê∫ñÂÇôÂ∞±Á∑íÔºÅ', 100, true);
                isWebRReady = true;
                
            } catch (error) {
                updateWebRStatus('ÂàùÂßãÂåñÂ§±ÊïóÔºö' + error.message, 0);
                console.error('WebR initialization error:', error);
            }
        }

        function updateWebRStatus(text, progress, ready = false) {
            document.getElementById('statusText').textContent = text;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '%';
            if (ready) {
                document.getElementById('statusIndicator').classList.add('ready');
            }
        }

        function cleanCSVValue(value) {
            if (!value) return '';
            let cleaned = value.trim();
            if ((cleaned.startsWith('"') && cleaned.endsWith('"')) || 
                (cleaned.startsWith("'") && cleaned.endsWith("'"))) {
                cleaned = cleaned.slice(1, -1);
            }
            cleaned = cleaned.replace(/["""''']/g, '');
            return cleaned.trim();
        }

        function parseCSVLine(line) {
            const values = [];
            let currentValue = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentValue += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(cleanCSVValue(currentValue));
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }
            values.push(cleanCSVValue(currentValue));
            return values;
        }

        function isStandardAnswerCard(status) {
            if (!status || status.length === 0) return false;
            for (let char of status) {
                if (char !== '.' && char !== '=') return false;
            }
            const dotCount = (status.match(/\./g) || []).length;
            const equalCount = (status.match(/=/g) || []).length;
            return dotCount >= 10 && equalCount > 0;
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const parsedData = [];
            let answer = '';
            let answerSource = '';
            
            let headerIndex = -1;
            let headers = [];
            
            // New robust logic: Look for student ID, name, and class first.
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (line.includes('Â≠∏Ëôü') && line.includes('ÂßìÂêç') && (line.includes('Áè≠Á¥ö') || line.includes('Áè≠Á¥öÁ∞°Á®±'))) {
                    headerIndex = i;
                    headers = parseCSVLine(line);
                    break;
                }
            }

            // Fallback to original logic if the new one fails
            if (headerIndex === -1) {
                 for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('Â≠∏ÁîüÁ≠îÊ°à')) {
                        headerIndex = i;
                        headers = parseCSVLine(lines[i]);
                        break;
                    }
                }
            }
            
            if (headerIndex === -1) {
                throw new Error('Êâæ‰∏çÂà∞Â≠∏ÁîüË≥áÊñôÊ®ôÈ†≠„ÄÇË´ãÁ¢∫Ë™çCSVÊ™îÊ°àÂåÖÂê´ "Â≠∏Ëôü"„ÄÅ"ÂßìÂêç"„ÄÅ"Áè≠Á¥ö" Á≠âÊ¨Ñ‰Ωç„ÄÇ');
            }
            
            // NEW: Check for essential columns and provide a specific error message.
            if (!headers.includes('Â≠∏ÁîüÁ≠îÊ°à') || !headers.includes('‰ΩúÁ≠îÊÉÖÂΩ¢')) {
                 throw new Error('CSVÊ™îÊ°àÊ†ºÂºè‰∏çÁ¨¶„ÄÇÊ™îÊ°à‰∏≠ÂøÖÈ†àÂåÖÂê´ "Â≠∏ÁîüÁ≠îÊ°à" Âíå "‰ΩúÁ≠îÊÉÖÂΩ¢" Ê¨Ñ‰ΩçÊâçËÉΩÈÄ≤Ë°åÂàÜÊûê„ÄÇÊÇ®‰∏äÂÇ≥ÁöÑÊ™îÊ°à‰ºº‰πéÊòØÊàêÁ∏æÂ†±ÂëäÔºåËÄåÈùûÂéüÂßãÁ≠îÊ°àÊ™î„ÄÇ');
            }
            
            const answerIndex = headers.indexOf('Â≠∏ÁîüÁ≠îÊ°à');
            const statusIndex = headers.indexOf('‰ΩúÁ≠îÊÉÖÂΩ¢');
            const nameIndex = headers.indexOf('ÂßìÂêç');
            const seatIndex = headers.indexOf('Â∫ßËôü');
            
            let classIndex = headers.indexOf('Áè≠Á¥öÁ∞°Á®±');
            if (classIndex === -1) classIndex = headers.indexOf('Áè≠Á¥ö');
            if (classIndex === -1) classIndex = headers.indexOf('Áè≠Á¥ö‰ª£Ëôü');
            if (classIndex === -1) classIndex = headers.indexOf('Áè≠Á¥öÂêçÁ®±');
            if (classIndex === -1) classIndex = headers.indexOf('CLASS');
            
            // Added check for essential columns existence
            if (classIndex === -1 || nameIndex === -1) {
                throw new Error('CSVÊ™îÊ°à‰∏≠Êâæ‰∏çÂà∞ "Áè≠Á¥ö" Êàñ "ÂßìÂêç" Ê¨Ñ‰Ωç„ÄÇ');
            }
            
            let grids = 0;
            
            for (let i = headerIndex + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || line.startsWith(',,,')) continue;
                
                const values = parseCSVLine(line);
                if (values.length < headers.length) continue;
                
                const name = cleanCSVValue(values[nameIndex] || '');
                const studentAnswer = cleanCSVValue(values[answerIndex] || '');
                const status = cleanCSVValue(values[statusIndex] || '');
                const seat = cleanCSVValue(values[seatIndex] || '');
                const classValue = cleanCSVValue(values[classIndex] || '');
                
                if (!name) continue;
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = cleanCSVValue(values[index] || '');
                });
                
                if (classIndex !== -1) {
                    row['Áè≠Á¥ö'] = classValue;
                }
                
                parsedData.push(row);
                
                if (!answer && status && isStandardAnswerCard(status)) {
                    answer = studentAnswer;
                    grids = answer.length;
                    answerSource = `${name}ÔºàÂ∫ßËôü ${seat}Ôºâ`;
                }
            }
            
            if (!answer && parsedData.length > 0) {
                if (answerIndex > -1 && parsedData[0]['Â≠∏ÁîüÁ≠îÊ°à']) {
                     grids = parsedData[0]['Â≠∏ÁîüÁ≠îÊ°à'].length;
                } else {
                    grids = 0; 
                }
            }
            
            return { parsedData, answer, answerSource, grids };
        }

        window.handleFile = function(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const { parsedData, answer, answerSource, grids } = parseCSV(text);
                    
                    csvData = parsedData;
                    standardAnswer = answer;
                    standardAnswerSource = answerSource;
                    totalGrids = grids;
                    fileName = file.name;
                    
                    renderStep1();
                } catch (error) {
                    alert('Ê™îÊ°àËß£ÊûêÂ§±ÊïóÔºö' + error.message);
                    console.error('Parse error:', error);
                }
            };
            
            if (selectedEncoding === 'BIG5') {
                reader.readAsText(file, 'Big5');
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        };

        window.setEncodingBIG5 = function() {
            selectedEncoding = 'BIG5';
            renderStep1();
        }

        window.setEncodingUTF8 = function() {
            selectedEncoding = 'UTF-8';
            renderStep1();
        }

        window.setManualAnswer = function() {
            const input = document.getElementById('manualAnswer');
            const answer = cleanCSVValue(input.value);
            
            if (answer.length !== totalGrids) {
                alert(`Ê®ôÊ∫ñÁ≠îÊ°àÂøÖÈ†àÊòØ ${totalGrids} ÂÄãÂ≠óÂÖÉÔºåÁõÆÂâçÂè™Êúâ ${answer.length} ÂÄã`);
                return;
            }
            
            standardAnswer = answer;
            standardAnswerSource = 'ÊâãÂãïËº∏ÂÖ•';
            renderStep1();
        };

        window.initializeGrids = function() {
            grids = [];
            for (let i = 0; i < standardAnswer.length; i++) {
                if (standardAnswer[i] !== '=') {
                    grids.push({
                        number: i + 1,
                        answer: standardAnswer[i],
                        type: null,
                        groupId: null,
                        originalIndex: i
                    });
                }
            }
            selectedGrids = new Set();
            currentStep = 2;
            updateStepIndicator();
            renderStep2();
        };

        window.toggleGridSelection = function(index) {
            if (selectedGrids.has(index)) {
                selectedGrids.delete(index);
            } else {
                selectedGrids.add(index);
            }
            renderStep2();
        };

        window.selectGridsByRange = function() {
            const start = parseInt(rangeStart);
            const end = parseInt(rangeEnd);
            
            if (!start || !end) {
                alert('Ë´ãËº∏ÂÖ•Ëµ∑ÂßãÂíåÁµêÊùüÊ†ºËôü');
                return;
            }
            
            selectedGrids = new Set();
            grids.forEach((grid, index) => {
                if (grid.number >= start && grid.number <= end) {
                    selectedGrids.add(index);
                }
            });
            
            if (selectedGrids.size === 0) {
                alert(`Êâæ‰∏çÂà∞Ê†ºËôü ${start} Âà∞ ${end} ÁöÑÊ†ºÂ≠ê`);
                return;
            }
            
            renderStep2();
        };

        function isArrayContinuous(arr) {
            if (arr.length <= 1) return true;
            const originalIndices = arr.map(i => grids[i].originalIndex).sort((a, b) => a - b);
            for (let i = 1; i < originalIndices.length; i++) {
                if (originalIndices[i] !== originalIndices[i-1] + 1) {
                    return false;
                }
            }
            return true;
        }

        window.markSelectedGrids = function() {
            if (selectedGrids.size === 0) {
                alert('Ë´ãÂÖàÈÅ∏ÊìáÊ†ºÂ≠ê');
                return;
            }
            
            const selectedArray = Array.from(selectedGrids).sort((a, b) => a - b);
            
            if (currentType === 'fill') {
                if (!isArrayContinuous(selectedArray)) {
                    const gridNumbers = selectedArray.map(i => grids[i].number).join(', ');
                    alert(`ÈÅ∏Â°´È°åÁöÑÊ†ºÂ≠êÂøÖÈ†àÈÄ£Á∫åÔºÅÊÇ®ÈÅ∏‰∫ÜÔºöÊ†º ${gridNumbers}`);
                    return;
                }
                
                const groupId = Date.now();
                selectedArray.forEach(index => {
                    grids[index].type = currentType;
                    grids[index].groupId = groupId;
                });
            } else {
                selectedArray.forEach(index => {
                    grids[index].type = currentType;
                    grids[index].groupId = null;
                });
            }
            
            selectedGrids = new Set();
            renderStep2();
        };

        window.clearSelection = function() {
            selectedGrids = new Set();
            renderStep2();
        };

        window.resetAllGrids = function() {
            if (confirm('Á¢∫ÂÆöË¶ÅÈáçË®≠ÊâÄÊúâÊ†ºÂ≠êÁöÑË®≠ÂÆöÂóéÔºü')) {
                initializeGrids();
            }
        };

        window.setCurrentType = function(type) {
            currentType = type;
            renderStep2();
        };

        function getQuestionsList() {
            const questions = [];
            const processed = new Set();
            
            grids.forEach((grid, index) => {
                if (!grid.type || processed.has(index)) return;
                
                if (grid.type === 'fill' && grid.groupId !== null) {
                    const groupGrids = grids
                        .map((g, i) => g.groupId === grid.groupId ? i : -1)
                        .filter(i => i !== -1);
                    
                    questions.push({
                        type: grid.type,
                        typeName: getTypeName(grid.type),
                        grids: groupGrids,
                        originalIndices: groupGrids.map(i => grids[i].originalIndex)
                    });
                    
                    groupGrids.forEach(i => processed.add(i));
                } else {
                    questions.push({
                        type: grid.type,
                        typeName: getTypeName(grid.type),
                        grids: [index],
                        originalIndices: [grids[index].originalIndex]
                    });
                    processed.add(index);
                }
            });
            
            return questions;
        }

        function getTypeName(type) {
            const names = {
                'single': 'ÂñÆÈÅ∏',
                'multiple': 'Â§öÈÅ∏',
                'fill': 'ÈÅ∏Â°´',
                'mixed': 'Ê∑∑Âêà'
            };
            return names[type] || '';
        }

        function getGridColumns() {
            const count = grids.length;
            if (count <= 10) return 10;
            if (count <= 20) return 10;
            if (count <= 30) return 15;
            if (count <= 40) return 20;
            return 25;
        }

        function decodeAnswer(code) {
            if (!code || code === '=') return '';
            if (code === '?') return '?';
            if (code === '.') return '.';
            
            if (code >= '0' && code <= '9') return code;
            if (code === '-' || code === '+') return code;
            if (code >= 'A' && code <= 'E') return code;
            
            if (multipleChoiceMap[code] !== undefined) {
                return multipleChoiceMap[code];
            }
            
            return code;
        }

        function scoreAnswer(studentCode, correctCode, questionType) {
            const studentAns = decodeAnswer(studentCode);
            const correctAns = decodeAnswer(correctCode);
            
            if (!studentAns || studentAns === '?' || studentAns === '.') return 0;
            if (!correctAns || correctAns === '') return 0;
            
            if (questionType === 'multiple' || correctAns.length > 1) {
                const studentSet = new Set(studentAns.split(''));
                const correctSet = new Set(correctAns.split(''));
                
                if (studentSet.size !== correctSet.size) return 0;
                for (let choice of studentSet) {
                    if (!correctSet.has(choice)) return 0;
                }
                return 1;
            }
            
            return studentAns === correctAns ? 1 : 0;
        }

        window.generateScoringMatrix = function() {
            const questions = getQuestionsList();
            
            if (questions.length === 0) {
                alert('Ë´ãÂÖàË®≠ÂÆöÈ°åÁõÆÔºÅ');
                return;
            }

            const matrix = csvData.map((student) => {
                const studentAnswer = student['Â≠∏ÁîüÁ≠îÊ°à'] || '';
                
                return questions.map((q) => {
                    if (q.type === 'fill') {
                        let allCorrect = true;
                        for (const originalIdx of q.originalIndices) {
                            const studentCode = studentAnswer[originalIdx] || '';
                            const correctCode = standardAnswer[originalIdx] || '';
                            
                            const studentAns = decodeAnswer(studentCode);
                            const correctAns = decodeAnswer(correctCode);
                            
                            if (!studentAns || !correctAns || studentAns !== correctAns) {
                                allCorrect = false;
                                break;
                            }
                        }
                        return allCorrect ? 1 : 0;
                    } else {
                        const originalIdx = q.originalIndices[0];
                        const studentCode = studentAnswer[originalIdx] || '';
                        const correctCode = standardAnswer[originalIdx] || '';
                        return scoreAnswer(studentCode, correctCode, q.type);
                    }
                });
            });

            const studentTotals = matrix.map(row => row.reduce((a, b) => a + b, 0));
            const questionTotals = questions.map((_, qIdx) => 
                matrix.reduce((sum, row) => sum + row[qIdx], 0)
            );

            scoringMatrix = {
                matrix,
                students: csvData,
                questions,
                studentTotals,
                questionTotals
            };
            
            currentStep = 3;
            updateStepIndicator();
            renderStep3ScoringMatrix();
        };

        function renderStep3ScoringMatrix() {
            const content = document.getElementById('mainContent');
            
            let html = `
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-3xl font-bold mb-6 text-green-600 flex items-center gap-3">
                        ‚úì Ë©ïÂàÜÁµêÊûúÊ™¢Êü•Ôºà0Ëàá1Ë°®Ôºâ
                    </h2>
                    
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="font-semibold">Â≠∏Áîü‰∫∫Êï∏Ôºö</span>
                                <span class="text-blue-600 font-bold ml-2">${csvData.length}</span>
                            </div>
                            <div>
                                <span class="font-semibold">È°åÁõÆÊï∏ÈáèÔºö</span>
                                <span class="text-blue-600 font-bold ml-2">${scoringMatrix.questions.length}</span>
                            </div>
                            <div>
                                <span class="font-semibold">Á∏ΩÂàÜÔºö</span>
                                <span class="text-blue-600 font-bold ml-2">${scoringMatrix.questions.length}</span>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="score-table w-full">
                            <thead>
                                <tr>
                                    <th class="sticky-col-class" style="min-width: 100px;">Áè≠Á¥ö</th>
                                    <th class="sticky-col-name" style="min-width: 100px;">ÂßìÂêç</th>
                                    ${scoringMatrix.questions.map((q, idx) => {
                                        const qNum = idx + 1;
                                        return `<th style="min-width: 60px;">
                                            Q${qNum}<br>
                                            <span style="font-size: 0.75em;">(${q.typeName})</span>
                                        </th>`;
                                    }).join('')}
                                    <th style="min-width: 70px; background: #ca8a04 !important;">Á∏ΩÂàÜ</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            scoringMatrix.matrix.forEach((row, idx) => {
                const student = scoringMatrix.students[idx];
                const total = scoringMatrix.studentTotals[idx];
                const className = student['Áè≠Á¥ö'] || '';
                const studentName = student['ÂßìÂêç'] || '';
                
                html += `<tr>
                    <td class="sticky-col-class" style="padding: 8px; text-align: left;">${className}</td>
                    <td class="sticky-col-name" style="padding: 8px; text-align: left;">${studentName}</td>`;
                
                row.forEach(score => {
                    html += `<td class="${score === 1 ? 'correct' : 'incorrect'}" style="padding: 8px;">${score}</td>`;
                });
                
                html += `<td style="padding: 8px; background: #fef3c7 !important; font-weight: 700; text-align: center;">${total}</td>
                </tr>`;
            });
            
            html += `
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2" style="text-align: center; font-weight: 700;">Á≠îÂ∞ç‰∫∫Êï∏</td>
                                    ${scoringMatrix.questionTotals.map(total => 
                                        `<td style="text-align: center;">${total}</td>`
                                    ).join('')}
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button onclick="currentStep=2; updateStepIndicator(); renderStep2();" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600">
                            ‚Üê ËøîÂõû‰∏ä‰∏ÄÊ≠•
                        </button>
                        <button onclick="downloadScoringMatrix()" class="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600">
                            üì• ‰∏ãËºâË©ïÂàÜË°®
                        </button>
                        <button onclick="proceedToRaschAnalysis()" class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-xl text-xl font-bold hover:shadow-2xl transition-all transform hover:scale-105">
                            ‰∏ã‰∏ÄÊ≠•ÔºöÈñãÂßãÂ∞àÊ•≠ÂàÜÊûê ‚Üí
                        </button>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }

        window.downloadScoringMatrix = function() {
            if (!scoringMatrix) return;
            
            let csv = 'Áè≠Á¥ö,ÂßìÂêç';
            scoringMatrix.questions.forEach((q, idx) => {
                csv += `,Q${idx + 1}(${q.typeName})`;
            });
            csv += ',Á∏ΩÂàÜ\n';
            
            scoringMatrix.matrix.forEach((row, idx) => {
                const student = scoringMatrix.students[idx];
                const className = student['Áè≠Á¥ö'] || '';
                const studentName = student['ÂßìÂêç'] || '';
                csv += `${className},${studentName}`;
                row.forEach(score => {
                    csv += `,${score}`;
                });
                csv += `,${scoringMatrix.studentTotals[idx]}\n`;
            });
            
            csv += 'Á≠îÂ∞ç‰∫∫Êï∏,';
            scoringMatrix.questionTotals.forEach(total => {
                csv += `,${total}`;
            });
            csv += '\n';
            
            downloadCSV(csv, 'scoring_matrix.csv');
        };

        window.proceedToRaschAnalysis = function() {
            currentStep = 4;
            updateStepIndicator();
            performRaschAnalysis();
        };

        async function performRaschAnalysis() {
            if (!isWebRReady) {
                alert('WebR Â∞öÊú™Ê∫ñÂÇôÂ∞±Á∑íÔºåË´ãÁ®çÂÄôÂÜçË©¶');
                return;
            }

            if (!scoringMatrix) {
                alert('Ê≤íÊúâË≥áÊñôÂèØÂàÜÊûê');
                return;
            }

            try {
                renderStep4Loading();

                let csvText = 'CLASS,StudentID,StudentName';
                for (let i = 0; i < scoringMatrix.questions.length; i++) {
                    csvText += ',Q' + (i + 1);
                }
                csvText += '\n';

                scoringMatrix.matrix.forEach((row, idx) => {
                    const student = scoringMatrix.students[idx];
                    const className = student['Áè≠Á¥ö'] || '';
                    const studentId = student['Â≠∏Ëôü'] || '';
                    const studentName = student['ÂßìÂêç'] || '';
                    csvText += className + ',' + studentId + ',' + studentName;
                    row.forEach(score => {
                        csvText += ',' + score;
                    });
                    csvText += '\n';
                });

                await webR.objs.globalEnv.bind('csv_text', csvText);

                await webR.evalR(`
                    data_text <- csv_text
                    con <- textConnection(data_text)
                    fulldata <- read.csv(con, header = TRUE)
                    close(con)
                    
                    class_info <- fulldata$CLASS
                    student_ids <- fulldata$StudentID
                    student_names <- fulldata$StudentName
                    
                    respdata <- fulldata[, -(1:3)]
                    respdata[] <- lapply(respdata, as.numeric)
                    
                    row_sums <- rowSums(respdata, na.rm = TRUE)
                    valid_indices <- which(row_sums > 0)
                    
                    respdata_clean <- respdata[valid_indices, ]
                    class_info_clean <- class_info[valid_indices]
                    student_ids_clean <- student_ids[valid_indices]
                    student_names_clean <- student_names[valid_indices]
                    
                    mod <- TAM::tam.mml(respdata_clean, verbose = FALSE)
                    fit <- TAM::tam.fit(mod)
                    person_params <- TAM::tam.wle(mod)
                    reliability <- mod$EAP.rel
                    
                    total_scores <- rowSums(respdata_clean)
                    item_discrimination <- sapply(1:ncol(respdata_clean), function(i) {
                        cor(respdata_clean[,i], total_scores, use = "complete.obs")
                    })
                    
                    png(filename = "/tmp/wrightmap.png", width = 1200, height = 800, res = 120)
                    WrightMap::wrightMap(
                        person_params$theta, 
                        mod$xsi$xsi,
                        label.items = paste0("Q", 1:ncol(respdata_clean)),
                        main.title = "Wright Map - Person Ability vs Item Difficulty",
                        axis.persons = "Person Ability (Œ∏)",
                        axis.items = "Item Difficulty (Œ≤)"
                    )
                    dev.off()
                    
                    png(filename = "/tmp/ability_dist.png", width = 800, height = 600, res = 100)
                    hist(person_params$theta, breaks = 20, col = "lightblue", border = "white",
                         main = "Student Ability Distribution", xlab = "Ability (Œ∏)", ylab = "Frequency")
                    dev.off()
                    
                    png(filename = "/tmp/difficulty_dist.png", width = 800, height = 600, res = 100)
                    hist(mod$xsi$xsi, breaks = 10, col = "lightcoral", border = "white",
                         main = "Item Difficulty Distribution", xlab = "Difficulty (Œ≤)", ylab = "Frequency")
                    dev.off()
                `);

                const nItems = (await (await webR.evalR('ncol(respdata_clean)')).toJs()).values[0];
                const nPersons = (await (await webR.evalR('nrow(respdata_clean)')).toJs()).values[0];
                
                const itemDifficulty = (await (await webR.evalR('as.numeric(mod$xsi$xsi)')).toJs()).values;
                const itemSE = (await (await webR.evalR('as.numeric(mod$xsi$se.xsi)')).toJs()).values;
                const personAbility = (await (await webR.evalR('as.numeric(person_params$theta)')).toJs()).values;
                const personSE = (await (await webR.evalR('as.numeric(person_params$error)')).toJs()).values;
                const personScores = (await (await webR.evalR('rowSums(respdata_clean)')).toJs()).values;
                
                const classInfo = (await (await webR.evalR('as.character(class_info_clean)')).toJs()).values;
                const studentIds = (await (await webR.evalR('as.character(student_ids_clean)')).toJs()).values;
                const studentNames = (await (await webR.evalR('as.character(student_names_clean)')).toJs()).values;

                const itemInfit = (await (await webR.evalR('as.numeric(fit$itemfit$Infit)')).toJs()).values;
                const itemOutfit = (await (await webR.evalR('as.numeric(fit$itemfit$Outfit)')).toJs()).values;
                const itemInfitT = (await (await webR.evalR('as.numeric(fit$itemfit$Infit_t)')).toJs()).values;
                const itemOutfitT = (await (await webR.evalR('as.numeric(fit$itemfit$Outfit_t)')).toJs()).values;
                
                const itemDiscrimination = (await (await webR.evalR('as.numeric(item_discrimination)')).toJs()).values;
                const reliability = (await (await webR.evalR('as.numeric(reliability)')).toJs()).values[0];

                const responseMatrix = [];
                for (let i = 0; i < nPersons; i++) {
                    const row = (await (await webR.evalR(`as.numeric(respdata_clean[${i+1},])`)).toJs()).values;
                    responseMatrix.push(row);
                }

                const wrightmapFile = await webR.FS.readFile('/tmp/wrightmap.png');
                const wrightmapBlob = new Blob([wrightmapFile], { type: 'image/png' });
                const wrightmapUrl = URL.createObjectURL(wrightmapBlob);

                const abilityDistFile = await webR.FS.readFile('/tmp/ability_dist.png');
                const abilityDistBlob = new Blob([abilityDistFile], { type: 'image/png' });
                const abilityDistUrl = URL.createObjectURL(abilityDistBlob);

                const difficultyDistFile = await webR.FS.readFile('/tmp/difficulty_dist.png');
                const difficultyDistBlob = new Blob([difficultyDistFile], { type: 'image/png' });
                const difficultyDistUrl = URL.createObjectURL(difficultyDistBlob);

                analysisData = {
                    nItems, nPersons, itemDifficulty, itemSE, itemInfit, itemOutfit, 
                    itemInfitT, itemOutfitT, itemDiscrimination, personAbility, personSE, 
                    personScores, classInfo, studentIds, studentNames, responseMatrix, reliability,
                    wrightmapUrl, abilityDistUrl, difficultyDistUrl
                };

                calculateFourCategories(analysisData);
                calculateDistractorAnalysis(analysisData);
                calculateClassStatistics(analysisData);
                renderStep4Results(analysisData);

            } catch (error) {
                alert('ÂàÜÊûêÈÅéÁ®ãÁôºÁîüÈåØË™§Ôºö' + error.message);
                console.error('Analysis error:', error);
            }
        }

        function calculateFourCategories(data) {
            const individualStats = [];
            
            for (let i = 0; i < data.nPersons; i++) {
                const ability = data.personAbility[i];
                const responses = data.responseMatrix[i];
                
                let reasonableCorrect = [], reasonableWrong = [], advantage = [], misconception = [];
                
                for (let j = 0; j < data.nItems; j++) {
                    const difficulty = data.itemDifficulty[j];
                    const response = responses[j];
                    
                    if (ability > difficulty) {
                        if (response === 1) reasonableCorrect.push(j + 1);
                        else misconception.push(j + 1);
                    } else {
                        if (response === 0) reasonableWrong.push(j + 1);
                        else advantage.push(j + 1);
                    }
                }
                
                individualStats.push({
                    index: i, 
                    class: data.classInfo[i], 
                    studentId: data.studentIds[i],
                    studentName: data.studentNames[i],
                    ability, 
                    score: data.personScores[i],
                    reasonableCorrectCount: reasonableCorrect.length, 
                    reasonableCorrectItems: reasonableCorrect,
                    reasonableWrongCount: reasonableWrong.length, 
                    reasonableWrongItems: reasonableWrong,
                    advantageCount: advantage.length, 
                    advantageItems: advantage,
                    misconceptionCount: misconception.length, 
                    misconceptionItems: misconception
                });
            }
            
            data.individualStats = individualStats;
        }

        function calculateClassStatistics(data) {
            const classes = [...new Set(data.classInfo)];
            const classStats = {};
            const classMisconceptionItems = {};
            const classReasonableWrongItems = {};
            
            classes.forEach(cls => {
                const classStudents = data.individualStats.filter(s => s.class === cls);
                
                classStats[cls] = {
                    count: classStudents.length,
                    avgReasonableCorrect: classStudents.reduce((sum, s) => sum + s.reasonableCorrectCount, 0) / classStudents.length,
                    avgReasonableWrong: classStudents.reduce((sum, s) => sum + s.reasonableWrongCount, 0) / classStudents.length,
                    avgAdvantage: classStudents.reduce((sum, s) => sum + s.advantageCount, 0) / classStudents.length,
                    avgMisconception: classStudents.reduce((sum, s) => sum + s.misconceptionCount, 0) / classStudents.length,
                    totalReasonableCorrect: classStudents.reduce((sum, s) => sum + s.reasonableCorrectCount, 0),
                    totalReasonableWrong: classStudents.reduce((sum, s) => sum + s.reasonableWrongCount, 0),
                    totalAdvantage: classStudents.reduce((sum, s) => sum + s.advantageCount, 0),
                    totalMisconception: classStudents.reduce((sum, s) => sum + s.misconceptionCount, 0)
                };
                
                const itemMisconceptionCount = {};
                classStudents.forEach(student => {
                    student.misconceptionItems.forEach(itemNum => {
                        itemMisconceptionCount[itemNum] = (itemMisconceptionCount[itemNum] || 0) + 1;
                    });
                });
                
                classMisconceptionItems[cls] = Object.entries(itemMisconceptionCount)
                    .map(([itemNum, count]) => ({
                        itemNum: parseInt(itemNum), 
                        count,
                        percentage: (count / classStudents.length * 100).toFixed(1)
                    }))
                    .sort((a, b) => b.count - a.count);
                
                const itemReasonableWrongCount = {};
                classStudents.forEach(student => {
                    student.reasonableWrongItems.forEach(itemNum => {
                        itemReasonableWrongCount[itemNum] = (itemReasonableWrongCount[itemNum] || 0) + 1;
                    });
                });
                
                classReasonableWrongItems[cls] = Object.entries(itemReasonableWrongCount)
                    .map(([itemNum, count]) => ({
                        itemNum: parseInt(itemNum), 
                        count,
                        percentage: (count / classStudents.length * 100).toFixed(1)
                    }))
                    .sort((a, b) => b.count - a.count);
            });
            
            data.classStats = classStats;
            data.classMisconceptionItems = classMisconceptionItems;
            data.classReasonableWrongItems = classReasonableWrongItems;
        }

        function calculateDistractorAnalysis(data) {
            const questions = scoringMatrix.questions;
            const distractorStats = [];
            
            for (let qIdx = 0; qIdx < questions.length; qIdx++) {
                const question = questions[qIdx];
                const originalIdx = question.originalIndices[0];
                const correctAnswer = decodeAnswer(standardAnswer[originalIdx]);
                const optionStats = {};
                
                csvData.forEach((student) => {
                    const validIdx = data.studentIds.indexOf(student['Â≠∏Ëôü'] || '');
                    if (validIdx === -1) return;
                    
                    const studentAnswer = student['Â≠∏ÁîüÁ≠îÊ°à'] || '';
                    const studentChoice = decodeAnswer(studentAnswer[originalIdx]);
                    
                    if (!studentChoice || studentChoice === '?' || studentChoice === '.') return;
                    
                    if (!optionStats[studentChoice]) {
                        optionStats[studentChoice] = { count: 0, abilitySum: 0, abilities: [] };
                    }
                    
                    optionStats[studentChoice].count++;
                    optionStats[studentChoice].abilitySum += data.personAbility[validIdx];
                    optionStats[studentChoice].abilities.push(data.personAbility[validIdx]);
                });
                
                Object.keys(optionStats).forEach(option => {
                    const stat = optionStats[option];
                    stat.avgAbility = stat.abilitySum / stat.count;
                    stat.percentage = (stat.count / data.nPersons * 100).toFixed(1);
                });
                
                distractorStats.push({
                    questionIndex: qIdx + 1, correctAnswer, options: optionStats, totalResponses: data.nPersons
                });
            }
            
            data.distractorStats = distractorStats;
        }

        function updateStepIndicator() {
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`stepIndicator${i}`);
                const circle = indicator.querySelector('div:first-child');
                
                if (i < currentStep) {
                    circle.className = 'w-12 h-12 mx-auto rounded-full bg-green-500 text-white flex items-center justify-center font-bold mb-2';
                } else if (i === currentStep) {
                    circle.className = 'w-12 h-12 mx-auto rounded-full bg-blue-500 text-white flex items-center justify-center font-bold mb-2';
                } else {
                    circle.className = 'w-12 h-12 mx-auto rounded-full bg-gray-300 text-white flex items-center justify-center font-bold mb-2';
                }
            }
        }

        function renderStep1() {
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-3xl font-bold mb-6 text-blue-600 flex items-center gap-3">üì§ Ê≠•È©ü 1Ôºö‰∏äÂÇ≥ CSV Ê™îÊ°à</h2>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold mb-2 text-gray-700">ÈÅ∏ÊìáÊ™îÊ°àÁ∑®Á¢ºÔºö</label>
                        <div class="flex gap-4">
                            <button onclick="setEncodingBIG5()" class="${selectedEncoding === 'BIG5' ? 'bg-blue-500 text-white shadow-lg scale-105' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} px-6 py-3 rounded-lg font-semibold transition-all">BIG5</button>
                            <button onclick="setEncodingUTF8()" class="${selectedEncoding === 'UTF-8' ? 'bg-blue-500 text-white shadow-lg scale-105' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} px-6 py-3 rounded-lg font-semibold transition-all">UTF-8</button>
                        </div>
                    </div>
                    <div class="border-4 border-dashed border-blue-300 rounded-xl p-12 text-center bg-blue-50 hover:bg-blue-100 transition-all">
                        <input type="file" id="fileInput" accept=".csv" class="hidden" onchange="handleFile(this.files[0])">
                        <button onclick="document.getElementById('fileInput').click()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-4 rounded-xl text-lg font-bold hover:shadow-2xl transition-all transform hover:scale-105">üìÅ ÈÅ∏Êìá CSV Ê™îÊ°à</button>
                        ${fileName ? `<div class="mt-4 text-green-600 font-semibold">‚úì Â∑≤ÈÅ∏ÊìáÔºö${fileName}</div>` : ''}
                    </div>
                    ${csvData.length > 0 ? `
                        <div class="mt-8 p-6 bg-green-50 rounded-xl border-2 border-green-200">
                            <h3 class="text-xl font-bold text-green-700 mb-4">‚úì Ê™îÊ°àËºâÂÖ•ÊàêÂäüÔºÅ</h3>
                            <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                                <div><span class="font-semibold">Â≠∏Áîü‰∫∫Êï∏Ôºö</span><span class="text-blue-600 font-bold text-lg ml-2">${csvData.length}</span></div>
                                <div><span class="font-semibold">Á≠îÊ°àÊ†ºÊï∏Ôºö</span><span class="text-blue-600 font-bold text-lg ml-2">${totalGrids}</span></div>
                            </div>
                            ${standardAnswer ? `
                                <div class="p-4 bg-white rounded-lg mb-4">
                                    <div class="font-semibold text-green-700 mb-2">‚úì Â∑≤Ëá™ÂãïÂÅµÊ∏¨Ê®ôÊ∫ñÁ≠îÊ°àÔºö</div>
                                    <div class="font-mono text-lg bg-gray-100 p-3 rounded">${standardAnswer}</div>
                                    <div class="text-sm text-gray-600 mt-2">‰æÜÊ∫êÔºö${standardAnswerSource}</div>
                                </div>
                                <button onclick="initializeGrids()" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-4 rounded-xl text-xl font-bold hover:shadow-2xl transition-all transform hover:scale-105">‰∏ã‰∏ÄÊ≠•ÔºöË®≠ÂÆöÈ°åÂûã ‚Üí</button>
                            ` : `
                                <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <div class="font-semibold text-yellow-800 mb-3">‚ö†Ô∏è Êú™ÂÅµÊ∏¨Âà∞Ê®ôÊ∫ñÁ≠îÊ°àÔºåË´ãÊâãÂãïËº∏ÂÖ•Ôºö</div>
                                    <input type="text" id="manualAnswer" placeholder="Ë´ãËº∏ÂÖ• ${totalGrids} ÂÄãÂ≠óÂÖÉÁöÑÊ®ôÊ∫ñÁ≠îÊ°à" class="w-full p-3 border-2 border-yellow-300 rounded-lg font-mono text-lg mb-3">
                                    <button onclick="setManualAnswer()" class="bg-yellow-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-yellow-600">Á¢∫Ë™çÊ®ôÊ∫ñÁ≠îÊ°à</button>
                                </div>
                            `}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderStep2() {
            const content = document.getElementById('mainContent');
            const questions = getQuestionsList();
            const gridCols = getGridColumns();
            
            content.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-3xl font-bold mb-6 text-purple-600 flex items-center gap-3">üìù Ê≠•È©ü 2ÔºöË®≠ÂÆöÈ°åÁõÆÈ°ûÂûã</h2>
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-semibold">Á∏ΩÊ†ºÊï∏Ôºö</span><span class="text-blue-600 font-bold ml-2">${grids.length}</span></div>
                            <div><span class="font-semibold">Â∑≤Ë®≠ÂÆöÔºö</span><span class="text-green-600 font-bold ml-2">${grids.filter(g => g.type).length}</span></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-6 mb-6">
                        <div class="p-6 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl">
                            <h3 class="font-bold text-lg mb-4 text-purple-700">ÈÅ∏ÊìáÈ°åÂûãÔºö</h3>
                            <div class="space-y-2">
                                <button onclick="setCurrentType('single')" class="${currentType === 'single' ? 'bg-blue-500 text-white shadow-lg scale-105' : 'bg-white text-gray-700 hover:bg-gray-100'} w-full p-3 rounded-lg font-semibold transition-all">ÂñÆÈÅ∏È°å</button>
                                <button onclick="setCurrentType('multiple')" class="${currentType === 'multiple' ? 'bg-green-500 text-white shadow-lg scale-105' : 'bg-white text-gray-700 hover:bg-gray-100'} w-full p-3 rounded-lg font-semibold transition-all">Â§öÈÅ∏È°å</button>
                                <button onclick="setCurrentType('fill')" class="${currentType === 'fill' ? 'bg-orange-500 text-white shadow-lg scale-105' : 'bg-white text-gray-700 hover:bg-gray-100'} w-full p-3 rounded-lg font-semibold transition-all">ÈÅ∏Â°´È°å</button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-6 p-6 bg-gray-50 rounded-xl">
                        <h3 class="font-bold text-lg mb-4">ÈÅ∏ÊìáÊ†ºÂ≠êÔºö</h3>
                        <div class="flex gap-4 mb-4">
                            <button onclick="selectionMode='click'; renderStep2();" class="${selectionMode === 'click' ? 'bg-blue-500 text-white' : 'bg-gray-200'} px-6 py-2 rounded-lg font-semibold">ÈªûÈÅ∏Ê®°Âºè</button>
                            <button onclick="selectionMode='range'; renderStep2();" class="${selectionMode === 'range' ? 'bg-blue-500 text-white' : 'bg-gray-200'} px-6 py-2 rounded-lg font-semibold">ÁØÑÂúçÊ®°Âºè</button>
                        </div>
                        ${selectionMode === 'range' ? `
                            <div class="flex gap-4 mb-4">
                                <input type="number" id="rangeStartInput" placeholder="Ëµ∑ÂßãÊ†ºËôü" value="${rangeStart}" onchange="rangeStart=this.value" class="p-2 border-2 rounded w-32">
                                <span class="self-center">Âà∞</span>
                                <input type="number" id="rangeEndInput" placeholder="ÁµêÊùüÊ†ºËôü" value="${rangeEnd}" onchange="rangeEnd=this.value" class="p-2 border-2 rounded w-32">
                                <button onclick="selectGridsByRange()" class="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold">ÈÅ∏ÊìáÁØÑÂúç</button>
                            </div>
                        ` : ''}
                        <div class="grid gap-2 mb-4" style="grid-template-columns: repeat(${gridCols}, minmax(0, 1fr))">
                            ${grids.map((grid, index) => `
                                <button onclick="toggleGridSelection(${index})" class="${
                                    selectedGrids.has(index) ? 'bg-yellow-400 text-black scale-110 shadow-lg' :
                                    grid.type === 'single' ? 'bg-blue-200 text-blue-800' :
                                    grid.type === 'multiple' ? 'bg-green-200 text-green-800' :
                                    grid.type === 'fill' ? 'bg-orange-200 text-orange-800' :
                                    'bg-gray-100 hover:bg-gray-200'
                                } p-2 rounded-lg text-sm font-semibold transition-all">
                                    <div class="text-xs">${grid.number}</div>
                                    <div class="font-mono">${grid.answer}</div>
                                </button>
                            `).join('')}
                        </div>
                        <div class="flex gap-4">
                            <button onclick="markSelectedGrids()" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600">‚úì Ê®ôË®òÈÅ∏‰∏≠ÁöÑÊ†ºÂ≠ê</button>
                            <button onclick="clearSelection()" class="px-6 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400">Ê∏ÖÈô§ÈÅ∏Êìá</button>
                            <button onclick="resetAllGrids()" class="px-6 bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600">ÈáçË®≠ÂÖ®ÈÉ®</button>
                        </div>
                    </div>
                    ${questions.length > 0 ? `
                        <div class="mb-6 p-6 bg-green-50 rounded-xl">
                            <h3 class="font-bold text-lg mb-4 text-green-700">È°åÁõÆÁ∏ΩË¶ΩÔºö</h3>
                            <div class="space-y-2">
                                ${questions.map((q, idx) => `
                                    <div class="p-3 bg-white rounded-lg flex justify-between items-center">
                                        <div>
                                            <span class="font-semibold">Á¨¨ ${idx + 1} È°åÔºö</span>
                                            <span class="ml-2 px-2 py-1 rounded text-sm ${
                                                q.type === 'single' ? 'bg-blue-100 text-blue-700' :
                                                q.type === 'multiple' ? 'bg-green-100 text-green-700' :
                                                'bg-orange-100 text-orange-700'
                                            }">${q.typeName}</span>
                                            <span class="ml-2 text-gray-600">Ê†º ${q.originalIndices.map(i => i + 1).join('+')}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <button onclick="generateScoringMatrix()" class="mt-6 w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-xl text-xl font-bold hover:shadow-2xl transition-all transform hover:scale-105">‰∏ã‰∏ÄÊ≠•ÔºöÁîüÊàêË©ïÂàÜË°® ‚Üí</button>
                        </div>
                    ` : ''}
                    <button onclick="currentStep=1; updateStepIndicator(); renderStep1();" class="mt-4 bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600">‚Üê ËøîÂõû‰∏ä‰∏ÄÊ≠•</button>
                </div>
            `;
        }

        function renderStep4Loading() {
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mx-auto mb-4"></div>
                    <h2 class="text-2xl font-bold text-gray-700 mb-2">Ê≠£Âú®Âü∑Ë°åÂ∞àÊ•≠ÂàÜÊûê...</h2>
                    <p class="text-gray-500">Rasch Ê®°Âûã‰º∞Ë®à | ÈÅ©ÈÖçÂ∫¶Ê™¢ÂÆö | ÈëëÂà•Â∫¶Ë®àÁÆó | Ë™òÁ≠îÂàÜÊûê | ÂõõÂêëÂ∫¶Ë®∫Êñ∑</p>
                </div>
            `;
        }

        function renderStep4Results(data) {
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-3xl font-bold mb-6 text-green-600">‚úÖ Â∞àÊ•≠Ë©¶È°åÂàÜÊûêÂÆåÊàêÔºÅ</h2>
                    <div class="tab-container">
                        <button class="tab active" onclick="switchTab(event, 'summary')">üìä Á∏ΩË¶Ω</button>
                        <button class="tab" onclick="switchTab(event, 'wrightmap')">üó∫Ô∏è Wright Map</button>
                        <button class="tab" onclick="switchTab(event, 'itemfit')">üî¨ È°åÁõÆÈÅ©ÈÖçÂ∫¶</button>
                        <button class="tab" onclick="switchTab(event, 'discrimination')">üìà È°åÁõÆÈëëÂà•Â∫¶</button>
                        <button class="tab" onclick="switchTab(event, 'bubble')">ü´ß Ê∞£Ê≥°ÂúñÂàÜÊûê</button>
                        <button class="tab" onclick="switchTab(event, 'distractor')">üéØ Ë™òÁ≠îÂàÜÊûê</button>
                        <button class="tab" onclick="switchTab(event, 'individual')">üë• ÂÄã‰∫∫ÂõõÂêëÂ∫¶</button>
                        <button class="tab" onclick="switchTab(event, 'class')">üìö Áè≠Á¥öÁµ±Ë®à</button>
                    </div>
                    <div id="tab-summary" class="tab-content active">${createSummaryView(data)}</div>
                    <div id="tab-wrightmap" class="tab-content">${createWrightMapView(data)}</div>
                    <div id="tab-itemfit" class="tab-content">${createItemFitView(data)}</div>
                    <div id="tab-discrimination" class="tab-content">${createDiscriminationView(data)}</div>
                    <div id="tab-bubble" class="tab-content">${createBubbleChartView(data)}</div>
                    <div id="tab-distractor" class="tab-content">${createDistractorView(data)}</div>
                    <div id="tab-individual" class="tab-content">${createIndividualTable(data)}</div>
                    <div id="tab-class" class="tab-content">${createClassStats(data)}</div>
                    <button onclick="location.reload()" class="mt-6 bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-600">üîÑ ÈáçÊñ∞ÈñãÂßã</button>
                </div>
            `;
            setupFilters();
        }

        function createSummaryView(data) {
            return `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-6 text-gray-800">üìä ÂàÜÊûêÁ∏ΩË¶ΩËàá‰ø°Â∫¶Áµ±Ë®à</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg"><div class="text-sm text-blue-600 font-semibold">ÂèóÊ∏¨‰∫∫Êï∏</div><div class="text-3xl font-bold text-blue-800">${data.nPersons}</div></div>
                    <div class="bg-green-100 p-4 rounded-lg"><div class="text-sm text-green-600 font-semibold">È°åÁõÆÊï∏Èáè</div><div class="text-3xl font-bold text-green-800">${data.nItems}</div></div>
                    <div class="bg-purple-100 p-4 rounded-lg"><div class="text-sm text-purple-600 font-semibold">Âπ≥ÂùáËÉΩÂäõÂÄº</div><div class="text-3xl font-bold text-purple-800">${(data.personAbility.reduce((a,b)=>a+b,0)/data.nPersons).toFixed(3)}</div></div>
                    <div class="bg-orange-100 p-4 rounded-lg"><div class="text-sm text-orange-600 font-semibold">EAP ‰ø°Â∫¶</div><div class="text-3xl font-bold text-orange-800">${data.reliability.toFixed(3)}</div></div>
                </div>
                <div class="info-box mb-6">
                    <h4 class="font-bold mb-2">üìå ‰ø°Â∫¶Âà§Êñ∑Ê®ôÊ∫ñÔºö</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Œ± ‚â• 0.9</strong>ÔºöÂÑ™ÁßÄÔºàExcellentÔºâ</li>
                        <li><strong>0.8 ‚â§ Œ± < 0.9</strong>ÔºöËâØÂ•ΩÔºàGoodÔºâ</li>
                        <li><strong>0.7 ‚â§ Œ± < 0.8</strong>ÔºöÂ∞öÂèØÔºàAcceptableÔºâ</li>
                        <li><strong>0.6 ‚â§ Œ± < 0.7</strong>ÔºöÂèØÁñëÔºàQuestionableÔºâ</li>
                        <li><strong>Œ± < 0.6</strong>Ôºö‰∏ç‰Ω≥ÔºàPoorÔºâÔºåÂª∫Ë≠∞Â¢ûÂä†È°åÊï∏ÊàñÊîπÂñÑÈ°åÁõÆ</li>
                    </ul>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg"><h4 class="font-bold mb-2 text-center">Â≠∏ÁîüËÉΩÂäõÂàÜÂ∏É</h4><img src="${data.abilityDistUrl}" class="w-full"></div>
                    <div class="bg-white p-4 rounded-lg"><h4 class="font-bold mb-2 text-center">È°åÁõÆÈõ£Â∫¶ÂàÜÂ∏É</h4><img src="${data.difficultyDistUrl}" class="w-full"></div>
                </div>

                <div class="download-section mt-6">
                    <h4 class="text-xl font-bold mb-4 text-blue-800">üñ®Ô∏è ÂÆåÊï¥Â†±Âëä‰∏ãËºâ</h4>
                    <p class="text-gray-600 mb-4">Â∞á„ÄåÁ∏ΩË¶Ω„ÄçËá≥„ÄåÁè≠Á¥öÁµ±Ë®à„ÄçÁöÑÊâÄÊúâÂàÜÊûêÈ†ÅÈù¢Ôºà‰∏çÂê´Ë™òÁ≠îÂàÜÊûê„ÄÅÂÄã‰∫∫ÂõõÂêëÂ∫¶ÔºâÂåØÂá∫ÁÇ∫‰∏Ä‰ªΩ PDF Ê™îÊ°à„ÄÇ</p>
                    <button id="downloadReportBtn" onclick="downloadFullReport()" class="download-btn">
                        ‰∏ãËºâÂÆåÊï¥ÂàÜÊûêÂ†±Âëä (PDF)
                    </button>
                    <div id="reportProgressContainer" class="progress-container" style="display: none;">
                        <div id="reportProgressText" class="progress-text">Ê∫ñÂÇôÁîüÊàê PDF...</div>
                        <div class="progress-bar">
                            <div id="reportProgressFill" class="progress-fill">0%</div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function createWrightMapView(data) {
            return `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">üó∫Ô∏è Wright Map - ÂèóÊ∏¨ËÄÖËÉΩÂäõËàáÈ°åÁõÆÈõ£Â∫¶ÂàÜÂ∏ÉÂúñ</h3>
                <div class="info-box mb-4">
                    <p class="font-semibold mb-2">ÂúñË°®Ë™™ÊòéÔºö</p>
                    <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                        <li><strong>Â∑¶ÂÅ¥</strong>ÔºöÂèóÊ∏¨ËÄÖËÉΩÂäõÂàÜÂ∏ÉÔºàÊØèÂÄã X ‰ª£Ë°®‰∏Ä‰ΩçÂèóÊ∏¨ËÄÖÔºâ</li>
                        <li><strong>Âè≥ÂÅ¥</strong>ÔºöÈ°åÁõÆÈõ£Â∫¶ÂàÜÂ∏ÉÔºàÈ°ØÁ§∫È°åËôüÔºâ</li>
                        <li><strong>Áõ∏ÂêåÈ´òÂ∫¶</strong>ÔºöË°®Á§∫ËÉΩÂäõÂÄºÊàñÈõ£Â∫¶ÂÄºÁõ∏Ëøë</li>
                        <li><strong>Ëß£ËÆÄ</strong>ÔºöÂèóÊ∏¨ËÄÖ‰ΩçÁΩÆÈ´òÊñºÈ°åÁõÆ ‚Üí ËÉΩÂäõ > Èõ£Â∫¶ ‚Üí È†êÊúüÁ≠îÂ∞ç</li>
                        <li><strong>Ëß£ËÆÄ</strong>ÔºöÂèóÊ∏¨ËÄÖ‰ΩçÁΩÆ‰ΩéÊñºÈ°åÁõÆ ‚Üí ËÉΩÂäõ < Èõ£Â∫¶ ‚Üí È†êÊúüÁ≠îÈåØ</li>
                    </ul>
                </div>
                <div class="bg-white p-4 rounded-lg"><img src="${data.wrightmapUrl}" class="max-w-full h-auto mx-auto"></div>
            </div>`;
        }

        function createItemFitView(data) {
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">üî¨ È°åÁõÆÈÅ©ÈÖçÂ∫¶ÂàÜÊûêÔºàInfit / OutfitÔºâ</h3>
                <div class="info-box mb-4">
                    <h4 class="font-bold mb-2">üìå ÈÅ©ÈÖçÂ∫¶Âà§Êñ∑Ê®ôÊ∫ñÔºö</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>0.7 ‚â§ MNSQ ‚â§ 1.3</strong>Ôºöüü¢ ËâØÂ•ΩÔºàÈ°åÁõÆÁ¨¶Âêà Rasch Ê®°ÂûãÔºâ</li>
                        <li><strong>0.6 ‚â§ MNSQ < 0.7 Êàñ 1.3 < MNSQ ‚â§ 1.4</strong>Ôºöüü° ÂèØÊé•Âèó</li>
                        <li><strong>MNSQ < 0.6 Êàñ MNSQ > 1.4</strong>Ôºöüî¥ ÈúÄÊ™¢Ë®é</li>
                    </ul>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-sm bg-white">
                    <thead class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                        <tr><th class="p-3 text-left">È°åËôü</th><th class="p-3 text-left">Èõ£Â∫¶ (Œ≤)</th><th class="p-3 text-left">SE</th><th class="p-3 text-left">Infit MNSQ</th><th class="p-3 text-left">Infit t</th><th class="p-3 text-left">Outfit MNSQ</th><th class="p-3 text-left">Outfit t</th><th class="p-3 text-left">Âà§Êñ∑</th></tr>
                    </thead><tbody>`;
            
            for (let i = 0; i < data.nItems; i++) {
                const infit = data.itemInfit[i], outfit = data.itemOutfit[i];
                let status = 'üü¢ ËâØÂ•Ω', statusClass = 'bg-green-100';
                if (infit > 1.4 || outfit > 1.4 || infit < 0.6 || outfit < 0.6) {
                    status = 'üî¥ ÈúÄÊ™¢Ë®é'; statusClass = 'bg-red-100';
                } else if ((infit > 1.3 && infit <= 1.4) || (outfit > 1.3 && outfit <= 1.4) || (infit >= 0.6 && infit < 0.7) || (outfit >= 0.6 && outfit < 0.7)) {
                    status = 'üü° ÂèØÊé•Âèó'; statusClass = 'bg-yellow-100';
                }
                html += `<tr class="border-b hover:bg-gray-50 ${statusClass}">
                    <td class="p-3 font-semibold">Q${i+1}</td><td class="p-3">${data.itemDifficulty[i].toFixed(3)}</td><td class="p-3">${data.itemSE[i].toFixed(3)}</td>
                    <td class="p-3 ${infit > 1.3 || infit < 0.7 ? 'font-bold text-red-600' : ''}">${infit.toFixed(3)}</td><td class="p-3">${data.itemInfitT[i].toFixed(2)}</td>
                    <td class="p-3 ${outfit > 1.3 || outfit < 0.7 ? 'font-bold text-red-600' : ''}">${outfit.toFixed(3)}</td><td class="p-3">${data.itemOutfitT[i].toFixed(2)}</td>
                    <td class="p-3">${status}</td></tr>`;
            }
            html += `</tbody></table></div>
                <button class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600" onclick="downloadItemFit()">üì• ÂåØÂá∫ÈÅ©ÈÖçÂ∫¶Áµ±Ë®à</button>
            </div>`;
            return html;
        }

        function createDiscriminationView(data) {
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">üìà È°åÁõÆÈëëÂà•Â∫¶ÂàÜÊûêÔºàPoint-Biserial CorrelationÔºâ</h3>
                <div class="info-box mb-4">
                    <h4 class="font-bold mb-2">üìå ÈëëÂà•Â∫¶Âà§Êñ∑Ê®ôÊ∫ñÔºö</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>rpb ‚â• 0.4</strong>Ôºöüü¢ ÂÑ™ÁßÄ</li><li><strong>0.3 ‚â§ rpb < 0.4</strong>Ôºöüü¢ ËâØÂ•Ω</li><li><strong>0.2 ‚â§ rpb < 0.3</strong>Ôºöüü° Â∞öÂèØ</li><li><strong>rpb < 0.2</strong>Ôºöüî¥ ‰∏ç‰Ω≥</li>
                    </ul>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-sm bg-white">
                    <thead class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                        <tr><th class="p-3 text-left">È°åËôü</th><th class="p-3 text-left">Èõ£Â∫¶ (Œ≤)</th><th class="p-3 text-left">ÈëëÂà•Â∫¶ (rpb)</th><th class="p-3 text-left">Á≠âÁ¥ö</th><th class="p-3 text-left">Âà§Êñ∑</th></tr>
                    </thead><tbody>`;
            
            for (let i = 0; i < data.nItems; i++) {
                const disc = data.itemDiscrimination[i];
                let level = '', status = '', statusClass = '';
                if (disc < 0) { level = 'Âö¥ÈáçÂïèÈ°å'; status = 'üî¥üî¥ È°åÁõÆÊúâË™§'; statusClass = 'bg-red-200'; }
                else if (disc < 0.1) { level = 'Ê•µÂ∑Æ'; status = 'üî¥ Âª∫Ë≠∞Âà™Èô§'; statusClass = 'bg-red-100'; }
                else if (disc < 0.2) { level = '‰∏ç‰Ω≥'; status = 'üî¥ Áº∫‰πèÈëëÂà•Âäõ'; statusClass = 'bg-orange-100'; }
                else if (disc < 0.3) { level = 'Â∞öÂèØ'; status = 'üü° Âª∫Ë≠∞ÊîπÂñÑ'; statusClass = 'bg-yellow-100'; }
                else if (disc < 0.4) { level = 'ËâØÂ•Ω'; status = 'üü¢ ÂèØÊé•Âèó'; statusClass = 'bg-green-100'; }
                else { level = 'ÂÑ™ÁßÄ'; status = 'üü¢ ÈëëÂà•Âäõ‰Ω≥'; statusClass = 'bg-green-200'; }
                html += `<tr class="border-b hover:bg-gray-50 ${statusClass}">
                    <td class="p-3 font-semibold">Q${i+1}</td><td class="p-3">${data.itemDifficulty[i].toFixed(3)}</td>
                    <td class="p-3 ${disc < 0.2 ? 'font-bold text-red-600' : disc >= 0.4 ? 'font-bold text-green-600' : ''}">${disc.toFixed(3)}</td>
                    <td class="p-3">${level}</td><td class="p-3">${status}</td></tr>`;
            }
            html += `</tbody></table></div>
                <button class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600" onclick="downloadDiscrimination()">üì• ÂåØÂá∫ÈëëÂà•Â∫¶Áµ±Ë®à</button>
            </div>`;
            return html;
        }

        function createBubbleChartView(data) {
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">ü´ß È°åÁõÆÂìÅË≥™Ê∞£Ê≥°Âúñ</h3>
                <div class="info-box mb-4">
                    <h4 class="font-bold mb-2">üìå Ê∞£Ê≥°ÂúñË™™ÊòéÔºö</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>XËª∏</strong>ÔºöÈõ£Â∫¶ÂÄºÔºàRasch Œ≤Ôºâ</li><li><strong>YËª∏</strong>ÔºöÈëëÂà•Â∫¶ÔºàrpbÔºâ</li><li><strong>Ê∞£Ê≥°Â§ßÂ∞è</strong>ÔºöÊ®ôÊ∫ñË™§ÔºàSEÔºâ</li><li><strong>È°èËâ≤</strong>ÔºöÁ∂†Ëâ≤=ÂÑ™ËâØ„ÄÅÊ©òËâ≤=Â∞öÂèØ„ÄÅÁ¥ÖËâ≤=ÈúÄÊîπÈÄ≤</li>
                    </ul>
                </div>
                <div class="bg-white p-4 rounded-lg mb-4"><canvas id="bubbleChartCanvas" style="max-height: 600px;"></canvas></div>`;
            
            const anomalies = [];
            for (let i = 0; i < data.nItems; i++) {
                const issues = [];
                if (data.itemDiscrimination[i] < 0.2) issues.push('ÈëëÂà•Â∫¶ÈÅé‰Ωé');
                if (data.itemInfit[i] > 1.4 || data.itemOutfit[i] > 1.4) issues.push('ÈÅ©ÈÖçÂ∫¶‰∏çËâØ');
                if (data.itemSE[i] > 0.5) issues.push('Ê∏¨ÈáèË™§Â∑ÆÂ§ß');
                if (issues.length > 0) anomalies.push({ itemNum: i + 1, issues });
            }
            
            if (anomalies.length > 0) {
                html += '<div class="error-box"><h4 class="font-bold mb-2">‚ö†Ô∏è Áï∞Â∏∏È°åÁõÆË≠¶Á§∫Ôºö</h4><table class="w-full text-sm"><thead><tr><th class="p-2 text-left">È°åËôü</th><th class="p-2 text-left">ÂïèÈ°å</th></tr></thead><tbody>';
                anomalies.forEach(a => {
                    html += `<tr class="border-b"><td class="p-2">Q${a.itemNum}</td><td class="p-2">${a.issues.map(issue => `<span class="badge poor-badge">${issue}</span>`).join(' ')}</td></tr>`;
                });
                html += '</tbody></table></div>';
            } else {
                html += '<div class="info-box">‚úÖ ÊâÄÊúâÈ°åÁõÆÂìÅË≥™ËâØÂ•ΩÔºåÁÑ°Áï∞Â∏∏È°åÁõÆ</div>';
            }
            html += '</div>';
            setTimeout(() => {
                 const canvas = document.querySelector('#tab-bubble #bubbleChartCanvas');
                 if (canvas) {
                    renderBubbleChart(data, canvas);
                 }
            }, 100);
            return html;
        }

        function renderBubbleChart(data, canvasElement) {
            const ctx = canvasElement || document.getElementById('bubbleChartCanvas');
            if (!ctx) return;

            let existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }
            
            const bubbleData = [];
            for (let i = 0; i < data.nItems; i++) {
                const difficulty = data.itemDifficulty[i];
                const discrimination = data.itemDiscrimination[i];
                const se = data.itemSE[i];
                let color = (discrimination >= 0.3 && se < 0.3) ? 'rgba(34, 197, 94, 0.7)' : 
                           (discrimination >= 0.2 && se < 0.4) ? 'rgba(251, 146, 60, 0.7)' : 'rgba(239, 68, 68, 0.7)';
                bubbleData.push({ x: difficulty, y: discrimination, r: se * 50, label: `Q${i+1}`, backgroundColor: color });
            }
            
            new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: bubbleData.map(d => ({
                        label: d.label,
                        data: [{ x: d.x, y: d.y, r: d.r }],
                        backgroundColor: d.backgroundColor
                    }))
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { title: { display: true, text: 'Èõ£Â∫¶ÂÄº Œ≤ (logit)' } }, y: { title: { display: true, text: 'ÈëëÂà•Â∫¶ rpb' }, beginAtZero: true } },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return [`È°åËôü: ${context.dataset.label}`, `Èõ£Â∫¶: ${context.parsed.x.toFixed(3)}`, `ÈëëÂà•Â∫¶: ${context.parsed.y.toFixed(3)}`, `Ê®ôÊ∫ñË™§: ${(context.parsed.r / 50).toFixed(3)}`];
                                }
                            }
                        }
                    },
                    animation: {
                        duration: (canvasElement ? 0 : 1000)
                    }
                }
            });
        }

        function createDistractorView(data) {
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">üéØ Ë™òÁ≠îÈÅ∏È†ÖÂàÜÊûê</h3>
                <div class="info-box mb-4">
                    <h4 class="font-bold mb-2">üìå Ë™òÁ≠îÈÅ∏È†ÖÂìÅË≥™Âà§Êñ∑Ôºö</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>ÊúâÊïàË™òÁ≠î</strong>Ôºöüü¢ ‰ΩéËÉΩÂäõÂ≠∏ÁîüÈÅ∏Êìá</li><li><strong>ÈúÄÊ™¢Ë®éË™òÁ≠î</strong>Ôºöüü° ‰∏≠È´òËÉΩÂäõÂ≠∏ÁîüÈÅ∏Êìá</li><li><strong>ÁÑ°ÊïàË™òÁ≠î</strong>Ôºöüî¥ Âπæ‰πéÊ≤í‰∫∫ÈÅ∏ÊìáÔºàÊØî‰æã < 5%Ôºâ</li><li><strong>Ê∑∑Ê∑ÜÈÅ∏È†Ö</strong>Ôºöüî¥üî¥ È´òËÉΩÂäõÂ≠∏ÁîüÈÅ∏ÊìáÊØî‰æãÈ´ò</li>
                    </ul>
                </div>`;
            
            if (!data.distractorStats || data.distractorStats.length === 0) {
                html += '<div class="warning-box">‚ö†Ô∏è ÁÑ°Ê≥ïÈÄ≤Ë°åË™òÁ≠îÂàÜÊûêÔºàÂèØËÉΩÊòØÈÅ∏Â°´È°åÊàñË≥áÊñô‰∏çË∂≥Ôºâ</div></div>';
                return html;
            }
            
            data.distractorStats.forEach(item => {
                html += `<div class="bg-white p-4 rounded-lg mb-4"><h4 class="font-bold mb-3 text-lg">Q${item.questionIndex} ÈÅ∏È†ÖÂàÜÊûê</h4>`;
                const options = Object.keys(item.options).sort();
                
                if (options.length === 0) {
                    html += '<div class="text-gray-500">ÁÑ°ÊúâÊïà‰ΩúÁ≠îË≥áÊñô</div>';
                } else {
                    html += '<table class="w-full text-sm"><thead class="bg-gray-200"><tr><th class="p-2 text-left">ÈÅ∏È†Ö</th><th class="p-2 text-left">ÈÅ∏Êìá‰∫∫Êï∏</th><th class="p-2 text-left">ÊØî‰æã</th><th class="p-2 text-left">Âπ≥ÂùáËÉΩÂäõÂÄº</th><th class="p-2 text-left">Âà§Êñ∑</th></tr></thead><tbody>';
                    const correctOption = item.correctAnswer;
                    const correctAvgAbility = item.options[correctOption] ? item.options[correctOption].avgAbility : 0;
                    
                    options.forEach(option => {
                        const stat = item.options[option];
                        const isCorrect = (option === correctOption);
                        const percentage = parseFloat(stat.percentage);
                        const avgAbility = stat.avgAbility;
                        let judgment = '', rowClass = '';
                        
                        if (isCorrect) { judgment = '‚úì Ê≠£Á¢∫Á≠îÊ°à'; rowClass = 'bg-green-50 font-semibold'; }
                        else {
                            if (percentage < 5) { judgment = 'üî¥ ÁÑ°ÊïàË™òÁ≠î'; rowClass = 'bg-red-50'; }
                            else if (avgAbility >= correctAvgAbility - 0.2) { judgment = 'üî¥üî¥ Ê∑∑Ê∑ÜÈÅ∏È†Ö'; rowClass = 'bg-red-100'; }
                            else if (avgAbility >= correctAvgAbility - 0.5) { judgment = 'üü° ÈúÄÊ™¢Ë®é'; rowClass = 'bg-yellow-50'; }
                            else { judgment = 'üü¢ ÊúâÊïàË™òÁ≠î'; rowClass = 'bg-gray-50'; }
                        }
                        html += `<tr class="${rowClass}"><td class="p-2">${option}${isCorrect ? ' ‚òÖ' : ''}</td><td class="p-2">${stat.count}</td><td class="p-2">${stat.percentage}%</td><td class="p-2">${avgAbility.toFixed(3)}</td><td class="p-2">${judgment}</td></tr>`;
                    });
                    html += '</tbody></table>';
                }
                html += '</div>';
            });
            html += '<button class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600" onclick="downloadDistractor()">üì• ÂåØÂá∫Ë™òÁ≠îÂàÜÊûê</button></div>';
            return html;
        }

        function createIndividualTable(data) {
            const classes = [...new Set(data.classInfo)];
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">üë• ÂÄã‰∫∫ÂõõÂêëÂ∫¶Á≠îÈ°åÂàÜÊûêÔºàÂê´ KIDMAP Ë®∫Êñ∑Ôºâ</h3>
                <div class="flex gap-4 mb-4 items-end flex-wrap">
                    <div><label class="block text-sm font-semibold mb-1">Áè≠Á¥öÁØ©ÈÅ∏Ôºö</label>
                        <select id="classFilter" class="p-2 border-2 rounded-lg"><option value="all">ÂÖ®ÈÉ®Áè≠Á¥ö</option>`;
            classes.forEach(cls => { html += `<option value="${cls}">${cls}</option>`; });
            html += `</select></div>
                    <button class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600" onclick="downloadFilteredIndividualStats()">üì• ÂåØÂá∫ÂÄã‰∫∫Áµ±Ë®à</button>
                </div>
                
                <div class="download-section">
                    <h4 class="text-xl font-bold mb-4 text-blue-800 flex items-center gap-2">
                        üìÑ ‰∏ãËºâÂÄã‰∫∫ PDF Â†±Âëä
                    </h4>
                    <div class="flex gap-4 mb-4 flex-wrap">
                        ${classes.map(cls => `
                            <label class="flex items-center gap-2 bg-white px-4 py-2 rounded-lg border-2 border-gray-200 hover:border-blue-400 cursor-pointer transition-all">
                                <input type="checkbox" class="class-checkbox w-4 h-4" value="${cls}">
                                <span class="font-semibold">${cls} (${data.classStats[cls].count}‰∫∫)</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="flex gap-4 flex-wrap">
                        <button onclick="downloadSelectedClassPDF()" class="download-btn">
                            üì• ‰∏ãËºâÂ∑≤ÈÅ∏Áè≠Á¥ö
                        </button>
                        <button onclick="downloadAllClassPDF()" class="download-btn">
                            üì• ‰∏ãËºâÂÖ®ÈÉ®Áè≠Á¥ö
                        </button>
                    </div>
                    <div class="progress-container" id="individualPdfProgressContainer">
                        <div class="progress-text" id="individualPdfProgressText">Ê∫ñÂÇôÁîüÊàê PDF...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="individualPdfProgressFill">0%</div>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto mt-6"><table class="w-full text-sm" id="individualTable">
                    <thead class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                        <tr><th class="p-3 text-left">Áè≠Á¥ö</th><th class="p-3 text-left">Â≠∏Ëôü</th><th class="p-3 text-left">ÂßìÂêç</th><th class="p-3 text-left">ËÉΩÂäõÂÄº (Œ∏)</th><th class="p-3 text-left">Á∏ΩÂàÜ</th>
                        <th class="p-3 text-left bg-green-600">ÂêàÁêÜÁ≠îÂ∞ç</th><th class="p-3 text-left bg-orange-600">ÂêàÁêÜÁ≠îÈåØ</th>
                        <th class="p-3 text-left bg-blue-600">ÂÑ™Âã¢Ê¶ÇÂøµ</th><th class="p-3 text-left bg-red-600">Ëø∑ÊÄùÊ¶ÇÂøµ</th><th class="p-3 text-left">KIDMAP</th></tr>
                    </thead><tbody class="bg-white">`;
            
            data.individualStats.forEach(student => {
                const rowClass = student.misconceptionCount > 3 ? 'misconception-highlight' : '';
                html += `<tr class="${rowClass} border-b hover:bg-gray-50" data-class="${student.class}">
                    <td class="p-3">${student.class}</td>
                    <td class="p-3 font-semibold">${student.studentId}</td>
                    <td class="p-3">${student.studentName}</td>
                    <td class="p-3">${student.ability.toFixed(3)}</td>
                    <td class="p-3">${student.score} / ${data.nItems}</td>
                    <td class="p-3"><span class="badge reasonable-correct-badge">${student.reasonableCorrectCount} È°å</span></td>
                    <td class="p-3"><span class="badge reasonable-wrong-badge">${student.reasonableWrongCount} È°å</span></td>
                    <td class="p-3"><span class="badge advantage-badge">${student.advantageCount} È°å</span></td>
                    <td class="p-3"><span class="badge misconception-badge">${student.misconceptionCount} È°å</span></td>
                    <td class="p-3"><button class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg font-semibold hover:shadow-lg transition-all" onclick="showKidmapReport(${student.index})">üìä Êü•ÁúãKIDMAP</button></td>
                </tr>`;
            });
            html += '</tbody></table></div></div>';
            return html;
        }

        window.showKidmapReport = function(studentIndex) {
            const student = analysisData.individualStats[studentIndex];
            const responses = analysisData.responseMatrix[studentIndex];
            const items = analysisData.itemDifficulty;
            
            const itemAnalysis = items.map((difficulty, i) => {
                const prob = 1 / (1 + Math.exp(-(student.ability - difficulty)));
                const actual = responses[i];
                const expected = prob > 0.5 ? 1 : 0;
                const unexpected = (actual === 1 && expected === 0) || (actual === 0 && expected === 1);
                return { name: `Q${i + 1}`, difficulty, actual, expected, probability: prob, unexpected };
            });
            
            const kidmapHTML = generateVisualKidmap(student, itemAnalysis);
            const diagnosticStats = generateDiagnosticStats(student, itemAnalysis);
            const itemAnalysisTable = generateItemAnalysisTable(itemAnalysis);
            
            document.getElementById('kidmapModalTitle').textContent = `KIDMAP Ë®∫Êñ∑Â†±Âëä - ${student.class} ${student.studentId} ${student.studentName}`;
            document.getElementById('kidmapModalBody').innerHTML = `
                <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border-2 border-blue-200">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">Âü∫Êú¨Ë≥áË®ä</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="bg-white p-3 rounded-lg"><div class="text-xs text-gray-600 mb-1">Â≠∏Âè∑</div><div class="text-lg font-bold text-gray-800">${student.studentId}</div></div>
                        <div class="bg-white p-3 rounded-lg"><div class="text-xs text-gray-600 mb-1">ÂßìÂêç</div><div class="text-lg font-bold text-gray-800">${student.studentName}</div></div>
                        <div class="bg-white p-3 rounded-lg"><div class="text-xs text-gray-600 mb-1">Áè≠Á¥ö</div><div class="text-lg font-bold text-gray-800">${student.class}</div></div>
                        <div class="bg-white p-3 rounded-lg"><div class="text-xs text-gray-600 mb-1">ËÉΩÂäõÂÄº (Œ∏)</div><div class="text-lg font-bold text-blue-600">${student.ability.toFixed(3)}</div></div>
                        <div class="bg-white p-3 rounded-lg"><div class="text-xs text-gray-600 mb-1">ÂæóÂàÜ</div><div class="text-lg font-bold text-green-600">${student.score}/${analysisData.nItems}</div></div>
                    </div>
                </div>
                ${diagnosticStats}
                ${kidmapHTML}
                ${itemAnalysisTable}
                <div class="mt-6 p-4 bg-yellow-50 rounded-xl border-2 border-yellow-200">
                    <h4 class="font-bold text-lg mb-3 text-yellow-800">üìù ÊïôÂ≠∏Âª∫Ë≠∞</h4>
                    <ul class="list-disc list-inside space-y-2 text-sm">
                        ${student.misconceptionCount > 0 ? `<li class="text-red-700"><strong>Ëø∑ÊÄùÊ¶ÇÂøµÈ°åÁõÆÔºà${student.misconceptionCount}È°åÔºâÔºö</strong>È°åËôü ${student.misconceptionItems.join(', ')} - Âª∫Ë≠∞Âä†Âº∑Âü∫Á§éËßÄÂøµË§áÁøí</li>` : ''}
                        ${student.advantageCount > 0 ? `<li class="text-blue-700"><strong>ÂÑ™Âã¢Ê¶ÇÂøµÈ°åÁõÆÔºà${student.advantageCount}È°åÔºâÔºö</strong>È°åËôü ${student.advantageItems.join(', ')} - ÂèØÊåëÊà∞Êõ¥È´òÈõ£Â∫¶</li>` : ''}
                        ${student.reasonableCorrectCount > analysisData.nItems * 0.7 ? `<li class="text-green-700"><strong>Êï¥È´îË°®ÁèæÂÑ™Áï∞</strong> - Âª∫Ë≠∞ÈÄ≤Ë°åÂª∂‰º∏Â≠∏ÁøíËàáÊ∑±ÂåñÁêÜËß£</li>` : ''}
                        ${student.misconceptionCount === 0 && student.advantageCount === 0 ? '<li>Ë°®ÁèæÁ¨¶ÂêàÈ†êÊúüÔºåË´ãÁπºÁ∫å‰øùÊåÅ„ÄÇ</li>' : ''}
                    </ul>
                </div>
            `;
            document.getElementById('kidmapModal').style.display = 'block';
        };

        function generateItemAnalysisTable(itemAnalysis) {
            return `
                <div class="mt-6 p-4 bg-white rounded-xl border-2 border-gray-200">
                    <h4 class="font-bold text-lg mb-3 text-gray-800">üìã ÈÄêÈ°å‰ΩúÁ≠îÂàÜÊûê</h4>
                    <div class="overflow-x-auto">
                        <table class="item-analysis-table">
                            <thead>
                                <tr>
                                    <th>È°åËôü</th>
                                    <th>Èõ£Â∫¶ÂÄº</th>
                                    <th>‰ΩúÁ≠îÁµêÊûú</th>
                                    <th>È†êÊúüÁµêÊûú</th>
                                    <th>Á≠îÂ∞çÊ©üÁéá</th>
                                    <th>ÁãÄÊÖã</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemAnalysis.map(item => `
                                    <tr class="${item.unexpected ? 'unexpected-cell' : ''}">
                                        <td><strong>${item.name}</strong></td>
                                        <td>${item.difficulty.toFixed(3)}</td>
                                        <td class="${item.actual === 1 ? 'correct-cell' : 'incorrect-cell'}">
                                            ${item.actual === 1 ? '‚úì Á≠îÂ∞ç' : '‚úó Á≠îÈåØ'}
                                        </td>
                                        <td>${item.expected === 1 ? '‚úì' : '‚úó'}</td>
                                        <td>${(item.probability * 100).toFixed(1)}%</td>
                                        <td>${item.unexpected ? '<span class="badge poor-badge">ÊÑèÂ§ñÂèçÊáâ</span>' : '<span class="badge good-badge">Á¨¶ÂêàÈ†êÊúü</span>'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        window.closeKidmapModal = function() {
            document.getElementById('kidmapModal').style.display = 'none';
        };

        document.getElementById('kidmapModal').addEventListener('click', (e) => {
            if (e.target.id === 'kidmapModal') closeKidmapModal();
        });

        function generateDiagnosticStats(student, itemAnalysis) {
            const unexpected = itemAnalysis.filter(i => i.unexpected).length;
            const total = itemAnalysis.length;
            
            return `<div class="diagnostic-stats">
                <div class="diag-card ${unexpected > total * 0.2 ? 'warning' : 'success'}"><div class="diag-label">ÊÑèÂ§ñÂèçÊáâ</div><div class="diag-value">${unexpected}/${total}</div><div class="text-xs mt-2">${((unexpected/total)*100).toFixed(1)}%</div></div>
                <div class="diag-card success"><div class="diag-label">ÂêàÁêÜÁ≠îÂ∞ç</div><div class="diag-value">${student.reasonableCorrectCount}</div><div class="text-xs mt-2">ËÉΩÂäõÂÄº > Èõ£Â∫¶</div></div>
                <div class="diag-card warning"><div class="diag-label">ÂêàÁêÜÁ≠îÈåØ</div><div class="diag-value">${student.reasonableWrongCount}</div><div class="text-xs mt-2">Èõ£Â∫¶ > ËÉΩÂäõÂÄº</div></div>
                <div class="diag-card ${student.advantageCount > 0 ? 'success' : ''}"><div class="diag-label">ÂÑ™Âã¢Ê¶ÇÂøµ</div><div class="diag-value">${student.advantageCount}</div><div class="text-xs mt-2">Á≠îÂ∞çÈõ£È°å</div></div>
                <div class="diag-card ${student.misconceptionCount > 0 ? 'danger' : 'success'}"><div class="diag-label">Ëø∑ÊÄùÊ¶ÇÂøµ</div><div class="diag-value">${student.misconceptionCount}</div><div class="text-xs mt-2">Á≠îÈåØÊòìÈ°å</div></div>
            </div>`;
        }

        function generateVisualKidmap(student, itemAnalysis, isPdf = false) {
            const sortedItems = [...itemAnalysis].sort((a, b) => b.difficulty - a.difficulty);
            const maxDiff = Math.max(...sortedItems.map(i => i.difficulty));
            const minDiff = Math.min(...sortedItems.map(i => i.difficulty));
            const range = maxDiff - minDiff || 1;
            
            const abilityLinePosition = ((maxDiff - student.ability) / range) * 100;
            
            const topOffset = isPdf ? '28px' : '40px';
            const heightOffset = isPdf ? '60px' : '80px'; 

            const advantageConcept = [], reasonableCorrect = [], misconception = [], reasonableIncorrect = [];
            
            sortedItems.forEach(item => {
                const badge = `<span class="item-badge ${item.actual === 1 ? 'correct' : 'incorrect'} ${item.unexpected ? 'unexpected' : ''}">${item.name} <span class="item-info">(${item.difficulty.toFixed(2)})</span></span>`;
                if (item.difficulty > student.ability) {
                    if (item.actual === 1) advantageConcept.push(badge);
                    else reasonableIncorrect.push(badge);
                } else {
                    if (item.actual === 1) reasonableCorrect.push(badge);
                    else misconception.push(badge);
                }
            });
            
            return `<div class="kidmap-visual">
                <style>
                    .kidmap-quadrants-container {
                        position: relative;
                    }
                    .kidmap-ability-line {
                        position: absolute;
                        left: 0;
                        right: 0;
                        height: 3px;
                        background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
                        z-index: 100;
                        box-shadow: 0 0 10px rgba(245, 87, 108, 0.5);
                        pointer-events: none;
                        top: calc(${topOffset} + ${abilityLinePosition}% * (100% - ${heightOffset}) / 100);
                    }
                </style>
                <div class="kidmap-quadrants-container">
                    <div class="kidmap-quadrants">
                        <div class="kidmap-header">üìä Ë¶ñË¶∫Âåñ KIDMAP Ë®∫Êñ∑Âúñ - ËÉΩÂäõÊ∏¨Èáè vs È°åÁõÆÈõ£Â∫¶ÂàÜÂ∏É</div>
                        <div class="quadrant quadrant-top-left">
                            <div class="quadrant-title">üåü ÂÑ™Âã¢Ê¶ÇÂøµÔºàÁ≠îÂ∞çËºÉÈõ£È°åÁõÆÔºâ</div>
                            ${advantageConcept.length > 0 ? advantageConcept.join('') : '<div class="text-gray-500">ÁÑ°ÂÑ™Âã¢Ê¶ÇÂøµÈ°åÁõÆ</div>'}
                        </div>
                        <div class="quadrant quadrant-top-right">
                            <div class="quadrant-title">üü† ÂêàÁêÜÁ≠îÈåØÔºàÂ§™Èõ£ÁöÑÈ°åÁõÆÔºâ</div>
                            ${reasonableIncorrect.length > 0 ? reasonableIncorrect.join('') : '<div class="text-gray-500">ÁÑ°ÂêàÁêÜÁ≠îÈåØÈ°åÁõÆ</div>'}
                        </div>
                        
                        <div class="quadrant quadrant-bottom-left">
                            <div class="quadrant-title">üü¢ ÂêàÁêÜÁ≠îÂ∞çÔºàËÉΩÂäõË∂≥Â§†Ôºâ</div>
                            ${reasonableCorrect.length > 0 ? reasonableCorrect.join('') : '<div class="text-gray-500">ÁÑ°ÂêàÁêÜÁ≠îÂ∞çÈ°åÁõÆ</div>'}
                        </div>
                        <div class="quadrant quadrant-bottom-right">
                            <div class="quadrant-title">üî¥ Ëø∑ÊÄùÊ¶ÇÂøµÔºàÊáâÊúÉÂçª‰∏çÊúÉÔºâ</div>
                            ${misconception.length > 0 ? misconception.join('') : '<div class="text-green-600 font-semibold">‚úÖ ÁÑ°Ëø∑ÊÄùÊ¶ÇÂøµÔºåË°®ÁèæËâØÂ•ΩÔºÅ</div>'}
                        </div>
                        
                        <div class="kidmap-footer">
                            <strong>Âà§ËÆÄË™™ÊòéÔºö</strong>ËÉΩÂäõÁ∑ö‰ª•‰∏äÁÇ∫„ÄåËºÉÈõ£È°åÁõÆ„ÄçÔºå‰ª•‰∏ãÁÇ∫„ÄåËºÉÁ∞°ÂñÆÈ°åÁõÆ„Äç„ÄÇ
                            <strong>Á∂†Ëâ≤ÂæΩÁ´†</strong> = Á≠îÂ∞ç | <strong>Á¥ÖËâ≤ÂæΩÁ´†</strong> = Á≠îÈåØ | <strong>ÈñÉÁàçÈÇäÊ°Ü</strong> = ÊÑèÂ§ñÂèçÊáâ
                        </div>
                    </div>
                    <div class="kidmap-ability-line">
                        <div class="ability-label">Â≠∏ÁîüËÉΩÂäõÂÄº Œ∏ = ${student.ability.toFixed(3)}</div>
                    </div>
                </div>
            </div>`;
    }

    function createClassStats(data) {
        const classes = Object.keys(data.classStats);
        let html = `<div class="p-6 bg-gray-50 rounded-xl">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">üìö Áè≠Á¥öÂõõÂêëÂ∫¶Áµ±Ë®àÊëòË¶Å</h3>
            
            <div class="overflow-x-auto mb-6"><table class="w-full text-sm bg-white">
                <thead class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                    <tr><th class="p-3 text-left">Áè≠Á¥ö</th><th class="p-3 text-left">‰∫∫Êï∏</th><th class="p-3 text-left bg-green-600">Âπ≥ÂùáÂêàÁêÜÁ≠îÂ∞ç</th><th class="p-3 text-left bg-orange-600">Âπ≥ÂùáÂêàÁêÜÁ≠îÈåØ</th><th class="p-3 text-left bg-blue-600">Âπ≥ÂùáÂÑ™Âã¢Ê¶ÇÂøµ</th><th class="p-3 text-left bg-red-600">Âπ≥ÂùáËø∑ÊÄùÊ¶ÇÂøµ</th><th class="p-3 text-left">Á∏ΩËø∑ÊÄùÊ¶ÇÂøµ</th></tr>
                </thead><tbody>`;
        
        classes.forEach(cls => {
            const stats = data.classStats[cls];
            html += `<tr class="border-b hover:bg-gray-50">
                <td class="p-3 font-semibold">${cls}</td><td class="p-3">${stats.count}</td>
                <td class="p-3"><span class="badge reasonable-correct-badge">${stats.avgReasonableCorrect.toFixed(2)} È°å</span></td>
                <td class="p-3"><span class="badge reasonable-wrong-badge">${stats.avgReasonableWrong.toFixed(2)} È°å</span></td>
                <td class="p-3"><span class="badge advantage-badge">${stats.avgAdvantage.toFixed(2)} È°å</span></td>
                <td class="p-3"><span class="badge misconception-badge">${stats.avgMisconception.toFixed(2)} È°å</span></td>
                <td class="p-3">${stats.totalMisconception} Ê¨°</td></tr>`;
        });
        
        html += '</tbody></table></div>';
        
        html += '<div class="grid md:grid-cols-2 gap-6">';
        
        html += '<div><h3 class="text-2xl font-bold mb-4 text-red-600">üî¥ ÂêÑÁè≠Ëø∑ÊÄùÊ¶ÇÂøµÈ°åËôüÊéíË°å</h3>';
        classes.forEach(cls => {
            const misconceptionItems = data.classMisconceptionItems[cls] || [];
            html += `<div class="bg-white p-4 rounded-lg mb-4 border-2 border-red-200">
                <h4 class="font-bold mb-3 text-lg">${cls} Áè≠Ëø∑ÊÄùÈ°åÁõÆÊéíË°å</h4>`;
            if (misconceptionItems.length === 0) {
                html += '<div class="text-green-600">‚úÖ Êú¨Áè≠ÁÑ°Ëø∑ÊÄùÊ¶ÇÂøµÈ°åÁõÆ</div>';
            } else {
                html += '<table class="w-full text-sm"><thead class="bg-red-100"><tr><th class="p-2 text-left">ÊéíÂêç</th><th class="p-2 text-left">È°åËôü</th><th class="p-2 text-left">ÈåØË™§‰∫∫Êï∏</th><th class="p-2 text-left">ÈåØË™§Áéá</th></tr></thead><tbody>';
                misconceptionItems.slice(0, 10).forEach((item, idx) => {
                    html += `<tr class="border-b hover:bg-red-50"><td class="p-2 font-bold text-red-600">#${idx + 1}</td><td class="p-2">Q${item.itemNum}</td><td class="p-2">${item.count} ‰∫∫</td><td class="p-2">${item.percentage}%</td></tr>`;
                });
                html += '</tbody></table>';
            }
            html += '</div>';
        });
        html += '</div>';
        
        html += '<div><h3 class="text-2xl font-bold mb-4 text-orange-600">üü† ÂêÑÁè≠ÂêàÁêÜÁ≠îÈåØÈ°åËôüÊéíË°å</h3>';
        classes.forEach(cls => {
            const reasonableWrongItems = data.classReasonableWrongItems[cls] || [];
            html += `<div class="bg-white p-4 rounded-lg mb-4 border-2 border-orange-200">
                <h4 class="font-bold mb-3 text-lg">${cls} Áè≠ÂêàÁêÜÁ≠îÈåØÊéíË°å</h4>`;
            if (reasonableWrongItems.length === 0) {
                html += '<div class="text-green-600">‚úÖ Êú¨Áè≠ÁÑ°ÂêàÁêÜÁ≠îÈåØÈ°åÁõÆ</div>';
            } else {
                html += '<table class="w-full text-sm"><thead class="bg-orange-100"><tr><th class="p-2 text-left">ÊéíÂêç</th><th class="p-2 text-left">È°åËôü</th><th class="p-2 text-left">Á≠îÈåØ‰∫∫Êï∏</th><th class="p-2 text-left">Á≠îÈåØÁéá</th></tr></thead><tbody>';
                reasonableWrongItems.slice(0, 10).forEach((item, idx) => {
                    html += `<tr class="border-b hover:bg-orange-50"><td class="p-2 font-bold text-orange-600">#${idx + 1}</td><td class="p-2">Q${item.itemNum}</td><td class="p-2">${item.count} ‰∫∫</td><td class="p-2">${item.percentage}%</td></tr>`;
                });
                html += '</tbody></table>';
            }
            html += '</div>';
        });
        html += '</div>';
        
        html += '</div>';
        
        html += '<button class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600" onclick="downloadClassStats()">üì• ÂåØÂá∫Áè≠Á¥öÁµ±Ë®à</button></div>';
        return html;
    }

    function setupFilters() {
        const classFilter = document.getElementById('classFilter');
        const table = document.getElementById('individualTable');
        if (!classFilter || !table) return;
        classFilter.addEventListener('change', () => {
            const selectedClass = classFilter.value;
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const rowClass = row.dataset.class;
                row.style.display = (selectedClass === 'all' || rowClass === selectedClass) ? '' : 'none';
            });
        });
    }

    window.switchTab = function(event, tabName) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
    };

    window.downloadFilteredIndividualStats = function() {
        if (!analysisData) return;
        
        const classFilter = document.getElementById('classFilter');
        const selectedClass = classFilter ? classFilter.value : 'all';
        
        let filteredStats = analysisData.individualStats;
        if (selectedClass !== 'all') {
            filteredStats = filteredStats.filter(s => s.class === selectedClass);
        }
        
        let csv = 'CLASS,StudentID,StudentName,Ability,Score,ÂêàÁêÜÁ≠îÂ∞ç,ÂêàÁêÜÁ≠îÈåØ,ÂÑ™Âã¢Ê¶ÇÂøµ,Ëø∑ÊÄùÊ¶ÇÂøµ,ÂêàÁêÜÁ≠îÂ∞çÈ°åÁõÆ,ÂêàÁêÜÁ≠îÈåØÈ°åÁõÆ,ÂÑ™Âã¢Ê¶ÇÂøµÈ°åÁõÆ,Ëø∑ÊÄùÊ¶ÇÂøµÈ°åÁõÆ\n';
        filteredStats.forEach(s => {
            csv += `${s.class},${s.studentId},${s.studentName},${s.ability.toFixed(3)},${s.score},${s.reasonableCorrectCount},${s.reasonableWrongCount},${s.advantageCount},${s.misconceptionCount},"${s.reasonableCorrectItems.join(',')}","${s.reasonableWrongItems.join(',')}","${s.advantageItems.join(',')}","${s.misconceptionItems.join(',')}"\n`;
        });
        
        const filename = selectedClass === 'all' ? 'individual_four_categories_all.csv' : `individual_four_categories_${selectedClass}.csv`;
        downloadCSV(csv, filename);
    };

    window.downloadClassStats = function() {
        if (!analysisData) return;
        const classes = Object.keys(analysisData.classStats);
        let csv = 'CLASS,Count,Âπ≥ÂùáÂêàÁêÜÁ≠îÂ∞ç,Âπ≥ÂùáÂêàÁêÜÁ≠îÈåØ,Âπ≥ÂùáÂÑ™Âã¢Ê¶ÇÂøµ,Âπ≥ÂùáËø∑ÊÄùÊ¶ÇÂøµ,Á∏ΩÂêàÁêÜÁ≠îÂ∞ç,Á∏ΩÂêàÁêÜÁ≠îÈåØ,Á∏ΩÂÑ™Âã¢Ê¶ÇÂøµ,Á∏ΩËø∑ÊÄùÊ¶ÇÂøµ\n';
        classes.forEach(cls => {
            const s = analysisData.classStats[cls];
            csv += `${cls},${s.count},${s.avgReasonableCorrect.toFixed(2)},${s.avgReasonableWrong.toFixed(2)},${s.avgAdvantage.toFixed(2)},${s.avgMisconception.toFixed(2)},${s.totalReasonableCorrect},${s.totalReasonableWrong},${s.totalAdvantage},${s.totalMisconception}\n`;
        });
        downloadCSV(csv, 'class_four_categories.csv');
    };

    window.downloadItemFit = function() {
        if (!analysisData) return;
        let csv = 'Item,Difficulty,SE,Infit_MNSQ,Infit_t,Outfit_MNSQ,Outfit_t\n';
        for (let i = 0; i < data.nItems; i++) {
            csv += `Q${i+1},${analysisData.itemDifficulty[i].toFixed(3)},${analysisData.itemSE[i].toFixed(3)},${analysisData.itemInfit[i].toFixed(3)},${analysisData.itemInfitT[i].toFixed(2)},${analysisData.itemOutfit[i].toFixed(3)},${analysisData.itemOutfitT[i].toFixed(2)}\n`;
        }
        downloadCSV(csv, 'item_fit_statistics.csv');
    };

    window.downloadDiscrimination = function() {
        if (!analysisData) return;
        let csv = 'Item,Difficulty,Discrimination\n';
        for (let i = 0; i < data.nItems; i++) {
            csv += `Q${i+1},${analysisData.itemDifficulty[i].toFixed(3)},${analysisData.itemDiscrimination[i].toFixed(3)}\n`;
        }
        downloadCSV(csv, 'item_discrimination.csv');
    };

    window.downloadDistractor = function() {
        if (!analysisData || !analysisData.distractorStats) return;
        let csv = 'Item,Option,Count,Percentage,AvgAbility,IsCorrect\n';
        analysisData.distractorStats.forEach(item => {
            const options = Object.keys(item.options).sort();
            options.forEach(option => {
                const stat = item.options[option];
                const isCorrect = (option === item.correctAnswer) ? 'Yes' : 'No';
                csv += `Q${item.questionIndex},${option},${stat.count},${stat.percentage},${stat.avgAbility.toFixed(3)},${isCorrect}\n`;
            });
        });
        downloadCSV(csv, 'distractor_analysis.csv');
    };

    function downloadCSV(csvContent, filename) {
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // PDF Download Functions
    window.downloadSelectedClassPDF = async function() {
        const checkboxes = document.querySelectorAll('.class-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãÁè≠Á¥ö');
            return;
        }
        
        const selectedClasses = Array.from(checkboxes).map(cb => cb.value);
        const selectedStudents = analysisData.individualStats
            .map((student, index) => ({ student, index }))
            .filter(({ student }) => selectedClasses.includes(student.class));
        
        await generatePDFZip(selectedStudents, 'Â∑≤ÈÅ∏Áè≠Á¥ö');
    };

    window.downloadAllClassPDF = async function() {
        if (!analysisData) return;
        const allStudents = analysisData.individualStats.map((student, index) => ({ student, index }));
        await generatePDFZip(allStudents, 'ÂÖ®ÈÉ®Áè≠Á¥ö');
    };

    async function generatePDFZip(studentList, description) {
        const zip = new JSZip();
        
        const progressContainer = document.querySelector('#individualPdfProgressContainer');
        const progressFill = document.querySelector('#individualPdfProgressFill');
        const progressText = document.querySelector('#individualPdfProgressText');
        
        if (!progressContainer || !progressFill || !progressText) {
            console.error('Êâæ‰∏çÂà∞ÈÄ≤Â∫¶Ê¢ùÂÖÉÁ¥†');
            alert('Á≥ªÁµ±ÈåØË™§ÔºöÊâæ‰∏çÂà∞ÈÄ≤Â∫¶Ê¢ùÂÖÉÁ¥†');
            return;
        }
        
        progressContainer.style.display = 'block';
        progressFill.style.width = '0%';
        progressFill.textContent = '0%';
        progressText.textContent = 'Ê∫ñÂÇôÁîüÊàê PDF...';
        
        document.querySelectorAll('.download-btn').forEach(btn => btn.disabled = true);
        
        try {
            const classFolders = {};
            studentList.forEach(({ student, index }) => {
                const className = student.class;
                if (!classFolders[className]) {
                    classFolders[className] = [];
                }
                classFolders[className].push({ student, index });
            });
            
            const totalStudents = studentList.length;
            let processedCount = 0;
            
            for (const [className, students] of Object.entries(classFolders)) {
                for (const { student, index } of students) {
                    try {
                        progressText.textContent = `Ê≠£Âú®ÁîüÊàê ${student.class} - ${student.studentId} ${student.studentName} ÁöÑÂ†±Âëä... (${processedCount + 1}/${totalStudents})`;
                        
                        const pdfBlob = await generateStudentPDF(student, index);
                        
                        const fileName = `${student.class}_${student.studentId}_${student.studentName}.pdf`;
                        zip.folder(className).file(fileName, pdfBlob);
                        
                        processedCount++;
                        const progress = Math.round((processedCount / totalStudents) * 100);
                        progressFill.style.width = progress + '%';
                        progressFill.textContent = progress + '%';
                        
                        if (processedCount % 5 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        
                    } catch (error) {
                        console.error(`ÁîüÊàê ${student.studentId} ÁöÑ PDF ÊôÇÂá∫ÈåØ:`, error);
                    }
                }
            }
            
            progressText.textContent = 'Ê≠£Âú®Â£ìÁ∏ÆÊ™îÊ°à...';
            
            const zipBlob = await zip.generateAsync({ 
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            });
            
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(zipBlob);
            downloadLink.download = `KIDMAPË®∫Êñ∑Â†±Âëä_${description}_${new Date().toISOString().slice(0,10)}.zip`;
            downloadLink.click();
            
            alert(`ÊàêÂäüÁîüÊàê ${totalStudents} ‰ªΩ PDF Â†±Âëä‰∏¶‰∏ãËºâÔºÅ`);
            
        } catch (error) {
            console.error('PDF ÁîüÊàêÈåØË™§:', error);
            alert('PDF ÁîüÊàêÂ§±Êïó: ' + error.message);
        } finally {
            progressContainer.style.display = 'none';
            document.querySelectorAll('.download-btn').forEach(btn => btn.disabled = false);
        }
    }
    
    async function generateStudentPDF(student, studentIndex) {
        const { jsPDF } = window.jspdf;
        
        const responses = analysisData.responseMatrix[studentIndex];
        const items = analysisData.itemDifficulty;
        
        const itemAnalysis = items.map((difficulty, i) => {
            const prob = 1 / (1 + Math.exp(-(student.ability - difficulty)));
            const actual = responses[i];
            const expected = prob > 0.5 ? 1 : 0;
            const unexpected = (actual === 1 && expected === 0) || (actual === 0 && expected === 1);
            
            return {
                name: `Q${i + 1}`,
                difficulty: difficulty,
                actual: actual,
                expected: expected,
                probability: prob,
                unexpected: unexpected
            };
        });
        
        const page1HTML = generatePage1HTML(student, itemAnalysis);
        const page2HTML = generatePage2HTML(student, itemAnalysis);
        
        const pdfContainer = document.getElementById('pdfContainer');
        
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4',
            compress: true
        });
        
        pdfContainer.innerHTML = page1HTML;
        await new Promise(resolve => setTimeout(resolve, 300));
        
        const canvas1 = await html2canvas(pdfContainer.querySelector('.pdf-page-1'), {
            scale: 3,
            useCORS: true,
            logging: false,
            width: 794,
            windowWidth: 794
        });
        
        const imgData1 = canvas1.toDataURL('image/png', 1.0);
        pdf.addImage(imgData1, 'PNG', 0, 0, 210, 297, undefined, 'FAST');
        
        pdfContainer.innerHTML = page2HTML;
        await new Promise(resolve => setTimeout(resolve, 300));
        
        const canvas2 = await html2canvas(pdfContainer.querySelector('.pdf-page-2'), {
            scale: 3,
            useCORS: true,
            logging: false,
            width: 794,
            windowWidth: 794
        });
        
        const imgData2 = canvas2.toDataURL('image/png', 1.0);
        pdf.addPage();
        pdf.addImage(imgData2, 'PNG', 0, 0, 210, 297, undefined, 'FAST');
        
        return pdf.output('blob');
    }
    
    function generatePage1HTML(student, itemAnalysis) {
        const kidmapHTML = generateVisualKidmap(student, itemAnalysis, true);
        const diagnosticStats = generateDiagnosticStats(student, itemAnalysis);
        
        const basicInfoHTML = `
            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                <h2 style="color: #333; margin: 0 0 8px 0; font-size: 16px;">Âü∫Êú¨Ë≥áË®ä</h2>
                <div class="grid grid-cols-5 gap-4" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                    <div class="bg-white p-3 rounded-lg" style="background: white; padding: 8px; border-radius: 6px;"><div class="text-xs text-gray-600 mb-1" style="font-size: 9px; color: #666; margin-bottom: 3px;">Â≠∏Ëôü</div><div class="text-lg font-bold text-gray-800" style="font-size: 14px; font-weight: 700;">${student.studentId}</div></div>
                    <div class="bg-white p-3 rounded-lg" style="background: white; padding: 8px; border-radius: 6px;"><div class="text-xs text-gray-600 mb-1" style="font-size: 9px; color: #666; margin-bottom: 3px;">ÂßìÂêç</div><div class="text-lg font-bold text-gray-800" style="font-size: 14px; font-weight: 700;">${student.studentName}</div></div>
                    <div class="bg-white p-3 rounded-lg" style="background: white; padding: 8px; border-radius: 6px;"><div class="text-xs text-gray-600 mb-1" style="font-size: 9px; color: #666; margin-bottom: 3px;">Áè≠Á¥ö</div><div class="text-lg font-bold text-gray-800" style="font-size: 14px; font-weight: 700;">${student.class}</div></div>
                    <div class="bg-white p-3 rounded-lg" style="background: white; padding: 8px; border-radius: 6px;"><div class="text-xs text-gray-600 mb-1" style="font-size: 9px; color: #666; margin-bottom: 3px;">ËÉΩÂäõÂÄº (Œ∏)</div><div class="text-lg font-bold text-blue-600" style="font-size: 14px; font-weight: 700; color: #2563eb;">${student.ability.toFixed(3)}</div></div>
                    <div class="bg-white p-3 rounded-lg" style="background: white; padding: 8px; border-radius: 6px;"><div class="text-xs text-gray-600 mb-1" style="font-size: 9px; color: #666; margin-bottom: 3px;">ÂæóÂàÜ</div><div class="text-lg font-bold text-green-600" style="font-size: 14px; font-weight: 700; color: #16a34a;">${student.score}/${analysisData.nItems}</div></div>
                </div>
            </div>
        `;

        const feedbackHTML = `
            <div class="mt-6 p-4 bg-yellow-50 rounded-xl border-2 border-yellow-200" style="margin-top: 15px; padding: 10px; background: #fffbeb; border-radius: 8px; border: 2px solid #fef08a;">
                <h4 class="font-bold text-lg mb-3 text-yellow-800" style="font-weight: 700; font-size: 14px; margin-bottom: 8px; color: #b45309;">üìù ÊïôÂ≠∏Âª∫Ë≠∞</h4>
                <ul class="list-disc list-inside space-y-2 text-sm" style="list-style-type: disc; padding-left: 20px; font-size: 10px; line-height: 1.5;">
                    ${student.misconceptionCount > 0 ? `<li class="text-red-700" style="color: #b91c1c;"><strong>Ëø∑ÊÄùÊ¶ÇÂøµÈ°åÁõÆÔºà${student.misconceptionCount}È°åÔºâÔºö</strong>È°åËôü ${student.misconceptionItems.join(', ')} - Âª∫Ë≠∞Âä†Âº∑Âü∫Á§éËßÄÂøµË§áÁøí</li>` : ''}
                    ${student.advantageCount > 0 ? `<li class="text-blue-700" style="color: #1d4ed8;"><strong>ÂÑ™Âã¢Ê¶ÇÂøµÈ°åÁõÆÔºà${student.advantageCount}È°åÔºâÔºö</strong>È°åËôü ${student.advantageItems.join(', ')} - ÂèØÊåëÊà∞Êõ¥È´òÈõ£Â∫¶</li>` : ''}
                    ${student.reasonableCorrectCount > analysisData.nItems * 0.7 ? `<li class="text-green-700" style="color: #15803d;"><strong>Êï¥È´îË°®ÁèæÂÑ™Áï∞</strong> - Âª∫Ë≠∞ÈÄ≤Ë°åÂª∂‰º∏Â≠∏ÁøíËàáÊ∑±ÂåñÁêÜËß£</li>` : ''}
                    ${student.misconceptionCount === 0 && student.advantageCount === 0 ? '<li>Ë°®ÁèæÁ¨¶ÂêàÈ†êÊúüÔºåË´ãÁπºÁ∫å‰øùÊåÅ„ÄÇ</li>' : ''}
                </ul>
            </div>
        `;

        const mainStyles = document.querySelector('style').innerHTML;

        return `
            <div class="pdf-page pdf-page-1" style="font-family: 'Microsoft JhengHei', sans-serif; background: white; width: 210mm; height: 297mm; padding: 15mm; box-sizing: border-box; overflow: hidden;">
                <style>
                    ${mainStyles}
                    /* PDF-specific overrides */
                    .pdf-page-1 {
                        font-size: 10px;
                    }
                    .kidmap-visual { margin: 5px 0; border-width: 1px; }
                    .kidmap-header { padding: 8px; font-size: 1.1em; }
                    .kidmap-quadrants { min-height: 350px; }
                    .quadrant { padding: 5px; min-height: 80px; }
                    .quadrant-title { font-size: 1.1em; margin-bottom: 4px; padding-bottom: 3px; }
                    
                    .item-badge { 
                        padding: 2px 6px; 
                        font-size: 0.9em; 
                        margin: 2px; 
                        border-radius: 10px;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        min-height: 18px; 
                    }
                    .item-badge > * {
                        transform: none; 
                    }

                    .item-info { font-size: 0.8em; }
                    .kidmap-footer { padding: 6px; font-size: 0.9em; position: relative; z-index: 10; }
                    .kidmap-ability-line { z-index: 100 !important; }
                    .ability-label { top: 8px; padding: 3px 8px; font-size: 0.9em; z-index: 101 !important; }
                    .diagnostic-stats { gap: 5px; margin: 10px 0; }
                    .diag-card { padding: 5px 8px; }
                    .diag-label { font-size: 0.85em; margin-bottom: 2px; }
                    .diag-value { font-size: 1.3em; }
                </style>
                
                <div class="header-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; text-align: center; border-radius: 8px; margin-bottom: 10px;">
                    <h1 style="margin: 0; font-size: 20px;">KIDMAP Ë®∫Êñ∑Â†±Âëä - ${student.class} ${student.studentId} ${student.studentName}</h1>
                </div>
                
                ${basicInfoHTML}
                ${diagnosticStats}
                ${kidmapHTML}
                ${feedbackHTML}
                
                <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 6px; text-align: center; font-size: 8px; color: #666; position: absolute; bottom: 15mm; left: 15mm; right: 15mm;">
                    <p style="margin: 0;">Á¨¨ 1 È†ÅÔºåÂÖ± 2 È†Å | Â†±ÂëäÁîüÊàêÊôÇÈñì: ${new Date().toLocaleString('zh-TW')}</p>
                </div>
            </div>
        `;
    }
    
    function generatePage2HTML(student, itemAnalysis) {
        const itemAnalysisTable = generateItemAnalysisTable(itemAnalysis);
        const mainStyles = document.querySelector('style').innerHTML;

        return `
            <div class="pdf-page pdf-page-2" style="font-family: 'Microsoft JhengHei', sans-serif; background: white; width: 210mm; height: 297mm; padding: 15mm; box-sizing: border-box; overflow: hidden;">
                <style>
                    ${mainStyles}
                    /* PDF-specific overrides for page 2 */
                    .item-analysis-table {
                        font-size: 9px;
                        margin-top: 0;
                    }
                    .item-analysis-table th {
                        padding: 8px;
                    }
                    .item-analysis-table td {
                        padding: 6px 8px;
                    }
                    .badge {
                        padding: 2px 6px;
                        font-size: 0.9em;
                    }
                </style>
                
                <div class="header-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; text-align: center; border-radius: 8px; margin-bottom: 10px;">
                    <h2 style="margin: 0; font-size: 18px;">ÈÄêÈ°åÂàÜÊûê - ${student.class} ${student.studentId} ${student.studentName}</h2>
                </div>

                ${itemAnalysisTable}
                
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 8px; color: #666;">
                    <p style="margin: 0 0 5px 0;"><strong>Ë™™ÊòéÔºö</strong></p>
                    <p style="margin: 0;">‚Ä¢ <strong>Èõ£Â∫¶ÂÄº</strong>ÔºöÈ°åÁõÆÁöÑ Rasch Èõ£Â∫¶ÂèÉÊï∏ÔºåÊï∏ÂÄºË∂äÂ§ßË°®Á§∫È°åÁõÆË∂äÈõ£</p>
                    <p style="margin: 0;">‚Ä¢ <strong>‰ΩúÁ≠î</strong>ÔºöÂ≠∏ÁîüÂØ¶Èöõ‰ΩúÁ≠îÁµêÊûúÔºà‚úì Á≠îÂ∞ç / ‚úó Á≠îÈåØÔºâ</p>
                    <p style="margin: 0;">‚Ä¢ <strong>È†êÊúü</strong>ÔºöÂü∫ÊñºÂ≠∏ÁîüËÉΩÂäõÂÄºÈ†êÊúüÁöÑ‰ΩúÁ≠îÁµêÊûú</p>
                    <p style="margin: 0;">‚Ä¢ <strong>ÈÄöÈÅéÊ©üÁéá</strong>ÔºöÊ†πÊìö Rasch Ê®°ÂûãË®àÁÆóÁöÑÁ≠îÂ∞çÊ©üÁéá</p>
                    <p style="margin: 0;">‚Ä¢ <strong>‚ö† ÊÑèÂ§ñÂèçÊáâ</strong>ÔºöÂØ¶Èöõ‰ΩúÁ≠îËàáÈ†êÊúü‰∏çÁ¨¶ÔºåÈúÄÁâπÂà•ÈóúÊ≥®</p>
                </div>

                <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 6px; text-align: center; font-size: 8px; color: #666; position: absolute; bottom: 15mm; left: 15mm; right: 15mm;">
                    <p style="margin: 0;">Á¨¨ 2 È†ÅÔºåÂÖ± 2 È†Å | Â†±ÂëäÁîüÊàêÊôÇÈñì: ${new Date().toLocaleString('zh-TW')}</p>
                </div>
            </div>
        `;
    }
    
    function generateFeedback(student, itemAnalysis) {
        return ''; 
    }

    function chunk(arr, size) {
        const chunks = [];
        for (let i = 0; i < arr.length; i += size) {
            chunks.push(arr.slice(i, i + size));
        }
        return chunks;
    }

    function generatePdfPageWrapper(title, content, pageInfo = '') {
        return `
            <div style="padding: 6px; background-color: #fff; border-radius: 8px;">
                <div class="report-page-header" style="background: #f3f4f6; padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                    <h2 style="margin: 0; font-size: 16px; color: #1e3a8a;">${title}</h2>
                    ${pageInfo ? `<p style="margin: 5px 0 0 0; font-size: 11px; color: #4b5563;">${pageInfo}</p>` : ''}
                </div>
                ${content}
            </div>`;
    }

    function generateItemFitPageHTML(itemIndices, pageNum, totalPages) {
        let tableHtml = `<div class="overflow-x-auto"><table class="w-full text-sm bg-white" style="font-size: 9px;">
            <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <tr><th style="padding: 4px;">È°åËôü</th><th style="padding: 4px;">Èõ£Â∫¶ (Œ≤)</th><th style="padding: 4px;">SE</th><th style="padding: 4px;">Infit MNSQ</th><th style="padding: 4px;">Infit t</th><th style="padding: 4px;">Outfit MNSQ</th><th style="padding: 4px;">Outfit t</th><th style="padding: 4px;">Âà§Êñ∑</th></tr>
            </thead><tbody>`;
        itemIndices.forEach(i => {
            const { itemInfit, itemOutfit, itemDifficulty, itemSE, itemInfitT, itemOutfitT } = analysisData;
            const infit = itemInfit[i], outfit = itemOutfit[i], difficulty = itemDifficulty[i], se = itemSE[i], infitT = itemInfitT[i], outfitT = itemOutfitT[i];
            let status = 'üü¢ ËâØÂ•Ω', statusClass = 'background: #f0fdf4;';
            if (infit > 1.4 || outfit > 1.4 || infit < 0.6 || outfit < 0.6) { status = 'üî¥ ÈúÄÊ™¢Ë®é'; statusClass = 'background: #fef2f2;'; }
            else if ((infit > 1.3 && infit <= 1.4) || (outfit > 1.3 && outfit <= 1.4) || (infit >= 0.6 && infit < 0.7) || (outfit >= 0.6 && outfit < 0.7)) { status = 'üü° ÂèØÊé•Âèó'; statusClass = 'background: #fefce8;'; }
            tableHtml += `<tr style="border-bottom: 1px solid #e5e7eb; ${statusClass}"><td style="padding: 4px;">Q${i+1}</td><td style="padding: 4px;">${difficulty.toFixed(3)}</td><td style="padding: 4px;">${se.toFixed(3)}</td><td style="padding: 4px;">${infit.toFixed(3)}</td><td style="padding: 4px;">${infitT.toFixed(2)}</td><td style="padding: 4px;">${outfit.toFixed(3)}</td><td style="padding: 4px;">${outfitT.toFixed(2)}</td><td style="padding: 4px;">${status}</td></tr>`;
        });
        tableHtml += `</tbody></table></div>`;
        return generatePdfPageWrapper('üî¨ È°åÁõÆÈÅ©ÈÖçÂ∫¶ÂàÜÊûê', tableHtml, `Á¨¨ ${pageNum} È†Å / ÂÖ± ${totalPages} È†Å`);
    }

    function generateDiscriminationPageHTML(itemIndices, pageNum, totalPages) {
        let tableHtml = `<div class="overflow-x-auto"><table class="w-full text-sm bg-white" style="font-size: 9px;">
            <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <tr><th style="padding: 4px;">È°åËôü</th><th style="padding: 4px;">Èõ£Â∫¶ (Œ≤)</th><th style="padding: 4px;">ÈëëÂà•Â∫¶ (rpb)</th><th style="padding: 4px;">Á≠âÁ¥ö</th><th style="padding: 4px;">Âà§Êñ∑</th></tr>
            </thead><tbody>`;
        itemIndices.forEach(i => {
            const disc = analysisData.itemDiscrimination[i], difficulty = analysisData.itemDifficulty[i];
            let level = '', status = '', statusClass = '';
            if (disc < 0) { level = 'Âö¥ÈáçÂïèÈ°å'; status = 'üî¥üî¥ È°åÁõÆÊúâË™§'; statusClass = 'background: #fee2e2;'; }
            else if (disc < 0.1) { level = 'Ê•µÂ∑Æ'; status = 'üî¥ Âª∫Ë≠∞Âà™Èô§'; statusClass = 'background: #fef2f2;'; }
            else if (disc < 0.2) { level = '‰∏ç‰Ω≥'; status = 'üî¥ Áº∫‰πèÈëëÂà•Âäõ'; statusClass = 'background: #fff7ed;'; }
            else if (disc < 0.3) { level = 'Â∞öÂèØ'; status = 'üü° Âª∫Ë≠∞ÊîπÂñÑ'; statusClass = 'background: #fefce8;'; }
            else if (disc < 0.4) { level = 'ËâØÂ•Ω'; status = 'üü¢ ÂèØÊé•Âèó'; statusClass = 'background: #f0fdf4;'; }
            else { level = 'ÂÑ™ÁßÄ'; status = 'üü¢ ÈëëÂà•Âäõ‰Ω≥'; statusClass = 'background: #dcfce7;'; }
            tableHtml += `<tr style="border-bottom: 1px solid #e5e7eb; ${statusClass}"><td style="padding: 4px;">Q${i+1}</td><td style="padding: 4px;">${difficulty.toFixed(3)}</td><td style="padding: 4px;">${disc.toFixed(3)}</td><td style="padding: 4px;">${level}</td><td style="padding: 4px;">${status}</td></tr>`;
        });
        tableHtml += `</tbody></table></div>`;
        return generatePdfPageWrapper('üìà È°åÁõÆÈëëÂà•Â∫¶ÂàÜÊûê', tableHtml, `Á¨¨ ${pageNum} È†Å / ÂÖ± ${totalPages} È†Å`);
    }
    
    function generateClassStatsSummaryPageHTML() {
        const classes = Object.keys(analysisData.classStats);
        let tableHtml = `<div class="overflow-x-auto mb-6"><table class="w-full text-sm bg-white" style="font-size: 9px;">
            <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <tr><th style="padding: 4px;">Áè≠Á¥ö</th><th style="padding: 4px;">‰∫∫Êï∏</th><th style="padding: 4px;">ÂùáÂêàÁêÜÁ≠îÂ∞ç</th><th style="padding: 4px;">ÂùáÂêàÁêÜÁ≠îÈåØ</th><th style="padding: 4px;">ÂùáÂÑ™Âã¢‰ΩúÁ≠î</th><th style="padding: 4px;">ÂùáËø∑ÊÄùÊ¶ÇÂøµ</th><th style="padding: 4px;">Á∏ΩËø∑ÊÄùÊ¨°Êï∏</th></tr>
            </thead><tbody>`;
        classes.forEach(cls => {
            const stats = analysisData.classStats[cls];
            tableHtml += `<tr style="border-bottom: 1px solid #e5e7eb;"><td style="padding: 4px; font-weight: bold;">${cls}</td><td style="padding: 4px;">${stats.count}</td><td style="padding: 4px;">${stats.avgReasonableCorrect.toFixed(2)}</td><td style="padding: 4px;">${stats.avgReasonableWrong.toFixed(2)}</td><td style="padding: 4px;">${stats.avgAdvantage.toFixed(2)}</td><td style="padding: 4px;">${stats.avgMisconception.toFixed(2)}</td><td style="padding: 4px;">${stats.totalMisconception}</td></tr>`;
        });
        tableHtml += '</tbody></table></div>';
        return generatePdfPageWrapper('üìö Áè≠Á¥öÂõõÂêëÂ∫¶Áµ±Ë®àÊëòË¶Å', tableHtml, 'Á¨¨ 1 È†Å');
    }

    function generateClassStatsDetailPageHTML(classChunk, pageNum, totalPages) {
        let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">';
        html += '<div><h3 style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #dc2626;">üî¥ ÂêÑÁè≠Ëø∑ÊÄùÊ¶ÇÂøµÈ°åËôüÊéíË°å</h3>';
        classChunk.forEach(cls => {
            const items = analysisData.classMisconceptionItems[cls] || [];
            html += `<div style="background: white; padding: 8px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #fecaca;"><h4 style="font-weight: bold; margin-bottom: 5px; font-size: 12px;">${cls} Áè≠</h4>`;
            if (items.length === 0) { html += '<div style="font-size: 9px; color: #166534;">‚úÖ ÁÑ°Ëø∑ÊÄùÊ¶ÇÂøµÈ°åÁõÆ</div>'; }
            else {
                html += `<table style="width: 100%; font-size: 8px;"><thead style="background: #fee2e2;"><tr><th style="padding: 3px; text-align: left;">ÊéíÂêç</th><th style="padding: 3px; text-align: left;">È°åËôü</th><th style="padding: 3px; text-align: left;">‰∫∫Êï∏</th><th style="padding: 3px; text-align: left;">ÈåØË™§Áéá</th></tr></thead><tbody>`;
                items.slice(0, 10).forEach((item, idx) => { html += `<tr style="border-bottom: 1px solid #e5e7eb;"><td style="padding: 3px;">#${idx + 1}</td><td style="padding: 3px;">Q${item.itemNum}</td><td style="padding: 3px;">${item.count}</td><td style="padding: 3px;">${item.percentage}%</td></tr>`; });
                html += '</tbody></table>';
            }
            html += '</div>';
        });
        html += '</div>';

        html += '<div><h3 style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #ea580c;">üü† ÂêÑÁè≠ÂêàÁêÜÁ≠îÈåØÈ°åËôüÊéíË°å</h3>';
        classChunk.forEach(cls => {
            const items = analysisData.classReasonableWrongItems[cls] || [];
            html += `<div style="background: white; padding: 8px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ffedd5;"><h4 style="font-weight: bold; margin-bottom: 5px; font-size: 12px;">${cls} Áè≠</h4>`;
            if (items.length === 0) { html += '<div style="font-size: 9px; color: #166534;">‚úÖ ÁÑ°ÂêàÁêÜÁ≠îÈåØÈ°åÁõÆ</div>'; }
            else {
                html += `<table style="width: 100%; font-size: 8px;"><thead style="background: #ffedd5;"><tr><th style="padding: 3px; text-align: left;">ÊéíÂêç</th><th style="padding: 3px; text-align: left;">È°åËôü</th><th style="padding: 3px; text-align: left;">‰∫∫Êï∏</th><th style="padding: 3px; text-align: left;">ÈåØË™§Áéá</th></tr></thead><tbody>`;
                items.slice(0, 10).forEach((item, idx) => { html += `<tr style="border-bottom: 1px solid #e5e7eb;"><td style="padding: 3px;">#${idx + 1}</td><td style="padding: 3px;">Q${item.itemNum}</td><td style="padding: 3px;">${item.count}</td><td style="padding: 3px;">${item.percentage}%</td></tr>`; });
                html += '</tbody></table>';
            }
            html += '</div>';
        });
        html += '</div>';
        html += '</div>';
        return generatePdfPageWrapper('üìö Áè≠Á¥öËø∑ÊÄùËàáÂêàÁêÜÁ≠îÈåØÂàÜÊûê', html, `Á¨¨ ${pageNum} È†Å / ÂÖ± ${totalPages} È†Å`);
    }

    window.downloadFullReport = async function() {
        if (!analysisData) {
            alert('ÂàÜÊûêË≥áÊñôÂ∞öÊú™Ê∫ñÂÇôÂ∞±Á∑í');
            return;
        }

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4', true);

        const btn = document.getElementById('downloadReportBtn');
        const progressContainer = document.getElementById('reportProgressContainer');
        const progressFill = document.getElementById('reportProgressFill');
        const progressText = document.getElementById('reportProgressText');

        btn.disabled = true;
        progressContainer.style.display = 'block';

        const addHtmlToPdf = async (html, isFirstPageOfDoc, tabName = '') => {
            const pdfContainer = document.getElementById('pdfContainer');
            pdfContainer.innerHTML = `
                <style>
                    /* Common PDF Styles */
                    body { font-family: 'Microsoft JhengHei', sans-serif !important; }
                    .pdf-render-wrapper { width: 210mm; background: white; }
                    .pdf-render-content { padding: 15mm; box-sizing: border-box; }
                    /* Table specific styles */
                    table { width: 100%; word-break: break-word; font-size: 8px !important; border-collapse: collapse; }
                    th, td { padding: 4px 3px !important; border: 1px solid #ddd; }
                    thead th { background-color: #f3f4f6 !important; }
                    /* Hide elements not for PDF */
                    button, .tab-container, .download-section, [onclick] { display: none !important; }
                    .overflow-x-auto { overflow: visible !important; }
                    /* Ensure chart and images are rendered correctly */
                    .chart-container { display: block !important; height: 600px !important; width: 100%; }
                    img { max-width: 100% !important; height: auto !important; }
                </style>
                <div class="pdf-render-wrapper">
                    <div class="pdf-render-content">${html}</div>
                </div>`;
            await new Promise(resolve => setTimeout(resolve, 200));

            if (tabName === 'bubble') {
                try {
                    const canvasEl = pdfContainer.querySelector('#bubbleChartCanvas');
                    if (canvasEl) {
                       renderBubbleChart(analysisData, canvasEl);
                       await new Promise(resolve => setTimeout(resolve, 500));
                    }
                } catch(e) { console.error("Bubble chart render for PDF failed:", e); }
            }
            
            const pageElement = pdfContainer.querySelector('.pdf-render-wrapper');
            const canvas = await html2canvas(pageElement, { scale: 2, useCORS: true, logging: false });

            const imgData = canvas.toDataURL('image/jpeg', 0.92);
            const imgWidth = 210;
            const pageHeight = 297;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;
            
            if (!isFirstPageOfDoc) {
                pdf.addPage();
            }
            
            pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
            heightLeft -= pageHeight;
            
            while (heightLeft > 0) {
                position -= pageHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
                heightLeft -= pageHeight;
            }
        };
        
        const updateProgress = (done, total, text) => {
            progressText.textContent = `Ê≠£Âú®ËôïÁêÜ: ${text}...`;
            const percent = Math.round((done / total) * 100);
            progressFill.style.width = percent + '%';
            progressFill.textContent = percent + '%';
        };

        try {
            let isFirstPageOfDoc = true;
            
            const itemFitPages = Math.ceil(analysisData.nItems / 25);
            const discriminationPages = Math.ceil(analysisData.nItems / 25);
            const classDetailPages = Math.ceil(Object.keys(analysisData.classStats).length / 3);
            
            const tabsToProcess = [
                { name: 'summary', title: 'Á∏ΩË¶Ω', pages: 1 },
                { name: 'wrightmap', title: 'Wright Map', pages: 1 },
                { name: 'itemfit', title: 'È°åÁõÆÈÅ©ÈÖçÂ∫¶', pages: itemFitPages },
                { name: 'discrimination', title: 'È°åÁõÆÈëëÂà•Â∫¶', pages: discriminationPages },
                { name: 'bubble', title: 'Ê∞£Ê≥°ÂúñÂàÜÊûê', pages: 1 },
                { name: 'class', title: 'Áè≠Á¥öÁµ±Ë®à', pages: 1 + classDetailPages }
            ];

            const totalSteps = tabsToProcess.reduce((sum, tab) => sum + tab.pages, 0);
            let currentStep = 0;
            
            const processStep = async (title, action) => {
                updateProgress(++currentStep, totalSteps, title);
                await action();
                if (isFirstPageOfDoc) {
                    isFirstPageOfDoc = false;
                }
            };

            await processStep('Á∏ΩË¶Ω', async () => await addHtmlToPdf(createSummaryView(analysisData), isFirstPageOfDoc));
            await processStep('Wright Map', async () => await addHtmlToPdf(createWrightMapView(analysisData), isFirstPageOfDoc));

            const itemChunks = chunk([...Array(analysisData.nItems).keys()], 25);
            for (let i = 0; i < itemChunks.length; i++) {
                await processStep(`È°åÁõÆÈÅ©ÈÖçÂ∫¶ (${i+1}/${itemChunks.length})`, async () => await addHtmlToPdf(generateItemFitPageHTML(itemChunks[i], i + 1, itemChunks.length), isFirstPageOfDoc));
            }
            
            for (let i = 0; i < itemChunks.length; i++) {
                await processStep(`È°åÁõÆÈëëÂà•Â∫¶ (${i+1}/${itemChunks.length})`, async () => await addHtmlToPdf(generateDiscriminationPageHTML(itemChunks[i], i + 1, itemChunks.length), isFirstPageOfDoc));
            }

            await processStep('Ê∞£Ê≥°ÂúñÂàÜÊûê', async () => await addHtmlToPdf(createBubbleChartView(analysisData), isFirstPageOfDoc, 'bubble'));

            await processStep('Áè≠Á¥öÁµ±Ë®à (Á∏ΩË°®)', async () => await addHtmlToPdf(generateClassStatsSummaryPageHTML(), isFirstPageOfDoc));
            const classChunks = chunk(Object.keys(analysisData.classStats), 3);
            for (let i = 0; i < classChunks.length; i++) {
                await processStep(`Áè≠Á¥öÁµ±Ë®à (Ë©≥Á¥∞ ${i+1}/${classChunks.length})`, async () => await addHtmlToPdf(generateClassStatsDetailPageHTML(classChunks[i], i + 1, classChunks.length), false));
            }

            progressText.textContent = 'Ê≠£Âú®ÁîüÊàê PDF Ê™îÊ°à...';
            pdf.save(`[${fileName}]_ÂÆåÊï¥ÂàÜÊûêÂ†±Âëä.pdf`);

        } catch (error) {
            console.error('ÁîüÊàêÂÆåÊï¥ PDF Â†±ÂëäÊôÇÂá∫ÈåØ:', error);
            alert('ÁîüÊàê PDF Â§±ÊïóÔºö' + error.message);
        } finally {
            progressContainer.style.display = 'none';
            btn.disabled = false;
        }
    };

    initWebR();
    updateStepIndicator();
    renderStep1();
</script>
</body>
</html>
