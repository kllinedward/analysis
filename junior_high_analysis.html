<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>曉明女中數學科專業試題分析系統-國中版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff9800;
            animation: pulse 1.5s infinite;
            margin-right: 10px;
        }
        
        .status-indicator.ready {
            background: #4caf50;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 2px;
        }

        /* 這些是 high_school_analysis.html 的樣式，確保它們存在 */
        .advantage-badge { background: #2196f3; }
        .reasonable-correct-badge { background: #4caf50; }
        .reasonable-wrong-badge { background: #ff9800; }
        .misconception-badge { background: #f44336; }
        .good-badge { background: #4caf50; }
        .acceptable-badge { background: #ffc107; }
        .poor-badge { background: #f44336; }
        
        .misconception-highlight {
            /* 這是 high_school_analysis.html 的高亮樣式 */
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 20px;
            background: #e5e7eb;
            border: 2px solid #d1d5db;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .score-table {
            font-size: 0.9em;
            border-collapse: separate;
            border-spacing: 0;
        }

        .score-table thead {
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .score-table th {
            background: #1e40af !important;
            color: white !important;
            font-weight: bold;
            padding: 12px 8px !important;
            border: 1px solid #1e3a8a !important;
            text-align: center;
        }

        .score-table td.correct {
            background-color: #c8e6c9;
            color: #2e7d32;
            font-weight: 700;
            text-align: center;
        }

        .score-table td.incorrect {
            background-color: #ffcdd2;
            color: #c62828;
            font-weight: 700;
            text-align: center;
        }

        .score-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .score-table tbody tr:hover td.correct {
            background-color: #a5d6a7;
        }

        .score-table tbody tr:hover td.incorrect {
            background-color: #ef9a9a;
        }

        .sticky-col-class {
            position: sticky;
            left: 0;
            background: white !important;
            z-index: 15;
            border-right: 3px solid #1e40af !important;
            font-weight: 600;
        }

        .sticky-col-name {
            position: sticky;
            left: 100px;
            background: white !important;
            z-index: 15;
            border-right: 3px solid #1e40af !important;
            font-weight: 600;
        }

        .score-table thead th.sticky-col-class,
        .score-table thead th.sticky-col-name {
            background: #1e40af !important;
            z-index: 25;
        }

        .score-table tfoot td {
            background: #f3f4f6 !important;
            font-weight: 600;
            border: 1px solid #d1d5db !important;
            padding: 10px 8px;
        }

        .table-container {
            max-height: 600px;
            overflow: auto;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .error-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .header-container {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyMCIgaGVpZ2h0PSI0MDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJiZ0dyYWQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMxZTNhOGE7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSI1MCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMyNTYzZWI7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMzg5NWZmO3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjYmdHcmFkKSIvPjwvc3ZnPg==');
            background-size: cover;
            background-position: center;
            border-radius: 20px;
            padding: 60px 40px;
            box-shadow: 0 10px 40px rgba(30, 58, 138, 0.4);
            position: relative;
            overflow: hidden;
        }

        .header-with-image {
            background-image: url('./analysis-bg.png');
            background-size: cover;
            background-position: center left;
            background-repeat: no-repeat;
        }

        .header-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.85) 0%, rgba(37, 99, 235, 0.75) 50%, rgba(56, 149, 255, 0.65) 100%);
            z-index: 1;
        }

        .header-content {
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .school-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            letter-spacing: 4px;
            animation: fadeInDown 1s ease-out;
        }

        .system-title {
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(to right, #fbbf24, #f59e0b, #fde047);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(251, 191, 36, 0.6);
            margin-bottom: 10px;
            letter-spacing: 6px;
            animation: fadeInUp 1s ease-out 0.3s both;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hex-pattern {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0.1;
            z-index: 1;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 35px, rgba(255,255,255,0.1) 35px, rgba(255,255,255,0.1) 36px),
                repeating-linear-gradient(60deg, transparent, transparent 35px, rgba(255,255,255,0.1) 35px, rgba(255,255,255,0.1) 36px),
                repeating-linear-gradient(120deg, transparent, transparent 35px, rgba(255,255,255,0.1) 35px, rgba(255,255,255,0.1) 36px);
        }

        .kidmap-visual {
            background: white;
            border: 2px solid #333;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .kidmap-quadrants {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr 1fr auto;
            min-height: 400px;
            position: relative;
        }
        
        .kidmap-header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .kidmap-footer {
            grid-column: 1 / -1;
            background: #f8f9fa;
            padding: 12px;
            text-align: center;
            border-top: 2px solid #ddd;
            font-size: 0.85em;
            color: #666;
        }
        
        .quadrant {
            padding: 10px;
            border: 1px solid #ddd;
            position: relative;
            overflow-y: auto;
            min-height: 100px;
        }
        
        .quadrant-top-left {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-right: 2px solid #4CAF50;
            border-bottom: 2px solid #4CAF50;
        }
        
        .quadrant-top-right {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-bottom: 2px solid #FF9800;
        }
        
        .quadrant-bottom-left {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-right: 2px solid #2196F3;
        }
        
        .quadrant-bottom-right {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }
        
        .quadrant-title {
            font-weight: 700;
            font-size: 1em;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }
        
        /* 修正能力線樣式 */
        .ability-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
            z-index: 100;
            box-shadow: 0 0 10px rgba(245, 87, 108, 0.5);
            pointer-events: none;
        }
        
        .ability-label {
            position: absolute;
            right: 10px;
            top: -25px;
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        
        .item-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 3px;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.85em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            white-space: nowrap;
            vertical-align: middle;
        }
        
        .item-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .item-badge.correct {
            background: #4CAF50;
            color: white;
        }
        
        .item-badge.incorrect {
            background: #f44336;
            color: white;
        }
        
        .item-badge.unexpected {
            animation: pulse-kidmap 2s infinite;
            border: 2px solid #ff6b6b;
        }
        
        @keyframes pulse-kidmap {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
        }
        
        .item-info {
            display: inline;
            vertical-align: middle;
            font-size: 0.75em;
            opacity: 0.8;
            margin-left: 3px;
        }

        /* 逐題分析表格樣式 */
        .item-analysis-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }
        
        .item-analysis-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .item-analysis-table th {
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }
        
        .item-analysis-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .item-analysis-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .item-analysis-table .correct-cell {
            color: #4CAF50;
            font-weight: 700;
        }
        
        .item-analysis-table .incorrect-cell {
            color: #f44336;
            font-weight: 700;
        }
        
        .item-analysis-table .unexpected-cell {
            background: #fff3cd;
            font-weight: 700;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            max-width: 1200px;
            margin: 20px auto;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .modal-body {
            padding: 30px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .diagnostic-stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 10px 0;
        }
        
        .diag-card {
            background: white;
            padding: 8px 10px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            border-left: 3px solid #667eea;
        }
        
        .diag-card.warning {
            border-left-color: #FF9800;
            background: #fff8e1;
        }
        
        .diag-card.danger {
            border-left-color: #f44336;
            background: #ffebee;
        }
        
        .diag-card.success {
            border-left-color: #4CAF50;
            background: #e8f5e9;
        }
        
        .diag-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .diag-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #333;
            /* 減少數字上下可能有的預設間距 */
            line-height: 1.2; 
            margin-top: 2px;
            margin-bottom: 2px;
        }

        .student-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .download-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border: 2px solid #4facfe;
            border-radius: 15px;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        
        .download-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
        }
        
        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-container {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #4facfe;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }
        
        .progress-text {
            text-align: center;
            color: #666;
            font-size: 0.95em;
            margin-top: 10px;
        }

        /* PDF 專用樣式 - 修正為動態生成時的容器 */
        .pdf-container {
            position: fixed;
            left: -9999px;
            top: 0;
            width: 210mm; /* A4 width */
            background: white;
        }
        
        .pdf-page {
            width: 210mm;
            /* 修正：移除固定高度，允許內容自動延伸 */
            min-height: 297mm; /* A4 height */
            height: auto;
            padding: 15mm;
            background: white;
            page-break-after: always;
            box-sizing: border-box;
            /* 修正：確保 pdf-page 內部元素不會溢出 */
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <header class="header-container header-with-image mb-8">
            <div class="hex-pattern"></div>
            <div class="header-overlay"></div>
            <div class="header-content">
                <h1 class="school-title">曉明女中數學科（國中版）</h1>
                <h2 class="system-title">專業試題分析系統</h2>
            </div>
        </header>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <span class="status-indicator" id="statusIndicator"></span>
                    <strong>系統狀態:</strong>
                    <span id="statusText">正在初始化 WebR...</span>
                </div>
                <div class="text-sm text-gray-500" id="progressText">0%</div>
            </div>
            <div class="w-full h-2 bg-gray-200 rounded-full mt-3">
                <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all" id="progressBar" style="width: 0%"></div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center gap-4">
                <div class="flex-1 text-center" id="stepIndicator1">
                    <div class="w-12 h-12 mx-auto rounded-full bg-blue-500 text-white flex items-center justify-center font-bold mb-2">1</div>
                    <div class="text-sm font-semibold">上傳 & 設定答案</div>
                </div>
                <div class="flex-1 border-t-2 border-gray-300"></div>
                <div class="flex-1 text-center" id="stepIndicator2">
                    <div class="w-12 h-12 mx-auto rounded-full bg-gray-300 text-white flex items-center justify-center font-bold mb-2">2</div>
                    <div class="text-sm font-semibold">評分檢查</div>
                </div>
                <div class="flex-1 border-t-2 border-gray-300"></div>
                <div class="flex-1 text-center" id="stepIndicator3">
                    <div class="w-12 h-12 mx-auto rounded-full bg-gray-300 text-white flex items-center justify-center font-bold mb-2">3</div>
                    <div class="text-sm font-semibold">專業分析</div>
                </div>
            </div>
        </div>

        <div id="mainContent"></div>
    </div>

    <div class="modal" id="kidmapModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="kidmapModalTitle">KIDMAP 診斷報告</h2>
                <button class="close-btn" onclick="closeKidmapModal()">×</button>
            </div>
            <div class="modal-body" id="kidmapModalBody"></div>
        </div>
    </div>

    <!-- The #pdfContainer is removed as it's no longer needed for the fixed PDF generation process -->

    <script type="module">
        import { WebR } from 'https://webr.r-wasm.org/latest/webr.mjs';
        
        let webR;
        let isWebRReady = false;
        let currentStep = 1;
        let selectedEncoding = 'BIG5';
        let fileName = '';
        
        // --- 國中版 CSV 相關變數 ---
        let csvData = [];
        let standardAnswer = '';
        let standardAnswerSource = '';
        let totalQuestions = 0;
        let grids = []; // 將用於儲存簡化後的題目列表
        // --- End ---
        
        let scoringMatrix = null;
        let analysisData = null;


        async function initWebR() {
            try {
                updateWebRStatus('正在初始化 WebR...', 10);
                webR = new WebR();
                await webR.init();
                
                updateWebRStatus('正在安裝 MASS 套件...', 20);
                await webR.installPackages(['MASS']);
                
                updateWebRStatus('正在安裝 TAM 套件...（這可能需要幾分鐘）', 35);
                await webR.installPackages(['TAM']);
                
                updateWebRStatus('正在安裝 WrightMap 套件...', 55);
                await webR.installPackages(['WrightMap']);
                
                updateWebRStatus('正在載入套件...', 75);
                await webR.evalR('library(MASS)');
                await webR.evalR('library(TAM)');
                await webR.evalR('library(WrightMap)');
                
                updateWebRStatus('系統準備就緒！', 100, true);
                isWebRReady = true;
                
            } catch (error) {
                updateWebRStatus('初始化失敗：' + error.message, 0);
                console.error('WebR initialization error:', error);
            }
        }

        function updateWebRStatus(text, progress, ready = false) {
            document.getElementById('statusText').textContent = text;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '%';
            if (ready) {
                document.getElementById('statusIndicator').classList.add('ready');
            }
        }

        // --- 國中版 CSV 解析函式 ---
        function cleanCSVValue(value) {
            if (!value) return '';
            let cleaned = value.trim();
            if ((cleaned.startsWith('"') && cleaned.endsWith('"')) || 
                (cleaned.startsWith("'") && cleaned.endsWith("'"))) {
                cleaned = cleaned.slice(1, -1);
            }
            cleaned = cleaned.replace(/["""''']/g, '');
            return cleaned.trim();
        }

        function parseCSVLine(line) {
            const values = [];
            let currentValue = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentValue += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(cleanCSVValue(currentValue));
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }
            values.push(cleanCSVValue(currentValue));
            return values;
        }

        function findStandardAnswerFromStatus(status) {
            if (!status || status.length === 0) return false;
            
            let dotCount = 0;
            let equalCount = 0;
            let otherCount = 0;
            let firstEqualIndex = -1;
            
            for (let i = 0; i < status.length; i++) {
                if (status[i] === '.') {
                    dotCount++;
                } else if (status[i] === '=') {
                    if (firstEqualIndex === -1) firstEqualIndex = i;
                    equalCount++;
                } else {
                    otherCount++;
                }
            }
            
            if (otherCount > 0 || dotCount < 5 || equalCount < 1) {
                return false;
            }
            
            const beforeEqual = status.substring(0, firstEqualIndex);
            for (let char of beforeEqual) {
                if (char !== '.') return false;
            }
            
            const afterEqual = status.substring(firstEqualIndex);
            for (let char of afterEqual) {
                if (char !== '=') return false;
            }
            
            return true;
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            csvData = [];
            standardAnswer = '';
            standardAnswerSource = '';
            
            let headerIndex = -1;
            let headers = [];
            
            // 尋找標頭列
            for (let i = 0; i < Math.min(lines.length, 50); i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCSVLine(line);
                
                if (values.indexOf('學生答案') !== -1 || values.indexOf('作答情形') !== -1) {
                    headerIndex = i;
                    headers = values;
                    break;
                }
            }
            
            if (headerIndex === -1) {
                throw new Error('找不到學生資料標題列（需包含「學生答案」或「作答情形」欄位）');
            }
            
            const answerIndex = headers.indexOf('學生答案');
            const statusIndex = headers.indexOf('作答情形');
            const nameIndex = headers.indexOf('姓名');
            const seatIndex = headers.indexOf('座號');
            const studentIdIndex = headers.indexOf('學號'); // 增加學號

            // 嘗試尋找班級欄位
            let classIndex = headers.indexOf('班級簡稱');
            if (classIndex === -1) classIndex = headers.indexOf('班級');
            if (classIndex === -1) classIndex = headers.indexOf('班級代號');
            if (classIndex === -1) classIndex = headers.indexOf('班級名稱');
            if (classIndex === -1) classIndex = headers.indexOf('CLASS');

            for (let i = headerIndex + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || line.startsWith(',,,')) continue;
                
                const values = parseCSVLine(line);
                if (values.length < headers.length) continue;
                
                const name = cleanCSVValue(values[nameIndex] || '');
                const answer = cleanCSVValue(values[answerIndex] || '');
                const status = cleanCSVValue(values[statusIndex] || '');
                const seat = cleanCSVValue(values[seatIndex] || '');
                const classValue = (classIndex !== -1) ? cleanCSVValue(values[classIndex] || '') : '';
                
                if (!name && !answer) continue;
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = cleanCSVValue(values[index] || '');
                });
                
                // 統一班級欄位
                if (classIndex !== -1) {
                    row['班級'] = classValue;
                }
                
                // 確保學號欄位存在
                if (studentIdIndex === -1) {
                    row['學號'] = cleanCSVValue(values[seatIndex] || ''); // 若無學號，暫用座號
                }
                
                if (name) {
                    csvData.push(row);
                }
                
                // 尋找標準答案
                if (!standardAnswer && status && findStandardAnswerFromStatus(status)) {
                    // 修正：移除標準答案後面的 '=' 填充符號，以獲得正確的題數
                    const trimmedAnswer = answer.replace(/=+$/, ''); 
                    standardAnswer = trimmedAnswer;
                    totalQuestions = trimmedAnswer.length; // 修正 totalQuestions 為實際題數
                    standardAnswerSource = `${name}（座號 ${seat}）`;
                }
            }
            
            if (!standardAnswer && csvData.length > 0) {
                const firstAnswer = csvData[0]['學生答案'] || '';
                totalQuestions = firstAnswer.length;
            }
        }
        // --- End 國中版 CSV 解析 ---


        window.handleFile = function(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    parseCSV(text); // 使用新的國中版 parseCSV
                    fileName = file.name;
                    renderStep1(); // 重新渲染步驟 1 以顯示檔案資訊
                } catch (error) {
                    alert('檔案解析失敗：' + error.message);
                    console.error('Parse error:', error);
                }
            };
            
            if (selectedEncoding === 'BIG5') {
                reader.readAsText(file, 'Big5');
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        };

        // --- 簡化的計分邏輯 ---

        // 取得題目列表 (自動將所有題目視為單選)
        function getQuestionsList() {
            // 'grids' 在 processAndProceedToScoring 中被建立
            return grids.map((grid, index) => ({
                type: 'single',
                typeName: '單選',
                grids: [index], // grids 陣列中的索引
                originalIndices: [grid.originalIndex] // 原始答案字串中的索引
            }));
        }

        // 解碼答案 (僅 A-D)
        function decodeAnswer(code) {
            if (!code || code === '=' || code === '?' || code === '.') return code;
            if (code >= 'A' && code <= 'D') return code; // 國中版僅 A-D
            return ''; // 其他視為無效
        }

        // 計分 (簡化為單選比對)
        function scoreAnswer(studentCode, correctCode, questionType) {
            const studentAns = decodeAnswer(studentCode);
            const correctAns = decodeAnswer(correctCode);
            
            if (!studentAns || studentAns === '?' || studentAns === '.') return 0;
            if (!correctAns || correctAns === '') return 0;
            
            return studentAns === correctAns ? 1 : 0;
        }

        // --- 流程控制函式 ---

        // 步驟 1 確認答案後觸發
        function processAndProceedToScoring(isManual = false) {
            if (isManual) {
                // 從手動輸入框獲取答案
                const input = document.getElementById('manualAnswer');
                if (!input) return;
                const answer = cleanCSVValue(input.value).toUpperCase();
                
                if (!answer) {
                    alert('請輸入標準答案');
                    return;
                }
                if (!/^[A-D]+$/.test(answer)) {
                    alert('答案只能包含 A、B、C、D');
                    return;
                }
                if (answer.length !== totalQuestions) {
                    // 如果自動偵測的 totalQuestions (可能來自 firstAnswer) 是錯的 (e.g., 100)
                    // 而使用者輸入了正確的 (e.g., 30)，這裡會提示
                    if (!confirm(`您輸入了 ${answer.length} 題答案，但系統偵測到 ${totalQuestions} 題。\n\n是否要調整題數為 ${answer.length}？`)) {
                        return;
                    }
                    totalQuestions = answer.length; // 修正題數
                }
                standardAnswer = answer;
                standardAnswerSource = '手動輸入';
            }

            if (!standardAnswer) {
                alert('沒有標準答案，無法繼續');
                return;
            }

            // 自動建立 'grids' 陣列，全部設為單選
            grids = [];
            // 這裡的 standardAnswer.length 已經被修正為正確的題數 (e.g., 30)
            for (let i = 0; i < standardAnswer.length; i++) {
                grids.push({
                    number: i + 1,
                    answer: standardAnswer[i],
                    type: 'single',
                    groupId: null,
                    originalIndex: i
                });
            }
            
            // 立即呼叫計分
            generateScoringMatrix();
        }
        // *** 修正：將函式附加到 window 物件 ***
        window.processAndProceedToScoring = processAndProceedToScoring;

        // 產生計分矩陣 (已簡化)
        window.generateScoringMatrix = function() {
            const questions = getQuestionsList(); // 取得簡化的單選題列表 (e.g., 30 題)
            
            if (questions.length === 0) {
                alert('找不到題目，請檢查標準答案設定');
                return;
            }

            const matrix = csvData.map((student) => {
                const studentAnswer = student['學生答案'] || ''; // e.g., "ABCD....====" (100 chars)
                
                return questions.map((q) => {
                    // 移除選填題邏輯
                    const originalIdx = q.originalIndices[0]; // 0 to 29
                    const studentCode = studentAnswer[originalIdx] || ''; // 會正確取 0-29
                    const correctCode = standardAnswer[originalIdx] || ''; // 會正確取 0-29
                    return scoreAnswer(studentCode, correctCode, 'single');
                });
            });

            const studentTotals = matrix.map(row => row.reduce((a, b) => a + b, 0));
            const questionTotals = questions.map((_, qIdx) => 
                matrix.reduce((sum, row) => sum + row[qIdx], 0)
            );

            scoringMatrix = {
                matrix,
                students: csvData,
                questions,
                studentTotals,
                questionTotals
            };
            
            currentStep = 2; // 步驟 2 現在是評分檢查
            updateStepIndicator();
            renderStep2ScoringMatrix(); // 呼叫評分矩陣渲染
        };

        // 呼叫 Rasch 分析
        window.proceedToRaschAnalysis = function() {
            currentStep = 3; // 步驟 3 是專業分析
            updateStepIndicator();
            renderStep3Loading(); // 顯示讀取畫面
            performRaschAnalysis();
        };

        // --- 核心分析函式 (保持不變) ---
        // Rasch 分析、KIDMAP、四向度等皆基於 0/1 矩陣，故無需修改
        async function performRaschAnalysis() {
            if (!isWebRReady) {
                alert('WebR 尚未準備就緒，請稍候再試');
                return;
            }

            if (!scoringMatrix) {
                alert('沒有資料可分析');
                return;
            }

            try {
                let csvText = 'CLASS,StudentID,StudentName';
                for (let i = 0; i < scoringMatrix.questions.length; i++) {
                    csvText += ',Q' + (i + 1);
                }
                csvText += '\n';

                scoringMatrix.matrix.forEach((row, idx) => {
                    const student = scoringMatrix.students[idx];
                    const className = student['班級'] || '';
                    const studentId = student['學號'] || ''; // 使用 '學號'
                    const studentName = student['姓名'] || '';
                    csvText += className + ',' + studentId + ',' + studentName;
                    row.forEach(score => {
                        csvText += ',' + score;
                    });
                    csvText += '\n';
                });

                await webR.objs.globalEnv.bind('csv_text', csvText);

                await webR.evalR(`
                    data_text <- csv_text
                    con <- textConnection(data_text)
                    fulldata <- read.csv(con, header = TRUE)
                    close(con)
                    
                    class_info <- fulldata$CLASS
                    student_ids <- fulldata$StudentID
                    student_names <- fulldata$StudentName
                    
                    respdata <- fulldata[, -(1:3)]
                    respdata[] <- lapply(respdata, as.numeric)
                    
                    row_sums <- rowSums(respdata, na.rm = TRUE)
                    col_vars <- apply(respdata, 2, var, na.rm = TRUE)
                    
                    # 修正：根據使用者要求，僅移除零分學生，保留滿分學生
                    # 註： row_sums > 0 會排除 0 分
                    # 註： row_sums <= ncol(respdata) 永遠成立
                    # 註： 原本為: which(row_sums > 0 & row_sums < ncol(respdata))
                    valid_row_indices <- which(row_sums > 0)
                    
                    # 移除作答變異為 0 的題目 (全對或全錯)
                    valid_col_indices <- which(col_vars > 0)
                    
                    if (length(valid_row_indices) == 0 || length(valid_col_indices) == 0) {
                        stop("沒有足夠的有效作答資料進行分析 (學生或題目可能全對或全錯)")
                    }

                    respdata_clean <- respdata[valid_row_indices, valid_col_indices]
                    class_info_clean <- class_info[valid_row_indices]
                    student_ids_clean <- student_ids[valid_row_indices]
                    student_names_clean <- student_names[valid_row_indices]
                    
                    mod <- TAM::tam.mml(respdata_clean, verbose = FALSE)
                    fit <- TAM::tam.fit(mod)
                    person_params <- TAM::tam.wle(mod)
                    reliability <- mod$EAP.rel
                    
                    total_scores <- rowSums(respdata_clean)
                    
                    # 計算鑑別度 (Point-Biserial Correlation)
                    item_discrimination_clean <- sapply(1:ncol(respdata_clean), function(i) {
                        # 檢查變異數
                        if (var(respdata_clean[,i], na.rm = TRUE) == 0) {
                            return(NA) # 如果變異數為 0，cor 會是 NA
                        }
                        cor(respdata_clean[,i], total_scores, use = "complete.obs")
                    })
                    
                    # --- 將結果映射回原始題數 ---
                    n_original_items <- ncol(respdata)
                    
                    item_difficulty_full <- rep(NA, n_original_items)
                    item_difficulty_full[valid_col_indices] <- mod$xsi$xsi
                    
                    item_se_full <- rep(NA, n_original_items)
                    item_se_full[valid_col_indices] <- mod$xsi$se.xsi
                    
                    item_infit_full <- rep(NA, n_original_items)
                    item_infit_full[valid_col_indices] <- fit$itemfit$Infit
                    
                    item_outfit_full <- rep(NA, n_original_items)
                    item_outfit_full[valid_col_indices] <- fit$itemfit$Outfit
                    
                    item_infit_t_full <- rep(NA, n_original_items)
                    item_infit_t_full[valid_col_indices] <- fit$itemfit$Infit_t
                    
                    item_outfit_t_full <- rep(NA, n_original_items)
                    item_outfit_t_full[valid_col_indices] <- fit$itemfit$Outfit_t
                    
                    item_discrimination_full <- rep(NA, n_original_items)
                    item_discrimination_full[valid_col_indices] <- item_discrimination_clean

                    # --- 重新計算所有學生的能力 (WLE/EAP) ---
                    # TAM 似乎沒有直接提供估算原始被移除學生的能力
                    # 我們將只回傳成功分析的學生
                    
                    # --- 重新計算所有學生的原始作答矩陣 (僅限有效題目) ---
                    # 這太複雜了，我們將使用 respdata_clean 搭配 clean 的學生列表
                    # 但 KIDMAP 需要原始的 0/1 矩陣
                    # 所以我們回傳 respdata[valid_row_indices, ] (原始題目，有效學生)
                    # 這樣 KIDMAP 才能對應到所有題目
                    
                    respdata_kidmap <- respdata[valid_row_indices, ]
                    
                    
                    # --- 圖表繪製 (僅使用有效資料) ---
                    png(filename = "/tmp/wrightmap.png", width = 1200, height = 800, res = 120)
                    WrightMap::wrightMap(
                        person_params$theta, 
                        mod$xsi$xsi,
                        label.items = paste0("Q", valid_col_indices), # 只標記有效題號
                        main.title = "Wright Map - Person Ability vs Item Difficulty (Cleaned Data)",
                        axis.persons = "Person Ability (θ)",
                        axis.items = "Item Difficulty (β)"
                    )
                    dev.off()
                    
                    png(filename = "/tmp/ability_dist.png", width = 800, height = 600, res = 100)
                    hist(person_params$theta, breaks = 20, col = "lightblue", border = "white",
                         main = "Student Ability Distribution (Cleaned Data)", xlab = "Ability (θ)", ylab = "Frequency")
                    dev.off()
                    
                    png(filename = "/tmp/difficulty_dist.png", width = 800, height = 600, res = 100)
                    hist(mod$xsi$xsi, breaks = 10, col = "lightcoral", border = "white",
                         main = "Item Difficulty Distribution (Cleaned Data)", xlab = "Difficulty (β)", ylab = "Frequency")
                    dev.off()
                `);

                // const nItems = (await (await webR.evalR('ncol(respdata_clean)')).toJs()).values[0]; // 這是 clean 的
                const nOriginalItems = (await (await webR.evalR('ncol(respdata)')).toJs()).values[0];
                const nCleanPersons = (await (await webR.evalR('nrow(respdata_clean)')).toJs()).values[0];
                
                // 使用 _full 陣列
                const itemDifficulty = (await (await webR.evalR('as.numeric(item_difficulty_full)')).toJs()).values;
                const itemSE = (await (await webR.evalR('as.numeric(item_se_full)')).toJs()).values;
                const itemInfit = (await (await webR.evalR('as.numeric(item_infit_full)')).toJs()).values;
                const itemOutfit = (await (await webR.evalR('as.numeric(item_outfit_full)')).toJs()).values;
                const itemInfitT = (await (await webR.evalR('as.numeric(item_infit_t_full)')).toJs()).values;
                const itemOutfitT = (await (await webR.evalR('as.numeric(item_outfit_t_full)')).toJs()).values;
                const itemDiscrimination = (await (await webR.evalR('as.numeric(item_discrimination_full)')).toJs()).values;

                // 學生資料 (僅限 clean)
                const personAbility = (await (await webR.evalR('as.numeric(person_params$theta)')).toJs()).values;
                const personSE = (await (await webR.evalR('as.numeric(person_params$error)')).toJs()).values;
                const personScores = (await (await webR.evalR('rowSums(respdata_clean)')).toJs()).values; // 這是 clean 的分數
                
                const classInfo = (await (await webR.evalR('as.character(class_info_clean)')).toJs()).values;
                const studentIds = (await (await webR.evalR('as.character(student_ids_clean)')).toJs()).values;
                const studentNames = (await (await webR.evalR('as.character(student_names_clean)')).toJs()).values;

                const reliability = (await (await webR.evalR('as.numeric(reliability)')).toJs()).values[0];

                // 獲取 KIDMAP 用的作答矩陣 (nCleanPersons x nOriginalItems)
                const responseMatrix = [];
                for (let i = 0; i < nCleanPersons; i++) {
                    const row = (await (await webR.evalR(`as.numeric(respdata_kidmap[${i+1},])`)).toJs()).values;
                    responseMatrix.push(row);
                }

                const wrightmapFile = await webR.FS.readFile('/tmp/wrightmap.png');
                const wrightmapBlob = new Blob([wrightmapFile], { type: 'image/png' });
                const wrightmapUrl = URL.createObjectURL(wrightmapBlob);

                const abilityDistFile = await webR.FS.readFile('/tmp/ability_dist.png');
                const abilityDistBlob = new Blob([abilityDistFile], { type: 'image/png' });
                const abilityDistUrl = URL.createObjectURL(abilityDistBlob);

                const difficultyDistFile = await webR.FS.readFile('/tmp/difficulty_dist.png');
                const difficultyDistBlob = new Blob([difficultyDistFile], { type: 'image/png' });
                const difficultyDistUrl = URL.createObjectURL(difficultyDistBlob);

                analysisData = {
                    nItems: nOriginalItems, // 總題數
                    nPersons: nCleanPersons, // 分析人數
                    itemDifficulty, itemSE, itemInfit, itemOutfit, 
                    itemInfitT, itemOutfitT, itemDiscrimination, 
                    personAbility, personSE, personScores, 
                    classInfo, studentIds, studentNames, 
                    responseMatrix, // nCleanPersons x nOriginalItems
                    reliability,
                    wrightmapUrl, abilityDistUrl, difficultyDistUrl
                };

                calculateFourCategories(analysisData);
                calculateDistractorAnalysis(analysisData);
                calculateClassStatistics(analysisData);
                renderStep3Results(analysisData); // 渲染最終結果

            } catch (error) {
                alert('分析過程發生錯誤：' + error.message);
                console.error('Analysis error:', error);
                // 發生錯誤時退回步驟 2
                currentStep = 2;
                updateStepIndicator();
                renderStep2ScoringMatrix();
            }
        }

        // --- 分析資料處理 (保持不變) ---
        function calculateFourCategories(data) {
            const individualStats = [];
            
            for (let i = 0; i < data.nPersons; i++) {
                const ability = data.personAbility[i];
                const responses = data.responseMatrix[i]; // 這裡是 nOriginalItems 的長度
                
                let reasonableCorrect = [], reasonableWrong = [], advantage = [], misconception = [];
                
                for (let j = 0; j < data.nItems; j++) { // 遍歷所有原始題目
                    const difficulty = data.itemDifficulty[j];
                    const response = responses[j];
                    
                    // 如果難度 (difficulty) 是 NA (因為題目被排除了)，跳過此題
                    if (typeof difficulty !== 'number' || isNaN(difficulty)) {
                        continue;
                    }
                    
                    if (ability > difficulty) {
                        if (response === 1) reasonableCorrect.push(j + 1);
                        else misconception.push(j + 1);
                    } else {
                        if (response === 0) reasonableWrong.push(j + 1);
                        else advantage.push(j + 1);
                    }
                }
                
                // 重新計算總分 (基於所有原始題目的作答)
                const totalScoreOriginal = responses.reduce((a, b) => (typeof b === 'number' ? a + b : a), 0);

                individualStats.push({
                    index: i, 
                    class: data.classInfo[i], 
                    studentId: data.studentIds[i],
                    studentName: data.studentNames[i],
                    ability, 
                    score: totalScoreOriginal, // 使用原始總分
                    reasonableCorrectCount: reasonableCorrect.length, 
                    reasonableCorrectItems: reasonableCorrect,
                    reasonableWrongCount: reasonableWrong.length, 
                    reasonableWrongItems: reasonableWrong,
                    advantageCount: advantage.length, 
                    advantageItems: advantage,
                    misconceptionCount: misconception.length, 
                    misconceptionItems: misconception
                });
            }
            
            data.individualStats = individualStats;
        }

        function calculateClassStatistics(data) {
            const classes = [...new Set(data.classInfo)];
            const classStats = {};
            const classMisconceptionItems = {};
            const classReasonableWrongItems = {};
            
            classes.forEach(cls => {
                const classStudents = data.individualStats.filter(s => s.class === cls);
                
                classStats[cls] = {
                    count: classStudents.length,
                    avgReasonableCorrect: classStudents.reduce((sum, s) => sum + s.reasonableCorrectCount, 0) / classStudents.length,
                    avgReasonableWrong: classStudents.reduce((sum, s) => sum + s.reasonableWrongCount, 0) / classStudents.length,
                    avgAdvantage: classStudents.reduce((sum, s) => sum + s.advantageCount, 0) / classStudents.length,
                    avgMisconception: classStudents.reduce((sum, s) => sum + s.misconceptionCount, 0) / classStudents.length,
                    totalReasonableCorrect: classStudents.reduce((sum, s) => sum + s.reasonableCorrectCount, 0),
                    totalReasonableWrong: classStudents.reduce((sum, s) => sum + s.reasonableWrongCount, 0),
                    totalAdvantage: classStudents.reduce((sum, s) => sum + s.advantageCount, 0),
                    totalMisconception: classStudents.reduce((sum, s) => sum + s.misconceptionCount, 0)
                };
                
                const itemMisconceptionCount = {};
                classStudents.forEach(student => {
                    student.misconceptionItems.forEach(itemNum => {
                        itemMisconceptionCount[itemNum] = (itemMisconceptionCount[itemNum] || 0) + 1;
                    });
                });
                
                classMisconceptionItems[cls] = Object.entries(itemMisconceptionCount)
                    .map(([itemNum, count]) => ({
                        itemNum: parseInt(itemNum), 
                        count,
                        percentage: (count / classStudents.length * 100).toFixed(1)
                    }))
                    .sort((a, b) => b.count - a.count);
                
                const itemReasonableWrongCount = {};
                classStudents.forEach(student => {
                    student.reasonableWrongItems.forEach(itemNum => {
                        itemReasonableWrongCount[itemNum] = (itemReasonableWrongCount[itemNum] || 0) + 1;
                    });
                });
                
                classReasonableWrongItems[cls] = Object.entries(itemReasonableWrongCount)
                    .map(([itemNum, count]) => ({
                        itemNum: parseInt(itemNum), 
                        count,
                        percentage: (count / classStudents.length * 100).toFixed(1)
                    }))
                    .sort((a, b) => b.count - a.count);
            });
            
            data.classStats = classStats;
            data.classMisconceptionItems = classMisconceptionItems;
            data.classReasonableWrongItems = classReasonableWrongItems;
        }

        // 誘答分析 (基於簡化的 decodeAnswer)
        function calculateDistractorAnalysis(data) {
            const questions = scoringMatrix.questions;
            const distractorStats = [];
            
            for (let qIdx = 0; qIdx < questions.length; qIdx++) {
                const question = questions[qIdx];
                const originalIdx = question.originalIndices[0];
                const correctAnswer = decodeAnswer(standardAnswer[originalIdx]);
                const optionStats = {};
                
                csvData.forEach((student) => {
                    // 確保只分析已納入 Rasch 模型的學生
                    // 修正：使用 '學號'
                    const validIdx = data.studentIds.indexOf(student['學號'] || '');
                    if (validIdx === -1) {
                        // 如果學號找不到，嘗試用姓名和班級備援 (較不保險)
                        const fallbackIdx = data.individualStats.findIndex(s => s.studentName === student['姓名'] && s.class === student['班級']);
                        if (fallbackIdx === -1) return;
                    }
                    
                    const studentAnswer = student['學生答案'] || '';
                    const studentChoice = decodeAnswer(studentAnswer[originalIdx]); // 僅 A-D
                    
                    if (!studentChoice || studentChoice === '?' || studentChoice === '.') return;
                    
                    if (!optionStats[studentChoice]) {
                        optionStats[studentChoice] = { count: 0, abilitySum: 0, abilities: [] };
                    }
                    
                    const abilityIndex = validIdx !== -1 ? validIdx : data.individualStats.findIndex(s => s.studentName === student['姓名'] && s.class === student['班級']);
                    if (abilityIndex === -1) return;

                    optionStats[studentChoice].count++;
                    optionStats[studentChoice].abilitySum += data.personAbility[abilityIndex];
                    optionStats[studentChoice].abilities.push(data.personAbility[abilityIndex]);
                });
                
                Object.keys(optionStats).forEach(option => {
                    const stat = optionStats[option];
                    if (stat.count > 0) {
                        stat.avgAbility = stat.abilitySum / stat.count;
                        stat.percentage = (stat.count / data.nPersons * 100).toFixed(1);
                    } else {
                        stat.avgAbility = NaN;
                        stat.percentage = "0.0";
                    }
                });
                
                distractorStats.push({
                    questionIndex: qIdx + 1, correctAnswer, options: optionStats, totalResponses: data.nPersons
                });
            }
            
            data.distractorStats = distractorStats;
        }

        // --- 介面渲染函式 ---

        // 更新步驟指示器 (3 步驟版)
        function updateStepIndicator() {
            const totalSteps = 3;
            for (let i = 1; i <= totalSteps; i++) {
                const indicator = document.getElementById(`stepIndicator${i}`);
                if (!indicator) continue;
                const circle = indicator.querySelector('div:first-child');
                
                if (i < currentStep) {
                    circle.className = 'w-12 h-12 mx-auto rounded-full bg-green-500 text-white flex items-center justify-center font-bold mb-2';
                } else if (i === currentStep) {
                    circle.className = 'w-12 h-12 mx-auto rounded-full bg-blue-500 text-white flex items-center justify-center font-bold mb-2';
                } else {
                    circle.className = 'w-12 h-12 mx-auto rounded-full bg-gray-300 text-white flex items-center justify-center font-bold mb-2';
                }
            }
        }
        // *** 修正：將函式附加到 window 物件 ***
        window.updateStepIndicator = updateStepIndicator;

        // 渲染步驟 1 (上傳 & 答案設定)
        function renderStep1() {
            const content = document.getElementById('mainContent');
            
            // 手動輸入 HTML
            let manualInputHTML = `
                <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200 mt-6">
                    <div class="font-semibold text-yellow-800 mb-3">⚠️ 未偵測到標準答案，請手動輸入：</div>
                    <input type="text" id="manualAnswer" placeholder="請輸入 ${totalQuestions} 個字元的標準答案 (A-D)" class="w-full p-3 border-2 border-yellow-300 rounded-lg font-mono text-lg mb-3">
                    <button onclick="processAndProceedToScoring(true)" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white py-4 rounded-xl text-xl font-bold hover:shadow-2xl transition-all transform hover:scale-105">
                        確認手動答案並開始分析 →
                    </button>
                </div>
            `;
            
            // 自動偵測 HTML
            let autoAnswerHTML = `
                <div class="p-4 bg-white rounded-lg mb-4">
                    <div class="font-semibold text-green-700 mb-2">✓ 已自動偵測標準答案：</div>
                    <div class="font-mono text-lg bg-gray-100 p-3 rounded" style="word-break: break-all;">${standardAnswer}</div>
                    <div class="text-sm text-gray-600 mt-2">來源：${standardAnswerSource}</div>
                </div>
                <button onclick="processAndProceedToScoring(false)" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-4 rounded-xl text-xl font-bold hover:shadow-2xl transition-all transform hover:scale-105">
                    確認答案並開始分析 →
                </button>
            `;

            // 步驟 1 主體
            content.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-3xl font-bold mb-6 text-blue-600 flex items-center gap-3">📤 步驟 1：上傳 CSV & 設定答案</h2>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold mb-2 text-gray-700">選擇檔案編碼：</label>
                        <div class="flex gap-4">
                            <button onclick="selectedEncoding='BIG5'; document.getElementById('encodingDisplay').innerText='BIG5';" class="${selectedEncoding === 'BIG5' ? 'bg-blue-500 text-white shadow-lg scale-105' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} px-6 py-3 rounded-lg font-semibold transition-all">BIG5</button>
                            <button onclick="selectedEncoding='UTF-8'; document.getElementById('encodingDisplay').innerText='UTF-8';" class="${selectedEncoding === 'UTF-8' ? 'bg-blue-500 text-white shadow-lg scale-105' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} px-6 py-3 rounded-lg font-semibold transition-all">UTF-8</button>
                            <span class="ml-4 self-center text-gray-600">目前選擇: <strong id="encodingDisplay">${selectedEncoding}</strong></span>
                        </div>
                    </div>
                    <div class="border-4 border-dashed border-blue-300 rounded-xl p-12 text-center bg-blue-50 hover:bg-blue-100 transition-all">
                        <input type="file" id="fileInput" accept=".csv" class="hidden" onchange="handleFile(this.files[0])">
                        <button onclick="document.getElementById('fileInput').click()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-4 rounded-xl text-lg font-bold hover:shadow-2xl transition-all transform hover:scale-105">📁 選擇 CSV 檔案</button>
                    </div>
                    ${csvData.length > 0 ? `
                        <div class="mt-8 p-6 bg-green-50 rounded-xl border-2 border-green-200">
                            <h3 class="text-xl font-bold text-green-700 mb-4">✓ 檔案載入成功！</h3>
                            <div class="grid grid-cols-3 gap-4 text-sm mb-4">
                                <div><span class="font-semibold">檔案名稱：</span><span class="text-blue-600 font-bold ml-2">${fileName}</span></div>
                                <div><span class="font-semibold">學生人數：</span><span class="text-blue-600 font-bold ml-2">${csvData.length}</span></div>
                                <div><span class="font-semibold">答案格數：</span><span class="text-blue-600 font-bold ml-2">${totalQuestions}</span></div>
                            </div>
                            ${standardAnswer ? autoAnswerHTML : manualInputHTML}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        // *** 修正：將函式附加到 window 物件 ***
        window.renderStep1 = renderStep1;
        
        // 渲染步驟 2 (評分矩陣)
        function renderStep2ScoringMatrix() {
            const content = document.getElementById('mainContent');
            
            let html = `
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-3xl font-bold mb-6 text-green-600 flex items-center gap-3">
                        ✓ 步驟 2：評分結果檢查（0與1表）
                    </h2>
                    
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="font-semibold">學生人數：</span>
                                <span class="text-blue-600 font-bold ml-2">${csvData.length}</span>
                            </div>
                            <div>
                                <span class="font-semibold">題目數量：</span>
                                <span class="text-blue-600 font-bold ml-2">${scoringMatrix.questions.length}</span>
                            </div>
                            <div>
                                <span class="font-semibold">總分：</span>
                                <span class="text-blue-600 font-bold ml-2">${scoringMatrix.questions.length}</span>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="score-table w-full">
                            <thead>
                                <tr>
                                    <th class="sticky-col-class" style="min-width: 100px;">班級</th>
                                    <th class="sticky-col-name" style="min-width: 100px;">姓名</th>
                                    ${scoringMatrix.questions.map((q, idx) => {
                                        const qNum = idx + 1;
                                        return `<th style="min-width: 60px;">
                                            Q${qNum}<br>
                                            <span style="font-size: 0.75em;">(單選)</span>
                                        </th>`;
                                    }).join('')}
                                    <th style="min-width: 70px; background: #ca8a04 !important;">總分</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            scoringMatrix.matrix.forEach((row, idx) => {
                const student = scoringMatrix.students[idx];
                const total = scoringMatrix.studentTotals[idx];
                const className = student['班級'] || '';
                const studentName = student['姓名'] || '';
                
                html += `<tr>
                    <td class="sticky-col-class" style="padding: 8px; text-align: left;">${className}</td>
                    <td class="sticky-col-name" style="padding: 8px; text-align: left;">${studentName}</td>`;
                
                row.forEach(score => {
                    html += `<td class="${score === 1 ? 'correct' : 'incorrect'}" style="padding: 8px;">${score}</td>`;
                });
                
                html += `<td style="padding: 8px; background: #fef3c7 !important; font-weight: 700; text-align: center;">${total}</td>
                </tr>`;
            });
            
            html += `
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2" style="text-align: center; font-weight: 700;">答對人數</td>
                                    ${scoringMatrix.questionTotals.map(total => 
                                        `<td style="text-align: center;">${total}</td>`
                                    ).join('')}
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button onclick="currentStep=1; updateStepIndicator(); renderStep1();" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600">
                            ← 返回上一步
                        </button>
                        <button onclick="downloadScoringMatrix()" class="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600">
                            📥 下載評分表
                        </button>
                        <button onclick="proceedToRaschAnalysis()" class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-xl text-xl font-bold hover:shadow-2xl transition-all transform hover:scale-105">
                            下一步：開始專業分析 →
                        </button>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }

        // 渲染步驟 3 (讀取中)
        function renderStep3Loading() {
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mx-auto mb-4"></div>
                    <h2 class="text-2xl font-bold text-gray-700 mb-2">正在執行專業分析...</h2>
                    <p class="text-gray-500">Rasch 模型估計 | 適配度檢定 | 鑑別度計算 | 誘答分析 | 四向度診斷</p>
                    <p class="text-sm text-red-500 mt-4">（若題目或學生全對/全錯，將被排除以確保模型收斂）</p>
                </div>
            `;
        }

        // 渲染步驟 3 (分析結果)
        function renderStep3Results(data) {
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-3xl font-bold mb-6 text-green-600">✅ 步驟 3：專業試題分析完成！</h2>
                    <div class="tab-container">
                        <button class="tab active" onclick="switchTab(event, 'summary')">📊 總覽</button>
                        <button class="tab" onclick="switchTab(event, 'wrightmap')">🗺️ Wright Map</button>
                        <button class="tab" onclick="switchTab(event, 'itemfit')">🔬 題目適配度</button>
                        <button class="tab" onclick="switchTab(event, 'discrimination')">📈 題目鑑別度</button>
                        <button class="tab" onclick="switchTab(event, 'bubble')">🫧 氣泡圖分析</button>
                        <button class="tab" onclick="switchTab(event, 'distractor')">🎯 誘答分析</button>
                        <button class="tab" onclick="switchTab(event, 'individual')">👥 個人四向度</button>
                        <button class="tab" onclick="switchTab(event, 'class')">📚 班級統計</button>
                    </div>
                    <div id="tab-summary" class="tab-content active">${createSummaryView(data)}</div>
                    <div id="tab-wrightmap" class="tab-content">${createWrightMapView(data)}</div>
                    <div id="tab-itemfit" class="tab-content">${createItemFitView(data)}</div>
                    <div id="tab-discrimination" class="tab-content">${createDiscriminationView(data)}</div>
                    <div id="tab-bubble" class="tab-content">${createBubbleChartView(data)}</div>
                    <div id="tab-distractor" class="tab-content">${createDistractorView(data)}</div>
                    <div id="tab-individual" class="tab-content">${createIndividualTable(data)}</div>
                    <div id="tab-class" class="tab-content">${createClassStats(data)}</div>
                    <button onclick="location.reload()" class="mt-6 bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-600">🔄 重新開始</button>
                </div>
            `;
            setupFilters();
        }

        // --- 渲染分析結果的輔助函式 ---

        function createSummaryView(data) {
            return `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-6 text-gray-800">📊 分析總覽與信度統計</h3>
                <div class="warning-box mb-4">
                    <strong>注意：</strong>為確保 Rasch 模型收斂，分析已自動排除全對/全錯的題目，以及 0 分的學生。
                    因此，以下「受測人數」可能小於原始上傳人數。
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg"><div class="text-sm text-blue-600 font-semibold">分析受測人數</div><div class="text-3xl font-bold text-blue-800">${data.nPersons}</div></div>
                    <div class="bg-green-100 p-4 rounded-lg"><div class="text-sm text-green-600 font-semibold">原始題目數量</div><div class="text-3xl font-bold text-green-800">${data.nItems}</div></div>
                    <div class="bg-purple-100 p-4 rounded-lg"><div class="text-sm text-purple-600 font-semibold">平均能力值</div><div class="text-3xl font-bold text-purple-800">${(data.personAbility.reduce((a,b)=>a+b,0)/data.nPersons).toFixed(3)}</div></div>
                    <div class="bg-orange-100 p-4 rounded-lg"><div class="text-sm text-orange-600 font-semibold">EAP 信度</div><div class="text-3xl font-bold text-orange-800">${data.reliability.toFixed(3)}</div></div>
                </div>
                <div class="info-box mb-6">
                    <h4 class="font-bold mb-2">📌 信度判斷標準：</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>α ≥ 0.9</strong>：優秀（Excellent）</li>
                        <li><strong>0.8 ≤ α < 0.9</strong>：良好（Good）</li>
                        <li><strong>0.7 ≤ α < 0.8</strong>：尚可（Acceptable）</li>
                        <li><strong>0.6 ≤ α < 0.7</strong>：可疑（Questionable）</li>
                        <li><strong>α < 0.6</strong>：不佳（Poor），建議增加題數或改善題目</li>
                    </ul>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg"><h4 class="font-bold mb-2 text-center">學生能力分布</h4><img src="${data.abilityDistUrl}" class="w-full"></div>
                    <div class="bg-white p-4 rounded-lg"><h4 class="font-bold mb-2 text-center">題目難度分布</h4><img src="${data.difficultyDistUrl}" class="w-full"></div>
                </div>

                <!-- 完整報告下載區塊 -->
                <div class="download-section mt-6">
                    <h4 class="text-xl font-bold mb-4 text-blue-800">🖨️ 完整報告下載</h4>
                    <p class="text-gray-600 mb-4">將「總覽」至「班級統計」的所有分析頁面匯出為一份 PDF 檔案。</p>
                    <button id="downloadReportBtn" onclick="downloadFullReport()" class="download-btn">
                        下載完整分析報告 (PDF)
                    </button>
                    
                    <!-- 總報告下載進度條 -->
                    <div id="reportProgressContainer" class="progress-container" style="display: none;">
                        <div id="reportProgressText" class="progress-text" style="text-align: center; margin-bottom: 10px; font-weight: 600; color: #4facfe;">
                            準備生成 PDF...
                        </div>
                        <div class="progress-bar" style="width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden;">
                            <div id="reportProgressFill" class="progress-fill" style="height: 100%; width: 0%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                                0%
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function createWrightMapView(data) {
            return `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">🗺️ Wright Map - 受測者能力與題目難度分布圖</h3>
                <div class="info-box mb-4">
                    <p class="font-semibold mb-2">圖表說明：</p>
                    <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                        <li><strong>左側</strong>：受測者能力分布（每個 X 代表一位受測者）</li>
                        <li><strong>右側</strong>：題目難度分布（顯示題號）</li>
                        <li><strong>相同高度</strong>：表示能力值或難度值相近</li>
                        <li><strong>解讀</strong>：受測者位置高於題目 → 能力 > 難度 → 預期答對</li>
                        <li><strong>解讀</strong>：受測者位置低於題目 → 能力 < 難度 → 預期答錯</li>
                        <li><strong>注意</strong>：本地圖僅顯示經模型分析後「有效」的題目與學生。</li>
                    </ul>
                </div>
                <div class="bg-white p-4 rounded-lg"><img src="${data.wrightmapUrl}" class="max-w-full h-auto mx-auto"></div>
            </div>`;
        }

        function createItemFitView(data) {
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">🔬 題目適配度分析（Infit / Outfit）</h3>
                <div class="info-box mb-4">
                    <h4 class="font-bold mb-2">📌 適配度判斷標準：</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>0.7 ≤ MNSQ ≤ 1.3</strong>：🟢 良好（題目符合 Rasch 模型）</li>
                        <li><strong>0.6 ≤ MNSQ < 0.7 或 1.3 < MNSQ ≤ 1.4</strong>：🟡 可接受</li>
                        <li><strong>MNSQ < 0.6 或 MNSQ > 1.4</strong>：🔴 需檢討</li>
                        <li><strong>N/A</strong>：⚠️ 題目因全對/全錯被排除，無法計算</li>
                    </ul>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-sm bg-white">
                    <thead class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                        <tr><th class="p-3 text-left">題號</th><th class="p-3 text-left">難度 (β)</th><th class="p-3 text-left">SE</th><th class="p-3 text-left">Infit MNSQ</th><th class="p-3 text-left">Infit t</th><th class="p-3 text-left">Outfit MNSQ</th><th class="p-3 text-left">Outfit t</th><th class="p-3 text-left">判斷</th></tr>
                    </thead><tbody>`;
            
            for (let i = 0; i < data.nItems; i++) {
                const infit = data.itemInfit[i], outfit = data.itemOutfit[i];
                const difficulty = data.itemDifficulty[i], se = data.itemSE[i];
                const infitT = data.itemInfitT[i], outfitT = data.itemOutfitT[i];

                const isValid = (infit != null && typeof infit === 'number' && !isNaN(infit));
                
                let status = '🟢 良好', statusClass = 'bg-green-100';
                let diffText = 'N/A', seText = 'N/A', infitText = 'N/A', infitTText = 'N/A', outfitText = 'N/A', outfitTText = 'N/A';

                if (isValid) {
                    diffText = difficulty.toFixed(3);
                    seText = se.toFixed(3);
                    infitText = infit.toFixed(3);
                    infitTText = infitT.toFixed(2);
                    outfitText = outfit.toFixed(3);
                    outfitTText = outfitT.toFixed(2);

                    if (infit > 1.4 || outfit > 1.4 || infit < 0.6 || outfit < 0.6) {
                        status = '🔴 需檢討'; statusClass = 'bg-red-100';
                    } else if ((infit > 1.3 && infit <= 1.4) || (outfit > 1.3 && outfit <= 1.4) || (infit >= 0.6 && infit < 0.7) || (outfit >= 0.6 && outfit < 0.7)) {
                        status = '🟡 可接受'; statusClass = 'bg-yellow-100';
                    }
                } else {
                    status = '⚠️ 無法計算'; statusClass = 'bg-gray-100';
                }

                html += `<tr class="border-b hover:bg-gray-50 ${statusClass}">
                    <td class="p-3 font-semibold">Q${i+1}</td>
                    <td class="p-3">${diffText}</td><td class="p-3">${seText}</td>
                    <td class="p-3 ${isValid && (infit > 1.3 || infit < 0.7) ? 'font-bold text-red-600' : ''}">${infitText}</td>
                    <td class="p-3">${infitTText}</td>
                    <td class="p-3 ${isValid && (outfit > 1.3 || outfit < 0.7) ? 'font-bold text-red-600' : ''}">${outfitText}</td>
                    <td class="p-3">${outfitTText}</td>
                    <td class="p-3">${status}</td></tr>`;
            }
            html += `</tbody></table></div>
                <button class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600" onclick="downloadItemFit()">📥 匯出適配度統計</button>
            </div>`;
            return html;
        }

        function createDiscriminationView(data) {
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">📈 題目鑑別度分析（Point-Biserial Correlation）</h3>
                <div class="info-box mb-4">
                    <h4 class="font-bold mb-2">📌 鑑別度判斷標準：</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>rpb ≥ 0.4</strong>：🟢 優秀</li><li><strong>0.3 ≤ rpb < 0.4</strong>：🟢 良好</li><li><strong>0.2 ≤ rpb < 0.3</strong>：🟡 尚可</li><li><strong>rpb < 0.2</strong>：🔴 不佳</li>
                        <li><strong>N/A</strong>：⚠️ 題目因全對/全錯被排除，無法計算</li>
                    </ul>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-sm bg-white">
                    <thead class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                        <tr><th class="p-3 text-left">題號</th><th class="p-3 text-left">難度 (β)</th><th class="p-3 text-left">鑑別度 (rpb)</th><th class="p-3 text-left">等級</th><th class="p-3 text-left">判斷</th></tr>
                    </thead><tbody>`;
            
            for (let i = 0; i < data.nItems; i++) {
                const disc = data.itemDiscrimination[i];
                const difficulty = data.itemDifficulty[i];

                const discIsValid = disc != null && typeof disc === 'number' && !isNaN(disc);
                const diffIsValid = difficulty != null && typeof difficulty === 'number' && !isNaN(difficulty);
                
                const difficultyText = diffIsValid ? difficulty.toFixed(3) : 'N/A';
                const discText = discIsValid ? disc.toFixed(3) : 'N/A';
                
                let level = '', status = '', statusClass = '';
                
                if (discIsValid) {
                    if (disc < 0) { level = '嚴重問題'; status = '🔴🔴 題目有誤'; statusClass = 'bg-red-200'; }
                    else if (disc < 0.1) { level = '極差'; status = '🔴 建議刪除'; statusClass = 'bg-red-100'; }
                    else if (disc < 0.2) { level = '不佳'; status = '🔴 缺乏鑑別力'; statusClass = 'bg-orange-100'; }
                    else if (disc < 0.3) { level = '尚可'; status = '🟡 建議改善'; statusClass = 'bg-yellow-100'; }
                    else if (disc < 0.4) { level = '良好'; status = '🟢 可接受'; statusClass = 'bg-green-100'; }
                    else { level = '優秀'; status = '🟢 鑑別力佳'; statusClass = 'bg-green-200'; }
                } else {
                    level = '無法計算';
                    status = '⚠️ (e.g., 全對或全錯)';
                    statusClass = 'bg-gray-100';
                }
                
                const discClass = discIsValid ? (disc < 0.2 ? 'font-bold text-red-600' : disc >= 0.4 ? 'font-bold text-green-600' : '') : 'text-gray-500';
                
                html += `<tr class="border-b hover:bg-gray-50 ${statusClass}">
                    <td class="p-3 font-semibold">Q${i+1}</td>
                    <td class="p-3">${difficultyText}</td>
                    <td class="p-3 ${discClass}">${discText}</td>
                    <td class="p-3">${level}</td><td class="p-3">${status}</td></tr>`;
            }
            html += `</tbody></table></div>
                <button class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600" onclick="downloadDiscrimination()">📥 匯出鑑別度統計</button>
            </div>`;
            return html;
        }

        function createBubbleChartView(data) {
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">🫧 題目品質氣泡圖</h3>
                <div class="info-box mb-4">
                    <h4 class="font-bold mb-2">📌 氣泡圖說明：</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>X軸</strong>：難度值（Rasch β）</li><li><strong>Y軸</strong>：鑑別度（rpb）</li><li><strong>氣泡大小</strong>：標準誤（SE）</li><li><strong>顏色</strong>：綠色=優良、橘色=尚可、紅色=需改進</li>
                        <li><strong>注意</strong>：僅顯示可計算的題目（排除全對/全錯）</li>
                    </ul>
                </div>
                <div class="bg-white p-4 rounded-lg mb-4 chart-container"><canvas id="bubbleChartCanvas"></canvas></div>`;
            
            const anomalies = [];
            for (let i = 0; i < data.nItems; i++) {
                const discIsValid = data.itemDiscrimination[i] != null && typeof data.itemDiscrimination[i] === 'number' && !isNaN(data.itemDiscrimination[i]);
                const fitIsValid = data.itemInfit[i] != null && typeof data.itemInfit[i] === 'number' && !isNaN(data.itemInfit[i]);
                const seIsValid = data.itemSE[i] != null && typeof data.itemSE[i] === 'number' && !isNaN(data.itemSE[i]);

                if (!discIsValid && !fitIsValid && !seIsValid) continue; // 跳過 N/A 題目

                const issues = [];
                if (discIsValid && data.itemDiscrimination[i] < 0.2) issues.push('鑑別度過低');
                if (fitIsValid && (data.itemInfit[i] > 1.4 || data.itemOutfit[i] > 1.4)) issues.push('適配度不良');
                if (seIsValid && data.itemSE[i] > 0.5) issues.push('測量誤差大');
                
                if (issues.length > 0) anomalies.push({ itemNum: i + 1, issues });
            }
            
            if (anomalies.length > 0) {
                html += '<div class="error-box"><h4 class="font-bold mb-2">⚠️ 異常題目警示：</h4><table class="w-full text-sm"><thead><tr><th class="p-2 text-left">題號</th><th class="p-2 text-left">問題</th></tr></thead><tbody>';
                anomalies.forEach(a => {
                    html += `<tr class="border-b"><td class="p-2">Q${a.itemNum}</td><td class="p-2">${a.issues.map(issue => `<span class="badge poor-badge">${issue}</span>`).join(' ')}</td></tr>`;
                });
                html += '</tbody></table></div>';
            } else {
                html += '<div class="info-box">✅ 所有可分析題目品質良好</div>';
            }
            html += '</div>';
            
            setTimeout(() => {
                const canvas = document.querySelector('#tab-bubble #bubbleChartCanvas');
                if (canvas) {
                    renderBubbleChart(data, canvas);
                }
            }, 100);

            return html;
        }

        function renderBubbleChart(data, canvasElement) {
            if (!canvasElement) return;
            
            // Destroy existing chart instance if it exists, to prevent memory leaks and rendering issues
            let existingChart = Chart.getChart(canvasElement);
            if (existingChart) {
                existingChart.destroy();
            }

            const bubbleData = [];
            for (let i = 0; i < data.nItems; i++) {
                const difficulty = data.itemDifficulty[i];
                const discrimination = data.itemDiscrimination[i];
                const se = data.itemSE[i];

                const discIsValid = discrimination != null && typeof discrimination === 'number' && !isNaN(discrimination);
                const diffIsValid = difficulty != null && typeof difficulty === 'number' && !isNaN(difficulty);
                const seIsValid = se != null && typeof se === 'number' && !isNaN(se);

                if (discIsValid && diffIsValid && seIsValid) {
                    let color = (discrimination >= 0.3 && se < 0.3) ? 'rgba(34, 197, 94, 0.7)' : 
                               (discrimination >= 0.2 && se < 0.4) ? 'rgba(251, 146, 60, 0.7)' : 'rgba(239, 68, 68, 0.7)';
                    
                    bubbleData.push({ 
                        x: difficulty, 
                        y: discrimination, 
                        r: se * 50 + 2, 
                        label: `Q${i+1}`, 
                        backgroundColor: color 
                    });
                }
            }
            
            new Chart(canvasElement, {
                type: 'bubble',
                data: {
                    datasets: bubbleData.map(d => ({
                        label: d.label,
                        data: [{ x: d.x, y: d.y, r: d.r }],
                        backgroundColor: d.backgroundColor
                    }))
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { title: { display: true, text: '難度值 β (logit)' } }, y: { title: { display: true, text: '鑑別度 rpb' }, min: 0 } },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const xVal = context.parsed.x?.toFixed(3) ?? 'N/A';
                                    const yVal = context.parsed.y?.toFixed(3) ?? 'N/A';
                                    const rVal = context.parsed.r ? ((context.parsed.r - 2) / 50).toFixed(3) : 'N/A';
                                    return [`題號: ${context.dataset.label}`, `難度: ${xVal}`, `鑑別度: ${yVal}`, `標準誤: ${rVal}`];
                                }
                            }
                        }
                    },
                    animation: {
                        // Disable animation for PDF rendering to ensure canvas is complete
                        duration: 0
                    }
                }
            });
        }
        
        function createDistractorView(data) {
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">🎯 誘答選項分析</h3>
                <div class="info-box mb-4">
                    <h4 class="font-bold mb-2">📌 誘答選項品質判斷：</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>有效誘答</strong>：🟢 低能力學生選擇</li><li><strong>需檢討誘答</strong>：🟡 中高能力學生選擇</li><li><strong>無效誘答</strong>：🔴 幾乎沒人選擇（比例 < 5%）</li><li><strong>混淆選項</strong>：🔴🔴 高能力學生選擇比例高</li>
                    </ul>
                </div>`;
            
            if (!data.distractorStats || data.distractorStats.length === 0) {
                html += '<div class="warning-box">⚠️ 無法進行誘答分析（可能是選填題或資料不足）</div></div>';
                return html;
            }
            
            data.distractorStats.forEach(item => {
                html += `<div class="bg-white p-4 rounded-lg mb-4"><h4 class="font-bold mb-3 text-lg">Q${item.questionIndex} 選項分析</h4>`;
                const options = Object.keys(item.options).sort();
                
                if (options.length === 0) {
                    html += '<div class="text-gray-500">無有效作答資料</div>';
                } else {
                    html += '<table class="w-full text-sm"><thead class="bg-gray-200"><tr><th class="p-2 text-left">選項</th><th class="p-2 text-left">選擇人數</th><th class="p-2 text-left">比例</th><th class="p-2 text-left">平均能力值</th><th class="p-2 text-left">判斷</th></tr></thead><tbody>';
                    const correctOption = item.correctAnswer;
                    
                    const correctOptionStat = item.options[correctOption];
                    const correctAvgAbility = (correctOptionStat && correctOptionStat.count > 0 && correctOptionStat.avgAbility != null && !isNaN(correctOptionStat.avgAbility)) ? correctOptionStat.avgAbility : 0;
                    
                    options.forEach(option => {
                        const stat = item.options[option];
                        const isCorrect = (option === correctOption);
                        const percentage = parseFloat(stat.percentage);
                        const avgAbility = stat.avgAbility;
                        let judgment = '', rowClass = '';
                        
                        const avgAbilityText = (avgAbility != null && typeof avgAbility === 'number' && !isNaN(avgAbility)) ? avgAbility.toFixed(3) : 'N/A';

                        if (isCorrect) { judgment = '✓ 正確答案'; rowClass = 'bg-green-50 font-semibold'; }
                        else {
                            if (percentage < 5) { judgment = '🔴 無效誘答'; rowClass = 'bg-red-50'; }
                            else if (avgAbilityText !== 'N/A' && avgAbility >= correctAvgAbility - 0.2 && correctAvgAbility != 0) { judgment = '🔴🔴 混淆選項'; rowClass = 'bg-red-100'; }
                            else if (avgAbilityText !== 'N/A' && avgAbility >= correctAvgAbility - 0.5 && correctAvgAbility != 0) { judgment = '🟡 需檢討'; rowClass = 'bg-yellow-50'; }
                            else if (avgAbilityText !== 'N/A') { judgment = '🟢 有效誘答'; rowClass = 'bg-gray-50'; }
                            else { judgment = 'N/A'; rowClass = 'bg-gray-50'; } // avgAbility 為 N/A
                        }
                        html += `<tr class="${rowClass}"><td class="p-2">${option}${isCorrect ? ' ★' : ''}</td><td class="p-2">${stat.count}</td><td class="p-2">${stat.percentage}%</td><td class="p-2">${avgAbilityText}</td><td class="p-2">${judgment}</td></tr>`;
                    });
                    html += '</tbody></table>';
                }
                html += '</div>';
            });
            html += '<button class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600" onclick="downloadDistractor()">📥 匯出誘答分析</button></div>';
            return html;
        }

        function createIndividualTable(data) {
            const classes = [...new Set(data.classInfo)];
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">👥 個人四向度答題分析（含 KIDMAP 診斷）</h3>
                <div class="warning-box mb-4">
                    <strong>注意：</strong>此處顯示的學生為成功納入 Rasch 模型分析者 (已排除 0 分者)。
                </div>
                <div class="flex gap-4 mb-4 items-end flex-wrap">
                    <div><label class="block text-sm font-semibold mb-1">班級篩選：</label>
                        <select id="classFilter" class="p-2 border-2 rounded-lg"><option value="all">全部班級</option>`;
            classes.forEach(cls => { html += `<option value="${cls}">${cls}</option>`; });
            html += `</select></div>
                    <div><label class="block text-sm font-semibold mb-1">排序方式：</label>
                        <select id="sortFilter" class="p-2 border-2 rounded-lg">
                            <option value="misconception">依「迷思概念」多寡</option>
                            <option value="ability">依「能力值」高低</option>
                            <option value="advantage">依「優勢作答」多寡</option>
                            <option value="score">依「原始總分」高低</option>
                        </select>
                    </div>
                    <button onclick="applyFilters()" class="bg-blue-500 text-white px-5 py-2 rounded-lg font-semibold h-11 hover:bg-blue-600">篩選</button>
                    <button onclick="downloadStudentReports()" class="bg-purple-500 text-white px-5 py-2 rounded-lg font-semibold h-11 hover:bg-purple-600">
                        🖨️ 產生全班KIDMAP (ZIP)
                    </button>
                </div>
                <div id="downloadProgressContainer" class="progress-container" style="display: none;">
                    <div id="downloadProgressText" class="progress-text" style="text-align: center; margin-bottom: 10px; font-weight: 600; color: #4facfe;">
                        準備生成 PDF...
                    </div>
                    <div class="progress-bar" style="width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden;">
                        <div id="downloadProgressFill" class="progress-fill" style="height: 100%; width: 0%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                            0%
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-sm bg-white" id="individualTable">
                    <thead class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                        <tr>
                            <th class="p-3 text-left">班級</th>
                            <th class="p-3 text-left">學號</th>
                            <th class="p-3 text-left">姓名</th>
                            <th class="p-3 text-left">能力值 (θ)</th>
                            <th class="p-3 text-left">總分</th>
                            <th class="p-3 text-left" style="background:#4caf50;">合理答對</th>
                            <th class="p-3 text-left" style="background:#ff9800;">合理答錯</th>
                            <th class="p-3 text-left" style="background:#2196f3;">優勢作答</th>
                            <th class="p-3 text-left" style="background:#f44336;">迷思概念</th>
                            <th class="p-3 text-left">KIDMAP</th>
                        </tr>
                    </thead><tbody id="individualTableBody">`;
            html += generateIndividualTableRows(data.individualStats, data.nItems);
            html += `</tbody></table></div></div>`;
            return html;
        }

        function generateIndividualTableRows(stats, nItems) {
            let html = '';
            stats.forEach(s => {
                const rowClass = s.misconceptionCount > 3 ? 'misconception-highlight' : '';
                html += `<tr class="border-b hover:bg-gray-50 ${rowClass}" data-class="${s.class}">
                    <td class="p-3">${s.class}</td>
                    <td class="p-3 font-semibold">${s.studentId || ''}</td>
                    <td class="p-3">${s.studentName}</td>
                    <td class="p-3">${s.ability.toFixed(3)}</td>
                    <td class="p-3">${s.score} / ${nItems}</td>
                    <td class="p-3"><span class="badge reasonable-correct-badge">${s.reasonableCorrectCount} 題</span></td>
                    <td class="p-3"><span class="badge reasonable-wrong-badge">${s.reasonableWrongCount} 題</span></td>
                    <td class="p-3"><span class="badge advantage-badge">${s.advantageCount} 題</span></td>
                    <td class="p-3"><span class="badge misconception-badge">${s.misconceptionCount} 題</span></td>
                    <td class="p-3">
                        <button class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg font-semibold hover:shadow-lg transition-all text-xs" onclick="showKidmap(${s.index})">
                            📊 查看KIDMAP
                        </button>
                    </td>
                </tr>`;
            });
            return html;
        }

        function createClassStats(data) {
            const classes = Object.keys(data.classStats);
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">📚 班級四向度統計摘要</h3>
                
                <div class="overflow-x-auto mb-6"><table class="w-full text-sm bg-white">
                    <thead class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                        <tr>
                            <th class="p-3 text-left">班級</th>
                            <th class="p-3 text-left">人數</th>
                            <th class="p-3 text-left" style="background:#4caf50;">平均合理答對</th>
                            <th class="p-3 text-left" style="background:#ff9800;">平均合理答錯</th>
                            <th class="p-3 text-left" style="background:#2196f3;">平均優勢作答</th>
                            <th class="p-3 text-left" style="background:#f44336;">平均迷思概念</th>
                            <th class="p-3 text-left">總迷思概念</th>
                        </tr>
                    </thead><tbody>`;
            
            classes.forEach(cls => {
                const stats = data.classStats[cls];
                html += `<tr class="border-b hover:bg-gray-50">
                    <td class="p-3 font-semibold">${cls}</td>
                    <td class="p-3">${stats.count}</td>
                    <td class="p-3"><span class="badge reasonable-correct-badge">${stats.avgReasonableCorrect.toFixed(2)} 題</span></td>
                    <td class="p-3"><span class="badge reasonable-wrong-badge">${stats.avgReasonableWrong.toFixed(2)} 題</span></td>
                    <td class="p-3"><span class="badge advantage-badge">${stats.avgAdvantage.toFixed(2)} 題</span></td>
                    <td class="p-3"><span class="badge misconception-badge">${stats.avgMisconception.toFixed(2)} 題</span></td>
                    <td class="p-3">${stats.totalMisconception} 次</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            html += '<div class="grid md:grid-cols-2 gap-6">';
            
            html += '<div><h3 class="text-2xl font-bold mb-4 text-red-600">🔴 各班迷思概念題號排行</h3>';
            classes.forEach(cls => {
                const misconceptionItems = data.classMisconceptionItems[cls] || [];
                html += `<div class="bg-white p-4 rounded-lg mb-4 border-2 border-red-200">
                    <h4 class="font-bold mb-3 text-lg">${cls} 班迷思題目排行</h4>`;
                if (misconceptionItems.length === 0) {
                    html += '<div class="text-green-600">✅ 本班無迷思概念題目</div>';
                } else {
                    html += '<table class="w-full text-sm"><thead class="bg-red-100"><tr><th class="p-2 text-left">排名</th><th class="p-2 text-left">題號</th><th class="p-2 text-left">錯誤人數</th><th class="p-2 text-left">錯誤率</th></tr></thead><tbody>';
                    misconceptionItems.slice(0, 10).forEach((item, idx) => {
                        html += `<tr class="border-b hover:bg-red-50"><td class="p-2 font-bold text-red-600">#${idx + 1}</td><td class="p-2">Q${item.itemNum}</td><td class="p-2">${item.count} 人</td><td class="p-2">${item.percentage}%</td></tr>`;
                    });
                    html += '</tbody></table>';
                }
                html += '</div>';
            });
            html += '</div>';
            
            html += '<div><h3 class="text-2xl font-bold mb-4 text-orange-600">🟠 各班合理答錯題號排行</h3>';
            classes.forEach(cls => {
                const reasonableWrongItems = data.classReasonableWrongItems[cls] || [];
                html += `<div class="bg-white p-4 rounded-lg mb-4 border-2 border-orange-200">
                    <h4 class="font-bold mb-3 text-lg">${cls} 班合理答錯排行</h4>`;
                if (reasonableWrongItems.length === 0) {
                    html += '<div class="text-green-600">✅ 本班無合理答錯題目</div>';
                } else {
                    html += '<table class="w-full text-sm"><thead class="bg-orange-100"><tr><th class="p-2 text-left">排名</th><th class="p-2 text-left">題號</th><th class="p-2 text-left">答錯人數</th><th class="p-2 text-left">答錯率</th></tr></thead><tbody>';
                    reasonableWrongItems.slice(0, 10).forEach((item, idx) => {
                        html += `<tr class="border-b hover:bg-orange-50"><td class="p-2 font-bold text-orange-600">#${idx + 1}</td><td class="p-2">Q${item.itemNum}</td><td class="p-2">${item.count} 人</td><td class="p-2">${item.percentage}%</td></tr>`;
                    });
                    html += '</tbody></table>';
                }
                html += '</div>';
            });
            html += '</div>';
            
            html += '</div>';
            html += '</div>';
            return html;
        }

        // --- KIDMAP 彈窗相關 ---
        
        window.showKidmap = function(studentIndex) {
            const student = analysisData.individualStats[studentIndex];
            const modalTitle = document.getElementById('kidmapModalTitle');
            const modalBody = document.getElementById('kidmapModalBody');
            
            modalTitle.innerText = `KIDMAP 診斷報告 - ${student.class} ${student.studentName}`;
            
            const responses = analysisData.responseMatrix[studentIndex];
            const items = analysisData.itemDifficulty;
            const itemAnalysis = items.map((difficulty, i) => {
                if (difficulty == null || isNaN(difficulty)) {
                    return null;
                }
                const prob = 1 / (1 + Math.exp(-(student.ability - difficulty)));
                const actual = responses[i];
                const expected = prob > 0.5 ? 1 : 0;
                const unexpected = (actual === 1 && expected === 0) || (actual === 0 && expected === 1);
                
                return { 
                    name: `Q${i + 1}`, 
                    difficulty, 
                    ability: student.ability,
                    actual, 
                    expected, 
                    probability: prob, 
                    unexpected 
                };
            }).filter(item => item !== null);

            const kidmapHTML = generateVisualKidmap(student, itemAnalysis, false);
            const diagnosticStats = generateDiagnosticStats(student, itemAnalysis);
            const itemAnalysisTable = generateItemAnalysisTable(itemAnalysis);

            modalBody.innerHTML = `
                ${diagnosticStats}
                ${kidmapHTML}
                ${itemAnalysisTable}
            `;
            
            document.getElementById('kidmapModal').style.display = 'block';
        }

        window.closeKidmapModal = function() {
            document.getElementById('kidmapModal').style.display = 'none';
        }

        function generateDiagnosticStats(student, itemAnalysis) {
            const unexpected = itemAnalysis.filter(i => i.unexpected).length;
            const total = itemAnalysis.length;
            
            return `<div class="diagnostic-stats">
                <div class="diag-card ${unexpected > total * 0.2 ? 'warning' : 'success'}"><div class="diag-label">意外反應</div><div class="diag-value">${unexpected}/${total}</div></div>
                <div class="diag-card success"><div class="diag-label">合理答對 [A]</div><div class="diag-value">${student.reasonableCorrectCount}</div></div>
                <div class="diag-card warning"><div class="diag-label">合理答錯 [C]</div><div class="diag-value">${student.reasonableWrongCount}</div></div>
                <div class="diag-card success"><div class="diag-label">優勢作答 [B]</div><div class="diag-value">${student.advantageCount}</div></div>
                <div class="diag-card ${student.misconceptionCount > 0 ? 'danger' : 'success'}"><div class="diag-label">迷思概念 [D]</div><div class="diag-value">${student.misconceptionCount}</div></div>
            </div>`;
        }

        function generateVisualKidmap(student, itemAnalysis, isPdf = false) {
            const sortedItems = [...itemAnalysis].sort((a, b) => b.difficulty - a.difficulty);
            const maxDiff = Math.max(...sortedItems.map(i => i.difficulty));
            const minDiff = Math.min(...sortedItems.map(i => i.difficulty));
            const range = maxDiff - minDiff || 1;
            
            const abilityLinePosition = ((maxDiff - student.ability) / range) * 100;
            
            const topOffset = isPdf ? '28px' : '40px';
            const heightOffset = isPdf ? '60px' : '80px';

            const advantageConcept = [], reasonableCorrect = [], misconception = [], reasonableIncorrect = [];
            
            sortedItems.forEach(item => {
                const badge = `<span class="item-badge ${item.actual === 1 ? 'correct' : 'incorrect'} ${item.unexpected ? 'unexpected' : ''}">${item.name} <span class="item-info">(${item.difficulty.toFixed(2)})</span></span>`;
                if (item.difficulty > student.ability) {
                    if (item.actual === 1) advantageConcept.push(badge);
                    else reasonableIncorrect.push(badge);
                } else {
                    if (item.actual === 1) reasonableCorrect.push(badge);
                    else misconception.push(badge);
                }
            });

            return `<div class="kidmap-visual">
                <style>
                    .kidmap-quadrants-container { position: relative; }
                    .kidmap-ability-line {
                        position: absolute; left: 0; right: 0; height: 3px;
                        background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
                        z-index: 100; box-shadow: 0 0 10px rgba(245, 87, 108, 0.5);
                        pointer-events: none;
                        top: calc(${topOffset} + ${abilityLinePosition}% * (100% - ${heightOffset}) / 100);
                    }
                    ${isPdf ? `
                        .ability-label { top: 8px !important; padding: 3px 8px !important; font-size: 0.9em !important; z-index: 101 !important; }
                        .kidmap-footer { z-index: 10 !important; }
                    ` : ''}
                </style>
                <div class="kidmap-quadrants-container">
                    <div class="kidmap-quadrants">
                        <div class="kidmap-header">📊 視覺化 KIDMAP 診斷圖 - 能力測量 vs 題目難度分布</div>
                        
                        <div class="quadrant quadrant-top-left">
                            <div class="quadrant-title">[A] 合理答對 (能力>難度, 答對)</div>
                            ${reasonableCorrect.length > 0 ? reasonableCorrect.join('') : '<div class="text-gray-500">無</div>'}
                        </div>
                        <div class="quadrant quadrant-top-right">
                            <div class="quadrant-title">[C] 合理答錯 (能力<難度, 答錯)</div>
                            ${reasonableIncorrect.length > 0 ? reasonableIncorrect.join('') : '<div class="text-gray-500">無</div>'}
                        </div>
                        <div class="quadrant quadrant-bottom-left">
                            <div class="quadrant-title">[D] 迷思概念 (能力>難度, 答錯)</div>
                            ${misconception.length > 0 ? misconception.join('') : '<div class="text-green-600 font-semibold">✅ 無迷思概念</div>'}
                        </div>
                        <div class="quadrant quadrant-bottom-right">
                            <div class="quadrant-title">[B] 優勢作答 (能力<難度, 答對)</div>
                            ${advantageConcept.length > 0 ? advantageConcept.join('') : '<div class="text-gray-500">無</div>'}
                        </div>
                        
                        <div class="kidmap-footer">
                            <strong>判讀說明：</strong>能力線以上為「較難題目」，以下為「較簡單題目」。
                            <strong>綠色徽章</strong> = 答對 | <strong>紅色徽章</strong> = 答錯 | <strong>閃爍邊框</strong> = 意外反應
                        </div>
                    </div>
                    <div class="kidmap-ability-line">
                        <div class="ability-label">學生能力值 θ = ${student.ability.toFixed(3)}</div>
                    </div>
                </div>
            </div>`;
        }

        function generateItemAnalysisTable(itemAnalysis) {
            const getType = (item) => {
                if (item.difficulty > item.ability) {
                    return item.actual === 1 ? '[B] 優勢作答' : '[C] 合理答錯';
                } else {
                    return item.actual === 1 ? '[A] 合理答對' : '[D] 迷思概念';
                }
            };
            
            return `
                <div class="item-analysis-table-container mt-6">
                    <h4 class="text-xl font-bold mb-3">📋 逐題作答分析</h4>
                    <div class="overflow-x-auto">
                        <table class="item-analysis-table">
                            <thead>
                                <tr>
                                    <th>題號</th>
                                    <th>難度值</th>
                                    <th>作答結果</th>
                                    <th>預期結果</th>
                                    <th>答對機率</th>
                                    <th>狀態</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemAnalysis.map(item => `
                                    <tr class="${item.unexpected ? 'unexpected-cell' : ''}">
                                        <td><strong>${item.name}</strong></td>
                                        <td>${item.difficulty.toFixed(3)}</td>
                                        <td class="${item.actual === 1 ? 'correct-cell' : 'incorrect-cell'}">
                                            ${item.actual === 1 ? '✓ 答對' : '✗ 答錯'}
                                        </td>
                                        <td>${item.expected === 1 ? '✓' : '✗'}</td>
                                        <td>${(item.probability * 100).toFixed(1)}%</td>
                                        <td>${getType(item)} ${item.unexpected ? '(意外反應)' : ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function generateFeedback(student, itemAnalysis) {
            const hardCorrect = itemAnalysis.filter(i => i.actual === 1 && i.difficulty > student.ability);
            const easyIncorrect = itemAnalysis.filter(i => i.actual === 0 && i.difficulty < student.ability);
            const unexpected = itemAnalysis.filter(i => i.unexpected);

            let feedback = '<div style="background: #fff5e6; padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #ff9800;">';
            feedback += '<h3 style="color: #e65100; margin: 0 0 8px 0; font-size: 14px;">📝 診斷回饋與建議</h3>';
            
            if (hardCorrect.length > 0) {
                feedback += `<p style="font-size: 10px; margin: 5px 0; line-height: 1.4;"><span style="color: #2e7d32; font-weight: 600;">✓ 優勢表現：</span>您在較難題目（${hardCorrect.map(i => i.name).join('、')}）表現優異。</p>`;
            }
            
            if (easyIncorrect.length > 0) {
                feedback += `<p style="font-size: 10px; margin: 5px 0; line-height: 1.4;"><span style="color: #c62828; font-weight: 600;">✗ 需加強：</span>建議複習較簡單的題目（${easyIncorrect.map(i => i.name).join('、')}）。</p>`;
            }
            
            if (unexpected.length > itemAnalysis.length * 0.2) {
                feedback += `<p style="font-size: 10px; margin: 5px 0; line-height: 1.4;"><span style="color: #c62828; font-weight: 600;">⚠ 注意：</span>作答模式顯示較多意外反應（${unexpected.length}題），建議注意答題一致性。</p>`;
            }

            if (hardCorrect.length === 0 && easyIncorrect.length === 0) {
                feedback += `<p style="font-size: 10px; margin: 5px 0; line-height: 1.4;"><span style="color: #333; font-weight: 600;">✓ 表現穩定：</span>您的作答情況大致符合能力預期。</p>`;
            }
            
            feedback += '</div>';
            return feedback;
        }

        // --- KIDMAP PDF 產生 (個人報告) ---

        window.downloadStudentReports = async function() {
            const zip = new JSZip();
            
            const progressContainer = document.getElementById('downloadProgressContainer');
            const progressFill = document.getElementById('downloadProgressFill');
            const progressText = document.getElementById('downloadProgressText');
            
            if (!progressContainer || !progressFill || !progressText) {
                console.error('找不到進度條元素');
                alert('系統錯誤：找不到進度條元素');
                return;
            }

            progressContainer.style.display = 'block';
            
            const classFilterValue = document.getElementById('classFilter').value;
            
            let studentsToProcess = (classFilterValue === 'all')
                ? analysisData.individualStats
                : analysisData.individualStats.filter(student => student.class === classFilterValue);
            
            const total = studentsToProcess.length;

            if (total === 0) {
                 alert('在選定的篩選條件下沒有學生可供下載。');
                 progressContainer.style.display = 'none';
                 return;
            }

            const classFolders = {};
            studentsToProcess.forEach(student => {
                const className = student.class || '未知班級';
                if (!classFolders[className]) {
                    classFolders[className] = [];
                }
                classFolders[className].push(student);
            });

            let processedCount = 0;
            
            for (const [className, students] of Object.entries(classFolders)) {
                for (const student of students) {
                    try {
                        progressText.textContent = `正在生成 ${student.class} - ${student.studentId} ${student.studentName} 的報告... (${processedCount + 1}/${total})`;
                        
                        const pdfBlob = await generateStudentPDF(student);
                        
                        const fileName = `${student.class}_${student.studentId}_${student.studentName}.pdf`;
                        zip.folder(className).file(fileName, pdfBlob);
                        
                        processedCount++;
                        const progress = Math.round((processedCount / total) * 100);
                        progressFill.style.width = progress + '%';
                        progressFill.textContent = progress + '%';
                        
                        if (processedCount % 5 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        
                    } catch (error) {
                        console.error(`生成 ${student.studentId} 的 PDF 時出錯:`, error);
                    }
                }
            }
            
            progressText.textContent = '正在壓縮 ZIP...';
            const zipBlob = await zip.generateAsync({ 
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            });
            
            const zipClassName = (classFilterValue === 'all') ? '全校' : classFilterValue;
            downloadFile(`[${fileName}]_${zipClassName}_KIDMAP報告.zip`, zipBlob, 'application/zip');
            
            progressContainer.style.display = 'none';
        }

        async function generateStudentPDF(student) {
            const { jsPDF } = window.jspdf;

            const responses = analysisData.responseMatrix[student.index];
            const items = analysisData.itemDifficulty;
            const itemAnalysis = items.map((difficulty, i) => {
                if (difficulty == null || isNaN(difficulty)) return null;
                const prob = 1 / (1 + Math.exp(-(student.ability - difficulty)));
                const actual = responses[i];
                const expected = prob > 0.5 ? 1 : 0;
                const unexpected = (actual === 1 && expected === 0) || (actual === 0 && expected === 1);
                return {
                    name: `Q${i + 1}`,
                    difficulty,
                    ability: student.ability,
                    actual,
                    expected,
                    probability: prob,
                    unexpected
                };
            }).filter(item => item !== null);

            const page1HTML = generatePage1HTML(student, itemAnalysis);
            const page2HTML = generatePage2HTML(student, itemAnalysis);
            
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4', compress: true });

            // Helper to render HTML to a canvas using a temporary off-screen element
            const renderHtmlToCanvas = async (html) => {
                const renderContainer = document.createElement('div');
                renderContainer.className = 'pdf-container';
                renderContainer.innerHTML = html;
                document.body.appendChild(renderContainer);
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const pageElement = renderContainer.firstElementChild;
                const canvas = await html2canvas(pageElement, {
                    scale: 3, useCORS: true, logging: false, width: 794, windowWidth: 794
                });
                
                document.body.removeChild(renderContainer);
                return canvas;
            };

            const canvas1 = await renderHtmlToCanvas(page1HTML);
            pdf.addImage(canvas1.toDataURL('image/png', 1.0), 'PNG', 0, 0, 210, 297, undefined, 'FAST');
            
            const canvas2 = await renderHtmlToCanvas(page2HTML);
            pdf.addPage();
            pdf.addImage(canvas2.toDataURL('image/png', 1.0), 'PNG', 0, 0, 210, 297, undefined, 'FAST');
            
            return pdf.output('blob');
        }
        
        function generatePage1HTML(student, itemAnalysis) {
            const kidmapHTML = generateVisualKidmap(student, itemAnalysis, true); 
            const diagnosticStats = generateDiagnosticStats(student, itemAnalysis);
            const feedback = generateFeedback(student, itemAnalysis);
            
            const pdfStyles = `
                <style>
                    .pdf-page-1 { font-size: 10px; }
                    .kidmap-visual { margin: 5px 0; border-width: 1px; }
                    .kidmap-header { padding: 8px; font-size: 1.1em; }
                    .kidmap-quadrants { min-height: 350px; }
                    .quadrant { padding: 5px; min-height: 80px; }
                    .quadrant-title { font-size: 1.1em; margin-bottom: 4px; padding-bottom: 3px; }
                    .item-badge { padding: 2px 6px; font-size: 0.9em; margin: 2px; border-radius: 10px; }
                    .item-info { font-size: 0.8em; }
                    .kidmap-footer { padding: 6px; font-size: 0.9em; position: relative; z-index: 10; }
                    .diagnostic-stats { gap: 5px; margin: 5px 0; }
                    .diag-card { padding: 5px 8px; }
                    .diag-label { font-size: 0.85em; margin-bottom: 2px; }
                    .diag-value { font-size: 1.3em; }
                </style>`;

            return `
                <div class="pdf-page pdf-page-1" style="font-family: 'Microsoft JhengHei', sans-serif;">
                    ${pdfStyles}
                    <div class="header-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; text-align: center; border-radius: 8px; margin-bottom: 10px;">
                        <h1 style="margin: 0; font-size: 22px;">KIDMAP 學習診斷報告</h1>
                        <p style="margin: 5px 0 0 0; font-size: 10px;">曉明女中數學科製作 (國中版)</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <h2 style="color: #333; margin: 0 0 8px 0; font-size: 16px;">基本資訊</h2>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                            <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #667eea;"><div style="font-size: 9px; color: #666; margin-bottom: 3px;">學號</div><div style="font-size: 14px; font-weight: 700; color: #333;">${student.studentId}</div></div>
                            <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #667eea;"><div style="font-size: 9px; color: #666; margin-bottom: 3px;">姓名</div><div style="font-size: 14px; font-weight: 700; color: #333;">${student.studentName}</div></div>
                            <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #667eea;"><div style="font-size: 9px; color: #666; margin-bottom: 3px;">班級</div><div style="font-size: 14px; font-weight: 700; color: #333;">${student.class}</div></div>
                            <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #667eea;"><div style="font-size: 9px; color: #666; margin-bottom: 3px;">能力值 (θ)</div><div style="font-size: 14px; font-weight: 700; color: #333;">${student.ability.toFixed(2)}</div></div>
                            <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #667eea;"><div style="font-size: 9px; color: #666; margin-bottom: 3px;">原始分數</div><div style="font-size: 14px; font-weight: 700; color: #333;">${student.score}/${analysisData.nItems}</div></div>
                            <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #667eea;"><div style="font-size: 9px; color: #666; margin-bottom: 3px;">得分率</div><div style="font-size: 14px; font-weight: 700; color: #333;">${((student.score/analysisData.nItems)*100).toFixed(1)}%</div></div>
                        </div>
                    </div>
                    ${diagnosticStats}
                    ${feedback}
                    ${kidmapHTML}
                    <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 6px; text-align: center; font-size: 8px; color: #666;">
                        <p style="margin: 0;">第 1 頁，共 2 頁 | 報告生成時間: ${new Date().toLocaleString('zh-TW')}</p>
                    </div>
                </div>`;
        }
        
        function generatePage2HTML(student, itemAnalysis) {
            const getType = (item) => {
                if (item.difficulty > item.ability) {
                    return item.actual === 1 ? '[B] 優勢作答' : '[C] 合理答錯';
                } else {
                    return item.actual === 1 ? '[A] 合理答對' : '[D] 迷思概念';
                }
            };
            
            return `
                <div class="pdf-page pdf-page-2" style="font-family: 'Microsoft JhengHei', sans-serif;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; text-align: center; border-radius: 8px; margin-bottom: 15px;">
                        <h2 style="margin: 0; font-size: 18px;">逐題分析 - ${student.class} ${student.studentId} ${student.studentName}</h2>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; font-size: 9px;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <th style="padding: 8px; text-align: left;">題號</th><th style="padding: 8px; text-align: center;">難度值</th><th style="padding: 8px; text-align: center;">作答</th><th style="padding: 8px; text-align: center;">預期</th><th style="padding: 8px; text-align: center;">通過機率</th><th style="padding: 8px; text-align: left;">狀態</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemAnalysis.map(item => `
                                <tr style="border-bottom: 1px solid #e0e0e0;">
                                    <td style="padding: 6px 8px;"><strong>${item.name}</strong></td>
                                    <td style="padding: 6px 8px; text-align: center;">${item.difficulty.toFixed(2)}</td>
                                    <td style="padding: 6px 8px; text-align: center; color: ${item.actual === 1 ? '#198754' : '#dc3545'}; font-weight: 700;">${item.actual === 1 ? '✓' : '✗'}</td>
                                    <td style="padding: 6px 8px; text-align: center;">${item.expected === 1 ? '✓' : '✗'}</td>
                                    <td style="padding: 6px 8px; text-align: center;">${(item.probability * 100).toFixed(1)}%</td>
                                    <td style="padding: 6px 8px; text-align: left; font-size: 8px;">
                                        ${getType(item)}
                                        ${item.unexpected ? '<span style="background: #fff3cd; padding: 2px 4px; border-radius: 4px; margin-left: 2px;">⚠ 意外反應</span>' : ''}
                                    </td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 8px; color: #666;">
                        <p style="margin: 0 0 5px 0;"><strong>說明：</strong></p>
                        <p style="margin: 0;">• <strong>難度值</strong>：題目的 Rasch 難度參數，數值越大表示題目越難</p>
                        <p style="margin: 0;">• <strong>作答</strong>：學生實際作答結果（✓ 答對 / ✗ 答錯）</p>
                        <p style="margin: 0;">• <strong>預期</strong>：基於學生能力值預期的作答結果</p>
                        <p style="margin: 0;">• <strong>通過機率</strong>：根據 Rasch 模型計算的答對機率</p>
                        <p style="margin: 0;">• <strong>⚠ 意外反應</strong>：實際作答與預期不符，需特別關注</p>
                        <p style="margin: 10px 0 0 0; font-size: 7px; color: #999;">第 2 頁，共 2 頁 | KIDMAP 診斷系統 - 基於 Rasch 測量理論</p>
                    </div>
                </div>`;
        }

        // --- 篩選與排序 ---
        
        function setupFilters() {
            setTimeout(() => {
                try {
                    document.getElementById('classFilter').addEventListener('change', applyFilters);
                    document.getElementById('sortFilter').addEventListener('change', applyFilters);
                } catch (e) { console.error("Filter setup failed: ", e); }
            }, 100);
        }
        window.setupFilters = setupFilters;

        window.applyFilters = function() {
            const classFilter = document.getElementById('classFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            let filteredStats = [...analysisData.individualStats];
            if (classFilter !== 'all') {
                filteredStats = filteredStats.filter(s => s.class === classFilter);
            }
            switch(sortFilter) {
                case 'misconception': filteredStats.sort((a, b) => b.misconceptionCount - a.misconceptionCount); break;
                case 'ability': filteredStats.sort((a, b) => b.ability - a.ability); break;
                case 'advantage': filteredStats.sort((a, b) => b.advantageCount - a.advantageCount); break;
                case 'score': filteredStats.sort((a, b) => b.score - a.score); break;
            }
            document.getElementById('individualTableBody').innerHTML = generateIndividualTableRows(filteredStats, analysisData.nItems);
        }

        // --- Tab 切換 ---
        window.switchTab = function(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- 下載功能 ---
        function formatCSV(headers, data) {
            let csv = headers.join(',') + '\n';
            data.forEach(row => {
                csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
            });
            return csv;
        }

        function downloadFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        window.downloadScoringMatrix = function() {
            if (!scoringMatrix) return;
            const headers = ['班級', '姓名', ...scoringMatrix.questions.map((q, i) => `Q${i+1}`), '總分'];
            const data = scoringMatrix.matrix.map((row, idx) => {
                const student = scoringMatrix.students[idx];
                return [ student['班級'] || '', student['姓名'] || '', ...row, scoringMatrix.studentTotals[idx] ];
            });
            const csvContent = formatCSV(headers, data);
            downloadFile(`[${fileName}]_評分矩陣.csv`, '\uFEFF' + csvContent, 'text/csv;charset=utf-8-sig');
        }

        window.downloadItemFit = function() {
            if (!analysisData) return;
            const headers = ['題號', '難度(β)', 'SE', 'Infit MNSQ', 'Infit t', 'Outfit MNSQ', 'Outfit t'];
            const data = [];
            for (let i = 0; i < analysisData.nItems; i++) {
                data.push([ `Q${i+1}`, analysisData.itemDifficulty[i], analysisData.itemSE[i], analysisData.itemInfit[i], analysisData.itemInfitT[i], analysisData.itemOutfit[i], analysisData.itemOutfitT[i] ]);
            }
            const csvContent = formatCSV(headers, data);
            downloadFile(`[${fileName}]_題目適配度.csv`, '\uFEFF' + csvContent, 'text/csv;charset=utf-8-sig');
        }

        window.downloadDiscrimination = function() {
            if (!analysisData) return;
            const headers = ['題號', '難度(β)', '鑑別度(rpb)'];
            const data = [];
            for (let i = 0; i < analysisData.nItems; i++) {
                data.push([ `Q${i+1}`, analysisData.itemDifficulty[i], analysisData.itemDiscrimination[i] ]);
            }
            const csvContent = formatCSV(headers, data);
            downloadFile(`[${fileName}]_題目鑑別度.csv`, '\uFEFF' + csvContent, 'text/csv;charset=utf-8-sig');
        }

        window.downloadDistractor = function() {
            if (!analysisData || !analysisData.distractorStats) return;
            const headers = ['題號', '選項', '是否為答案', '選擇人數', '比例(%)', '平均能力值'];
            const data = [];
            analysisData.distractorStats.forEach(item => {
                Object.keys(item.options).forEach(option => {
                    const stat = item.options[option];
                    data.push([ `Q${item.questionIndex}`, option, option === item.correctAnswer ? '是' : '否', stat.count, stat.percentage, stat.avgAbility ]);
                });
            });
            const csvContent = formatCSV(headers, data);
            downloadFile(`[${fileName}]_誘答分析.csv`, '\uFEFF' + csvContent, 'text/csv;charset=utf-8-sig');
        }

        // --- 完整報告 PDF 下載功能 (已修正) ---
        
        function generatePdfPageWrapper(title, content, pageInfo = '') {
            return `
                <div style="padding: 6px; background-color: #fff; border-radius: 8px;">
                    <div class="report-page-header" style="background: #f3f4f6; padding: 10px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                        <h2 style="margin: 0; font-size: 16px; color: #1e3a8a;">${title}</h2>
                        ${pageInfo ? `<p style="margin: 5px 0 0 0; font-size: 11px; color: #4b5563;">${pageInfo}</p>` : ''}
                    </div>
                    ${content}
                </div>`;
        }

        function generateItemFitPageHTML(itemIndices, pageNum, totalPages) {
            let tableHtml = `<div class="overflow-x-auto"><table class="w-full text-sm bg-white" style="font-size: 9px;">
                <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: black;">
                    <tr><th style="padding: 4px;">題號</th><th style="padding: 4px;">難度 (β)</th><th style="padding: 4px;">SE</th><th style="padding: 4px;">Infit MNSQ</th><th style="padding: 4px;">Infit t</th><th style="padding: 4px;">Outfit MNSQ</th><th style="padding: 4px;">Outfit t</th><th style="padding: 4px;">判斷</th></tr>
                </thead><tbody>`;
            itemIndices.forEach(i => {
                const { itemInfit, itemOutfit, itemDifficulty, itemSE, itemInfitT, itemOutfitT } = analysisData;
                const infit = itemInfit[i], outfit = itemOutfit[i], difficulty = itemDifficulty[i], se = itemSE[i], infitT = itemInfitT[i], outfitT = itemOutfitT[i];
                const isValid = (infit != null && !isNaN(infit));
                let status = '🟢 良好', statusClass = 'background: #f0fdf4;', diffText = 'N/A', seText = 'N/A', infitText = 'N/A', infitTText = 'N/A', outfitText = 'N/A', outfitTText = 'N/A';
                if (isValid) {
                    diffText = difficulty.toFixed(3); seText = se.toFixed(3); infitText = infit.toFixed(3); infitTText = infitT.toFixed(2); outfitText = outfit.toFixed(3); outfitTText = outfitT.toFixed(2);
                    if (infit > 1.4 || outfit > 1.4 || infit < 0.6 || outfit < 0.6) { status = '🔴 需檢討'; statusClass = 'background: #fef2f2;'; }
                    else if (infit > 1.3 || outfit > 1.3 || infit < 0.7 || outfit < 0.7) { status = '🟡 可接受'; statusClass = 'background: #fefce8;'; }
                } else { status = '⚠️ 無法計算'; statusClass = 'background: #f3f4f6;'; }
                tableHtml += `<tr style="border-bottom: 1px solid #e5e7eb; ${statusClass}"><td style="padding: 4px;">Q${i+1}</td><td style="padding: 4px;">${diffText}</td><td style="padding: 4px;">${seText}</td><td style="padding: 4px;">${infitText}</td><td style="padding: 4px;">${infitTText}</td><td style="padding: 4px;">${outfitText}</td><td style="padding: 4px;">${outfitTText}</td><td style="padding: 4px;">${status}</td></tr>`;
            });
            tableHtml += `</tbody></table></div>`;
            return generatePdfPageWrapper('🔬 題目適配度分析', tableHtml, `第 ${pageNum} 頁 / 共 ${totalPages} 頁`);
        }

        function generateDiscriminationPageHTML(itemIndices, pageNum, totalPages) {
            let tableHtml = `<div class="overflow-x-auto"><table class="w-full text-sm bg-white" style="font-size: 9px;">
                <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: black;">
                    <tr><th style="padding: 4px;">題號</th><th style="padding: 4px;">難度 (β)</th><th style="padding: 4px;">鑑別度 (rpb)</th><th style="padding: 4px;">等級</th><th style="padding: 4px;">判斷</th></tr>
                </thead><tbody>`;
            itemIndices.forEach(i => {
                const disc = analysisData.itemDiscrimination[i], difficulty = analysisData.itemDifficulty[i];
                const discIsValid = disc != null && !isNaN(disc), diffIsValid = difficulty != null && !isNaN(difficulty);
                const difficultyText = diffIsValid ? difficulty.toFixed(3) : 'N/A', discText = discIsValid ? disc.toFixed(3) : 'N/A';
                let level = '', status = '', statusClass = '';
                if (discIsValid) {
                    if (disc < 0) { level = '嚴重問題'; status = '🔴🔴 題目有誤'; statusClass = 'background: #fee2e2;'; }
                    else if (disc < 0.1) { level = '極差'; status = '🔴 建議刪除'; statusClass = 'background: #fef2f2;'; }
                    else if (disc < 0.2) { level = '不佳'; status = '🔴 缺乏鑑別力'; statusClass = 'background: #fff7ed;'; }
                    else if (disc < 0.3) { level = '尚可'; status = '🟡 建議改善'; statusClass = 'background: #fefce8;'; }
                    else if (disc < 0.4) { level = '良好'; status = '🟢 可接受'; statusClass = 'background: #f0fdf4;'; }
                    else { level = '優秀'; status = '🟢 鑑別力佳'; statusClass = 'background: #dcfce7;'; }
                } else { level = '無法計算'; status = '⚠️'; statusClass = 'background: #f3f4f6;'; }
                tableHtml += `<tr style="border-bottom: 1px solid #e5e7eb; ${statusClass}"><td style="padding: 4px;">Q${i+1}</td><td style="padding: 4px;">${difficultyText}</td><td style="padding: 4px;">${discText}</td><td style="padding: 4px;">${level}</td><td style="padding: 4px;">${status}</td></tr>`;
            });
            tableHtml += `</tbody></table></div>`;
            return generatePdfPageWrapper('📈 題目鑑別度分析', tableHtml, `第 ${pageNum} 頁 / 共 ${totalPages} 頁`);
        }

        function generateDistractorPageHTML(distractorItems, pageNum, totalPages) {
            let html = '';
            distractorItems.forEach(item => {
                html += `<div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e5e7eb;"><h4 style="font-weight: bold; margin-bottom: 8px; font-size: 13px;">Q${item.questionIndex} 選項分析</h4>`;
                const options = Object.keys(item.options).sort();
                if (options.length > 0) {
                    html += `<table style="width: 100%; font-size: 9px;"><thead style="background: #f3f4f6;"><tr><th style="padding: 4px; text-align: left;">選項</th><th style="padding: 4px; text-align: left;">人數</th><th style="padding: 4px; text-align: left;">比例</th><th style="padding: 4px; text-align: left;">平均能力</th><th style="padding: 4px; text-align: left;">判斷</th></tr></thead><tbody>`;
                    const correctOptionStat = item.options[item.correctAnswer];
                    const correctAvgAbility = (correctOptionStat && !isNaN(correctOptionStat.avgAbility)) ? correctOptionStat.avgAbility : 0;
                    options.forEach(option => {
                        const stat = item.options[option];
                        const isCorrect = (option === item.correctAnswer);
                        const percentage = parseFloat(stat.percentage);
                        const avgAbility = stat.avgAbility;
                        let judgment = '', rowClass = '';
                        const avgAbilityText = !isNaN(avgAbility) ? avgAbility.toFixed(3) : 'N/A';
                        if (isCorrect) { judgment = '✓ 正確'; rowClass = 'background: #f0fdf4; font-weight: bold;'; }
                        else {
                            if (percentage < 5) { judgment = '🔴 無效'; rowClass = 'background: #fef2f2;'; }
                            else if (avgAbilityText !== 'N/A' && avgAbility >= correctAvgAbility - 0.2 && correctAvgAbility != 0) { judgment = '🔴🔴 混淆'; rowClass = 'background: #fee2e2;'; }
                            else if (avgAbilityText !== 'N/A' && avgAbility >= correctAvgAbility - 0.5 && correctAvgAbility != 0) { judgment = '🟡 需檢討'; rowClass = 'background: #fefce8;'; }
                            else { judgment = '🟢 有效'; }
                        }
                        html += `<tr style="${rowClass}"><td style="padding: 4px;">${option}${isCorrect ? ' ★' : ''}</td><td style="padding: 4px;">${stat.count}</td><td style="padding: 4px;">${stat.percentage}%</td><td style="padding: 4px;">${avgAbilityText}</td><td style="padding: 4px;">${judgment}</td></tr>`;
                    });
                    html += '</tbody></table>';
                }
                html += '</div>';
            });
            return generatePdfPageWrapper('🎯 誘答選項分析', html, `第 ${pageNum} 頁 / 共 ${totalPages} 頁`);
        }
        
        function generateClassStatsSummaryPageHTML() {
            const classes = Object.keys(analysisData.classStats);
            let tableHtml = `<div class="overflow-x-auto mb-6"><table class="w-full text-sm bg-white" style="font-size: 9px;">
                <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <tr><th style="padding: 4px;">班級</th><th style="padding: 4px;">人數</th><th style="padding: 4px;">均合理答對</th><th style="padding: 4px;">均合理答錯</th><th style="padding: 4px;">均優勢作答</th><th style="padding: 4px;">均迷思概念</th><th style="padding: 4px;">總迷思次數</th></tr>
                </thead><tbody>`;
            classes.forEach(cls => {
                const stats = analysisData.classStats[cls];
                tableHtml += `<tr style="border-bottom: 1px solid #e5e7eb;"><td style="padding: 4px; font-weight: bold;">${cls}</td><td style="padding: 4px;">${stats.count}</td><td style="padding: 4px;">${stats.avgReasonableCorrect.toFixed(2)}</td><td style="padding: 4px;">${stats.avgReasonableWrong.toFixed(2)}</td><td style="padding: 4px;">${stats.avgAdvantage.toFixed(2)}</td><td style="padding: 4px;">${stats.avgMisconception.toFixed(2)}</td><td style="padding: 4px;">${stats.totalMisconception}</td></tr>`;
            });
            tableHtml += '</tbody></table></div>';
            return generatePdfPageWrapper('📚 班級四向度統計摘要', tableHtml, '第 1 頁');
        }

        function generateClassStatsDetailPageHTML(classChunk, pageNum, totalPages) {
            let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">';
            html += '<div><h3 style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #dc2626;">🔴 各班迷思概念題號排行</h3>';
            classChunk.forEach(cls => {
                const items = analysisData.classMisconceptionItems[cls] || [];
                html += `<div style="background: white; padding: 8px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #fecaca;"><h4 style="font-weight: bold; margin-bottom: 5px; font-size: 12px;">${cls} 班</h4>`;
                if (items.length === 0) { html += '<div style="font-size: 9px; color: #166534;">✅ 無迷思概念題目</div>'; }
                else {
                    html += `<table style="width: 100%; font-size: 8px;"><thead style="background: #fee2e2;"><tr><th style="padding: 3px; text-align: left;">排名</th><th style="padding: 3px; text-align: left;">題號</th><th style="padding: 3px; text-align: left;">人數</th><th style="padding: 3px; text-align: left;">錯誤率</th></tr></thead><tbody>`;
                    items.slice(0, 10).forEach((item, idx) => { html += `<tr style="border-bottom: 1px solid #e5e7eb;"><td style="padding: 3px;">#${idx + 1}</td><td style="padding: 3px;">Q${item.itemNum}</td><td style="padding: 3px;">${item.count}</td><td style="padding: 3px;">${item.percentage}%</td></tr>`; });
                    html += '</tbody></table>';
                }
                html += '</div>';
            });
            html += '</div>';

            html += '<div><h3 style="font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #ea580c;">🟠 各班合理答錯題號排行</h3>';
            classChunk.forEach(cls => {
                const items = analysisData.classReasonableWrongItems[cls] || [];
                html += `<div style="background: white; padding: 8px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ffedd5;"><h4 style="font-weight: bold; margin-bottom: 5px; font-size: 12px;">${cls} 班</h4>`;
                if (items.length === 0) { html += '<div style="font-size: 9px; color: #166534;">✅ 無合理答錯題目</div>'; }
                else {
                    html += `<table style="width: 100%; font-size: 8px;"><thead style="background: #ffedd5;"><tr><th style="padding: 3px; text-align: left;">排名</th><th style="padding: 3px; text-align: left;">題號</th><th style="padding: 3px; text-align: left;">人數</th><th style="padding: 3px; text-align: left;">錯誤率</th></tr></thead><tbody>`;
                    items.slice(0, 10).forEach((item, idx) => { html += `<tr style="border-bottom: 1px solid #e5e7eb;"><td style="padding: 3px;">#${idx + 1}</td><td style="padding: 3px;">Q${item.itemNum}</td><td style="padding: 3px;">${item.count}</td><td style="padding: 3px;">${item.percentage}%</td></tr>`; });
                    html += '</tbody></table>';
                }
                html += '</div>';
            });
            html += '</div>';
            html += '</div>';
            return generatePdfPageWrapper('📚 班級迷思與合理答錯分析', html, `第 ${pageNum} 頁 / 共 ${totalPages} 頁`);
        }

        window.downloadFullReport = async function() {
            if (!analysisData) { alert('分析資料尚未準備就緒'); return; }

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4', true);

            const btn = document.getElementById('downloadReportBtn');
            const progressContainer = document.getElementById('reportProgressContainer');
            const progressFill = document.getElementById('reportProgressFill');
            const progressText = document.getElementById('reportProgressText');

            btn.disabled = true;
            progressContainer.style.display = 'block';

            // Corrected: Use a temporary, off-screen element for rendering to avoid DOM conflicts
            const addHtmlToPdf = async (html, isFirstPageOfDoc, tabName = '') => {
                const renderContainer = document.createElement('div');
                renderContainer.style.position = 'fixed';
                renderContainer.style.left = '-9999px';
                renderContainer.style.top = '0';

                renderContainer.innerHTML = `
                    <style>
                        .pdf-render-wrapper { width: 210mm; background: white; font-family: 'Microsoft JhengHei', sans-serif; }
                        .pdf-render-content { padding: 15mm; box-sizing: border-box; }
                        .overflow-x-auto { overflow: visible !important; }
                        table { width: 100%; word-break: break-word; font-size: 8px !important; border-collapse: collapse; }
                        th, td { padding: 4px 3px !important; border: 1px solid #ddd; }
                        thead th { background-color: #f3f4f6 !important; }
                        button, .tab-container, .download-section, [onclick] { display: none !important; }
                        .pdf-render-content .chart-container { display: block !important; height: 600px !important; }
                        img { max-width: 100% !important; height: auto !important; }
                    </style>
                    <div class="pdf-render-wrapper">
                        <div class="pdf-render-content">${html}</div>
                    </div>`;
                
                document.body.appendChild(renderContainer);
                await new Promise(resolve => setTimeout(resolve, 200));

                if (tabName === 'bubble') {
                    try {
                        const canvasEl = renderContainer.querySelector('#bubbleChartCanvas');
                        if (canvasEl) {
                           renderBubbleChart(analysisData, canvasEl);
                           await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    } catch(e) {
                        console.error("Bubble chart render for PDF failed:", e);
                    }
                }
                
                const pageElement = renderContainer.querySelector('.pdf-render-wrapper');
                const canvas = await html2canvas(pageElement, { scale: 2, useCORS: true, logging: false });
                
                document.body.removeChild(renderContainer); // Clean up the temporary element

                const imgData = canvas.toDataURL('image/jpeg', 0.92);
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                if (!isFirstPageOfDoc) {
                    pdf.addPage();
                }
                
                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
                heightLeft -= pageHeight;
                
                while (heightLeft > 0) {
                    position -= pageHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
                    heightLeft -= pageHeight;
                }
            };
            
            const updateProgress = (done, total, text) => {
                progressText.textContent = `正在處理: ${text}...`;
                const percent = Math.round((done / total) * 100);
                progressFill.style.width = percent + '%';
                progressFill.textContent = percent + '%';
            };

            try {
                let isFirstPageOfDoc = true;

                const itemFitPages = Math.ceil(analysisData.nItems / 25);
                const discriminationPages = Math.ceil(analysisData.nItems / 25);
                const distractorPages = Math.ceil(analysisData.distractorStats.length / 5);
                const classDetailPages = Math.ceil(Object.keys(analysisData.classStats).length / 3);
                const totalLogicalSteps = 2 + itemFitPages + discriminationPages + 1 + distractorPages + 1 + classDetailPages;
                let currentLogicalStep = 0;
                
                const processTab = async (tabName, title) => {
                    if (tabName === 'summary') {
                        updateProgress(++currentLogicalStep, totalLogicalSteps, title);
                        await addHtmlToPdf(createSummaryView(analysisData), isFirstPageOfDoc);
                        isFirstPageOfDoc = false;
                    } else if (tabName === 'wrightmap') {
                        updateProgress(++currentLogicalStep, totalLogicalSteps, title);
                        await addHtmlToPdf(createWrightMapView(analysisData), isFirstPageOfDoc);
                        if (isFirstPageOfDoc) isFirstPageOfDoc = false;
                    } else if (tabName === 'itemfit') {
                        const chunks = chunk([...Array(analysisData.nItems).keys()], 25);
                        for (let j = 0; j < chunks.length; j++) {
                            updateProgress(++currentLogicalStep, totalLogicalSteps, `${title} (第 ${j + 1} 頁)`);
                            await addHtmlToPdf(generateItemFitPageHTML(chunks[j], j + 1, chunks.length), isFirstPageOfDoc);
                            if (isFirstPageOfDoc) isFirstPageOfDoc = false;
                        }
                    } else if (tabName === 'discrimination') {
                        const chunks = chunk([...Array(analysisData.nItems).keys()], 25);
                        for (let j = 0; j < chunks.length; j++) {
                            updateProgress(++currentLogicalStep, totalLogicalSteps, `${title} (第 ${j + 1} 頁)`);
                            await addHtmlToPdf(generateDiscriminationPageHTML(chunks[j], j + 1, chunks.length), isFirstPageOfDoc);
                            if (isFirstPageOfDoc) isFirstPageOfDoc = false;
                        }
                    } else if (tabName === 'bubble') {
                         updateProgress(++currentLogicalStep, totalLogicalSteps, title);
                         await addHtmlToPdf(createBubbleChartView(analysisData), isFirstPageOfDoc, 'bubble');
                         if (isFirstPageOfDoc) isFirstPageOfDoc = false;
                    } else if (tabName === 'distractor') {
                        const chunks = chunk(analysisData.distractorStats, 5);
                        for (let j = 0; j < chunks.length; j++) {
                            updateProgress(++currentLogicalStep, totalLogicalSteps, `${title} (第 ${j + 1} 頁)`);
                            await addHtmlToPdf(generateDistractorPageHTML(chunks[j], j + 1, chunks.length), isFirstPageOfDoc);
                            if (isFirstPageOfDoc) isFirstPageOfDoc = false;
                        }
                    } else if (tabName === 'class') {
                        updateProgress(++currentLogicalStep, totalLogicalSteps, `${title} (總表)`);
                        await addHtmlToPdf(generateClassStatsSummaryPageHTML(), isFirstPageOfDoc);
                        if (isFirstPageOfDoc) isFirstPageOfDoc = false;

                        const classChunks = chunk(Object.keys(analysisData.classStats), 3);
                        for (let j = 0; j < classChunks.length; j++) {
                            updateProgress(++currentLogicalStep, totalLogicalSteps, `${title} (詳細分析 ${j + 1})`);
                            await addHtmlToPdf(generateClassStatsDetailPageHTML(classChunks[j], j + 1, classChunks.length), false);
                        }
                    }
                };

                await processTab('summary', '總覽');
                await processTab('wrightmap', 'Wright Map');
                await processTab('itemfit', '題目適配度');
                await processTab('discrimination', '題目鑑別度');
                await processTab('bubble', '氣泡圖分析');
                await processTab('distractor', '誘答分析');
                await processTab('class', '班級統計');

                progressText.textContent = '正在生成 PDF 檔案...';
                pdf.save(`[${fileName}]_完整分析報告.pdf`);

            } catch (error) {
                console.error('生成完整 PDF 報告時出錯:', error);
                alert('生成 PDF 失敗：' + error.message);
            } finally {
                progressContainer.style.display = 'none';
                btn.disabled = false;
            }
        }
        
        function chunk(arr, size) {
            const chunks = [];
            for (let i = 0; i < arr.length; i += size) {
                chunks.push(arr.slice(i, i + size));
            }
            return chunks;
        }

        // --- 初始載入 ---
        initWebR().then(() => {
            if (isWebRReady) {
                renderStep1();
            }
        });

    </script>
</body>
</html>
