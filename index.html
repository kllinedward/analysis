<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›‰æ˜å¥³ä¸­æ•¸å­¸ç§‘å°ˆæ¥­è©¦é¡Œåˆ†æç³»çµ±-é«˜ä¸­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff9800;
            animation: pulse 1.5s infinite;
            margin-right: 10px;
        }
        
        .status-indicator.ready {
            background: #4caf50;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .badge {
            display: inline-block;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 2px;
        }

        .advantage-badge { background: #2196f3; }
        .reasonable-correct-badge { background: #4caf50; }
        .reasonable-wrong-badge { background: #ff9800; }
        .misconception-badge { background: #f44336; }
        .good-badge { background: #4caf50; }
        .acceptable-badge { background: #ffc107; }
        .poor-badge { background: #f44336; }
        
        .misconception-highlight {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 20px;
            background: #e5e7eb;
            border: 2px solid #d1d5db;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .score-table {
            font-size: 0.9em;
            border-collapse: separate;
            border-spacing: 0;
        }

        .score-table thead {
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .score-table th {
            background: #1e40af !important;
            color: white !important;
            font-weight: bold;
            padding: 12px 8px !important;
            border: 1px solid #1e3a8a !important;
            text-align: center;
        }

        .score-table td.correct {
            background-color: #c8e6c9;
            color: #2e7d32;
            font-weight: 700;
            text-align: center;
        }

        .score-table td.incorrect {
            background-color: #ffcdd2;
            color: #c62828;
            font-weight: 700;
            text-align: center;
        }

        .score-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .score-table tbody tr:hover td.correct {
            background-color: #a5d6a7;
        }

        .score-table tbody tr:hover td.incorrect {
            background-color: #ef9a9a;
        }

        .sticky-col-class {
            position: sticky;
            left: 0;
            background: white !important;
            z-index: 15;
            border-right: 3px solid #1e40af !important;
            font-weight: 600;
        }

        .sticky-col-name {
            position: sticky;
            left: 100px;
            background: white !important;
            z-index: 15;
            border-right: 3px solid #1e40af !important;
            font-weight: 600;
        }

        .score-table thead th.sticky-col-class,
        .score-table thead th.sticky-col-name {
            background: #1e40af !important;
            z-index: 25;
        }

        .score-table tfoot td {
            background: #f3f4f6 !important;
            font-weight: 600;
            border: 1px solid #d1d5db !important;
            padding: 10px 8px;
        }

        .table-container {
            max-height: 600px;
            overflow: auto;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .error-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .header-container {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyMCIgaGVpZ2h0PSI0MDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJiZ0dyYWQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMxZTNhOGE7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSI1MCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMyNTYzZWI7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMzg5NWZmO3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjYmdHcmFkKSIvPjwvc3ZnPg==');
            background-size: cover;
            background-position: center;
            border-radius: 20px;
            padding: 60px 40px;
            box-shadow: 0 10px 40px rgba(30, 58, 138, 0.4);
            position: relative;
            overflow: hidden;
        }

        .header-with-image {
            background-image: url('./analysis-bg.png');
            background-size: cover;
            background-position: center left;
            background-repeat: no-repeat;
        }

        .header-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.85) 0%, rgba(37, 99, 235, 0.75) 50%, rgba(56, 149, 255, 0.65) 100%);
            z-index: 1;
        }

        .header-content {
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .school-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            letter-spacing: 4px;
            animation: fadeInDown 1s ease-out;
        }

        .system-title {
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(to right, #fbbf24, #f59e0b, #fde047);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(251, 191, 36, 0.6);
            margin-bottom: 10px;
            letter-spacing: 6px;
            animation: fadeInUp 1s ease-out 0.3s both;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hex-pattern {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0.1;
            z-index: 1;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 35px, rgba(255,255,255,0.1) 35px, rgba(255,255,255,0.1) 36px),
                repeating-linear-gradient(60deg, transparent, transparent 35px, rgba(255,255,255,0.1) 35px, rgba(255,255,255,0.1) 36px),
                repeating-linear-gradient(120deg, transparent, transparent 35px, rgba(255,255,255,0.1) 35px, rgba(255,255,255,0.1) 36px);
        }

        .kidmap-visual {
            background: white;
            border: 2px solid #333;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .kidmap-quadrants {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr 1fr auto;
            min-height: 400px;
            position: relative;
        }
        
        .kidmap-header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .kidmap-footer {
            grid-column: 1 / -1;
            background: #f8f9fa;
            padding: 12px;
            text-align: center;
            border-top: 2px solid #ddd;
            font-size: 0.85em;
            color: #666;
        }
        
        .quadrant {
            padding: 10px;
            border: 1px solid #ddd;
            position: relative;
            overflow-y: auto;
            min-height: 100px;
        }
        
        .quadrant-top-left {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-right: 2px solid #4CAF50;
            border-bottom: 2px solid #4CAF50;
        }
        
        .quadrant-top-right {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-bottom: 2px solid #FF9800;
        }
        
        .quadrant-bottom-left {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-right: 2px solid #2196F3;
        }
        
        .quadrant-bottom-right {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }
        
        .quadrant-title {
            font-weight: 700;
            font-size: 1em;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }
        
        /* ä¿®æ­£èƒ½åŠ›ç·šæ¨£å¼ */
        .ability-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
            z-index: 100;
            box-shadow: 0 0 10px rgba(245, 87, 108, 0.5);
            pointer-events: none;
        }
        
        .ability-label {
            position: absolute;
            right: 10px;
            top: -25px;
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        
        .item-badge {
            display: inline-block;
            position: relative;
            margin: 3px;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.85em;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            white-space: nowrap;
            vertical-align: middle;
        }
        .item-badge > * { 
            display: inline-block; /* è®“ transform ç”Ÿæ•ˆ */
            position: relative; /* ç‚ºäº†å¾®èª¿ (å¦‚æœéœ€è¦) */
            vertical-align: middle; /* åŸºç¤å°é½Š */
            /* å˜—è©¦ç”¨ transform å°‡æ–‡å­—å‘ä¸Šç§»å‹•ä¸€é»é» */
            /* æ‚¨å¯èƒ½éœ€è¦å¾®èª¿ -1px æˆ– -2px */
             transform: translateY(-1px); 
        }
        
        .item-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .item-badge.correct {
            background: #4CAF50;
            color: white;
        }
        
        .item-badge.incorrect {
            background: #f44336;
            color: white;
        }
        
        .item-badge.unexpected {
            animation: pulse-kidmap 2s infinite;
            border: 2px solid #ff6b6b;
        }
        
        @keyframes pulse-kidmap {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
        }
        
        .item-info {
            display: inline;
            vertical-align: middle;
            font-size: 0.75em;
            opacity: 0.8;
            margin-left: 3px;
        }

        /* é€é¡Œåˆ†æè¡¨æ ¼æ¨£å¼ */
        .item-analysis-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }
        
        .item-analysis-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .item-analysis-table th {
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }
        
        .item-analysis-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .item-analysis-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .item-analysis-table .correct-cell {
            color: #4CAF50;
            font-weight: 700;
        }
        
        .item-analysis-table .incorrect-cell {
            color: #f44336;
            font-weight: 700;
        }
        
        .item-analysis-table .unexpected-cell {
            background: #fff3cd;
            font-weight: 700;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            max-width: 1200px;
            margin: 20px auto;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .modal-body {
            padding: 30px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .diagnostic-stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin: 10px 0;
        }
        
        .diag-card {
            background: white;
            padding: 8px 10px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            border-left: 3px solid #667eea;
        }
        
        .diag-card.warning {
            border-left-color: #FF9800;
            background: #fff8e1;
        }
        
        .diag-card.danger {
            border-left-color: #f44336;
            background: #ffebee;
        }
        
        .diag-card.success {
            border-left-color: #4CAF50;
            background: #e8f5e9;
        }
        
        .diag-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .diag-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #333;
            /* æ¸›å°‘æ•¸å­—ä¸Šä¸‹å¯èƒ½æœ‰çš„é è¨­é–“è· */
Â  Â  Â  Â  Â  Â  line-height: 1.2; 
Â  Â  Â  Â  Â  Â  margin-top: 2px;
Â  Â  Â  Â  Â  Â  margin-bottom: 2px;
        }

        .student-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .download-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border: 2px solid #4facfe;
            border-radius: 15px;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        
        .download-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
        }
        
        .download-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress-container {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #4facfe;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }
        
        .progress-text {
            text-align: center;
            color: #666;
            font-size: 0.95em;
            margin-top: 10px;
        }

        /* PDF å°ˆç”¨æ¨£å¼ */
        .pdf-container {
            position: fixed;
            left: -9999px;
            top: 0;
            width: 210mm;
            background: white;
        }
        
        .pdf-page {
            width: 210mm;
            height: 297mm;
            padding: 15mm;
            background: white;
            page-break-after: always;
            box-sizing: border-box;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <header class="header-container header-with-image mb-8">
            <div class="hex-pattern"></div>
            <div class="header-overlay"></div>
            <div class="header-content">
                <h1 class="school-title">æ›‰æ˜å¥³ä¸­æ•¸å­¸ç§‘ï¼ˆé«˜ä¸­ç‰ˆï¼‰</h1>
                <h2 class="system-title">å°ˆæ¥­è©¦é¡Œåˆ†æç³»çµ±</h2>
            </div>
        </header>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <span class="status-indicator" id="statusIndicator"></span>
                    <strong>ç³»çµ±ç‹€æ…‹:</strong>
                    <span id="statusText">æ­£åœ¨åˆå§‹åŒ– WebR...</span>
                </div>
                <div class="text-sm text-gray-500" id="progressText">0%</div>
            </div>
            <div class="w-full h-2 bg-gray-200 rounded-full mt-3">
                <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all" id="progressBar" style="width: 0%"></div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center gap-4">
                <div class="flex-1 text-center" id="stepIndicator1">
                    <div class="w-12 h-12 mx-auto rounded-full bg-blue-500 text-white flex items-center justify-center font-bold mb-2">1</div>
                    <div class="text-sm font-semibold">ä¸Šå‚³CSV</div>
                </div>
                <div class="flex-1 border-t-2 border-gray-300"></div>
                <div class="flex-1 text-center" id="stepIndicator2">
                    <div class="w-12 h-12 mx-auto rounded-full bg-gray-300 text-white flex items-center justify-center font-bold mb-2">2</div>
                    <div class="text-sm font-semibold">è¨­å®šé¡Œå‹</div>
                </div>
                <div class="flex-1 border-t-2 border-gray-300"></div>
                <div class="flex-1 text-center" id="stepIndicator3">
                    <div class="w-12 h-12 mx-auto rounded-full bg-gray-300 text-white flex items-center justify-center font-bold mb-2">3</div>
                    <div class="text-sm font-semibold">è©•åˆ†æª¢æŸ¥</div>
                </div>
                <div class="flex-1 border-t-2 border-gray-300"></div>
                <div class="flex-1 text-center" id="stepIndicator4">
                    <div class="w-12 h-12 mx-auto rounded-full bg-gray-300 text-white flex items-center justify-center font-bold mb-2">4</div>
                    <div class="text-sm font-semibold">å°ˆæ¥­åˆ†æ</div>
                </div>
            </div>
        </div>

        <div id="mainContent"></div>
    </div>

    <div class="modal" id="kidmapModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="kidmapModalTitle">KIDMAP è¨ºæ–·å ±å‘Š</h2>
                <button class="close-btn" onclick="closeKidmapModal()">Ã—</button>
            </div>
            <div class="modal-body" id="kidmapModalBody"></div>
        </div>
    </div>

    <div id="pdfContainer" class="pdf-container"></div>

    <script type="module">
        import { WebR } from 'https://webr.r-wasm.org/latest/webr.mjs';
        
        let webR;
        let isWebRReady = false;
        let currentStep = 1;
        let selectedEncoding = 'BIG5';
        let fileName = '';
        let csvData = [];
        let standardAnswer = '';
        let standardAnswerSource = '';
        let totalGrids = 0;
        let grids = [];
        let selectedGrids = new Set();
        let selectionMode = 'click';
        let currentType = 'single';
        let scoringMatrix = null;
        let rangeStart = '';
        let rangeEnd = '';
        let analysisData = null;

        const multipleChoiceMap = {
            'F': '12', 'G': '13', 'H': '14', 'I': '15', 'J': '23',
            'K': '24', 'L': '25', 'M': '34', 'N': '35', 'O': '45',
            'P': '123', 'Q': '124', 'R': '125', 'S': '134', 'T': '135',
            'U': '145', 'V': '234', 'W': '235', 'X': '245', 'Y': '345',
            'Z': '1234', '*': '1235', '$': '1245', '%': '1345', ',': '2345',
            '#': '12345', '=': '', '?': '?', '.': '.'
        };

        async function initWebR() {
            try {
                updateWebRStatus('æ­£åœ¨åˆå§‹åŒ– WebR...', 10);
                webR = new WebR();
                await webR.init();
                
                updateWebRStatus('æ­£åœ¨å®‰è£ MASS å¥—ä»¶...', 20);
                await webR.installPackages(['MASS']);
                
                updateWebRStatus('æ­£åœ¨å®‰è£ TAM å¥—ä»¶...ï¼ˆé€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜ï¼‰', 35);
                await webR.installPackages(['TAM']);
                
                updateWebRStatus('æ­£åœ¨å®‰è£ WrightMap å¥—ä»¶...', 55);
                await webR.installPackages(['WrightMap']);
                
                updateWebRStatus('æ­£åœ¨è¼‰å…¥å¥—ä»¶...', 75);
                await webR.evalR('library(MASS)');
                await webR.evalR('library(TAM)');
                await webR.evalR('library(WrightMap)');
                
                updateWebRStatus('ç³»çµ±æº–å‚™å°±ç·’ï¼', 100, true);
                isWebRReady = true;
                
            } catch (error) {
                updateWebRStatus('åˆå§‹åŒ–å¤±æ•—ï¼š' + error.message, 0);
                console.error('WebR initialization error:', error);
            }
        }

        function updateWebRStatus(text, progress, ready = false) {
            document.getElementById('statusText').textContent = text;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = progress + '%';
            if (ready) {
                document.getElementById('statusIndicator').classList.add('ready');
            }
        }

        function cleanCSVValue(value) {
            if (!value) return '';
            let cleaned = value.trim();
            if ((cleaned.startsWith('"') && cleaned.endsWith('"')) || 
                (cleaned.startsWith("'") && cleaned.endsWith("'"))) {
                cleaned = cleaned.slice(1, -1);
            }
            cleaned = cleaned.replace(/["""''']/g, '');
            return cleaned.trim();
        }

        function parseCSVLine(line) {
            const values = [];
            let currentValue = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentValue += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(cleanCSVValue(currentValue));
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }
            values.push(cleanCSVValue(currentValue));
            return values;
        }

        function isStandardAnswerCard(status) {
            if (!status || status.length === 0) return false;
            for (let char of status) {
                if (char !== '.' && char !== '=') return false;
            }
            const dotCount = (status.match(/\./g) || []).length;
            const equalCount = (status.match(/=/g) || []).length;
            return dotCount >= 10 && equalCount > 0;
        }

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const parsedData = [];
            let answer = '';
            let answerSource = '';
            
            let headerIndex = -1;
            let headers = [];
            
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('å­¸ç”Ÿç­”æ¡ˆ')) {
                    headerIndex = i;
                    headers = parseCSVLine(lines[i]);
                    break;
                }
            }
            
            if (headerIndex === -1) {
                throw new Error('æ‰¾ä¸åˆ°å­¸ç”Ÿè³‡æ–™ï¼Œè«‹ç¢ºèªCSVæ ¼å¼æ˜¯å¦æ­£ç¢º');
            }
            
            const answerIndex = headers.indexOf('å­¸ç”Ÿç­”æ¡ˆ');
            const statusIndex = headers.indexOf('ä½œç­”æƒ…å½¢');
            const nameIndex = headers.indexOf('å§“å');
            const seatIndex = headers.indexOf('åº§è™Ÿ');
            
            let classIndex = headers.indexOf('ç­ç´šç°¡ç¨±');
            if (classIndex === -1) classIndex = headers.indexOf('ç­ç´š');
            if (classIndex === -1) classIndex = headers.indexOf('ç­ç´šä»£è™Ÿ');
            if (classIndex === -1) classIndex = headers.indexOf('ç­ç´šåç¨±');
            if (classIndex === -1) classIndex = headers.indexOf('CLASS');
            
            let grids = 0;
            
            for (let i = headerIndex + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || line.startsWith(',,,')) continue;
                
                const values = parseCSVLine(line);
                if (values.length < headers.length) continue;
                
                const name = cleanCSVValue(values[nameIndex] || '');
                const studentAnswer = cleanCSVValue(values[answerIndex] || '');
                const status = cleanCSVValue(values[statusIndex] || '');
                const seat = cleanCSVValue(values[seatIndex] || '');
                const classValue = cleanCSVValue(values[classIndex] || '');
                
                if (!name) continue;
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = cleanCSVValue(values[index] || '');
                });
                
                if (classIndex !== -1) {
                    row['ç­ç´š'] = classValue;
                }
                
                parsedData.push(row);
                
                if (!answer && status && isStandardAnswerCard(status)) {
                    answer = studentAnswer;
                    grids = answer.length;
                    answerSource = `${name}ï¼ˆåº§è™Ÿ ${seat}ï¼‰`;
                }
            }
            
            if (!answer && parsedData.length > 0) {
                grids = parsedData[0]['å­¸ç”Ÿç­”æ¡ˆ'].length;
            }
            
            return { parsedData, answer, answerSource, grids };
        }

        window.handleFile = function(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const { parsedData, answer, answerSource, grids } = parseCSV(text);
                    
                    csvData = parsedData;
                    standardAnswer = answer;
                    standardAnswerSource = answerSource;
                    totalGrids = grids;
                    fileName = file.name;
                    
                    renderStep1();
                } catch (error) {
                    alert('æª”æ¡ˆè§£æå¤±æ•—ï¼š' + error.message);
                    console.error('Parse error:', error);
                }
            };
            
            if (selectedEncoding === 'BIG5') {
                reader.readAsText(file, 'Big5');
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        };

        window.setManualAnswer = function() {
            const input = document.getElementById('manualAnswer');
            const answer = cleanCSVValue(input.value);
            
            if (answer.length !== totalGrids) {
                alert(`æ¨™æº–ç­”æ¡ˆå¿…é ˆæ˜¯ ${totalGrids} å€‹å­—å…ƒï¼Œç›®å‰åªæœ‰ ${answer.length} å€‹`);
                return;
            }
            
            standardAnswer = answer;
            standardAnswerSource = 'æ‰‹å‹•è¼¸å…¥';
            renderStep1();
        };

        window.initializeGrids = function() {
            grids = [];
            for (let i = 0; i < standardAnswer.length; i++) {
                if (standardAnswer[i] !== '=') {
                    grids.push({
                        number: i + 1,
                        answer: standardAnswer[i],
                        type: null,
                        groupId: null,
                        originalIndex: i
                    });
                }
            }
            selectedGrids = new Set();
            currentStep = 2;
            updateStepIndicator();
            renderStep2();
        };

        window.toggleGridSelection = function(index) {
            if (selectedGrids.has(index)) {
                selectedGrids.delete(index);
            } else {
                selectedGrids.add(index);
            }
            renderStep2();
        };

        window.selectGridsByRange = function() {
            const start = parseInt(rangeStart);
            const end = parseInt(rangeEnd);
            
            if (!start || !end) {
                alert('è«‹è¼¸å…¥èµ·å§‹å’ŒçµæŸæ ¼è™Ÿ');
                return;
            }
            
            selectedGrids = new Set();
            grids.forEach((grid, index) => {
                if (grid.number >= start && grid.number <= end) {
                    selectedGrids.add(index);
                }
            });
            
            if (selectedGrids.size === 0) {
                alert(`æ‰¾ä¸åˆ°æ ¼è™Ÿ ${start} åˆ° ${end} çš„æ ¼å­`);
                return;
            }
            
            renderStep2();
        };

        function isArrayContinuous(arr) {
            if (arr.length <= 1) return true;
            const originalIndices = arr.map(i => grids[i].originalIndex).sort((a, b) => a - b);
            for (let i = 1; i < originalIndices.length; i++) {
                if (originalIndices[i] !== originalIndices[i-1] + 1) {
                    return false;
                }
            }
            return true;
        }

        window.markSelectedGrids = function() {
            if (selectedGrids.size === 0) {
                alert('è«‹å…ˆé¸æ“‡æ ¼å­');
                return;
            }
            
            const selectedArray = Array.from(selectedGrids).sort((a, b) => a - b);
            
            if (currentType === 'fill') {
                if (!isArrayContinuous(selectedArray)) {
                    const gridNumbers = selectedArray.map(i => grids[i].number).join(', ');
                    alert(`é¸å¡«é¡Œçš„æ ¼å­å¿…é ˆé€£çºŒï¼æ‚¨é¸äº†ï¼šæ ¼ ${gridNumbers}`);
                    return;
                }
                
                const groupId = Date.now();
                selectedArray.forEach(index => {
                    grids[index].type = currentType;
                    grids[index].groupId = groupId;
                });
            } else {
                selectedArray.forEach(index => {
                    grids[index].type = currentType;
                    grids[index].groupId = null;
                });
            }
            
            selectedGrids = new Set();
            renderStep2();
        };

        window.clearSelection = function() {
            selectedGrids = new Set();
            renderStep2();
        };

        window.resetAllGrids = function() {
            if (confirm('ç¢ºå®šè¦é‡è¨­æ‰€æœ‰æ ¼å­çš„è¨­å®šå—ï¼Ÿ')) {
                initializeGrids();
            }
        };

        window.setCurrentType = function(type) {
            currentType = type;
            renderStep2();
        };

        function getQuestionsList() {
            const questions = [];
            const processed = new Set();
            
            grids.forEach((grid, index) => {
                if (!grid.type || processed.has(index)) return;
                
                if (grid.type === 'fill' && grid.groupId !== null) {
                    const groupGrids = grids
                        .map((g, i) => g.groupId === grid.groupId ? i : -1)
                        .filter(i => i !== -1);
                    
                    questions.push({
                        type: grid.type,
                        typeName: getTypeName(grid.type),
                        grids: groupGrids,
                        originalIndices: groupGrids.map(i => grids[i].originalIndex)
                    });
                    
                    groupGrids.forEach(i => processed.add(i));
                } else {
                    questions.push({
                        type: grid.type,
                        typeName: getTypeName(grid.type),
                        grids: [index],
                        originalIndices: [grids[index].originalIndex]
                    });
                    processed.add(index);
                }
            });
            
            return questions;
        }

        function getTypeName(type) {
            const names = {
                'single': 'å–®é¸',
                'multiple': 'å¤šé¸',
                'fill': 'é¸å¡«',
                'mixed': 'æ··åˆ'
            };
            return names[type] || '';
        }

        function getGridColumns() {
            const count = grids.length;
            if (count <= 10) return 10;
            if (count <= 20) return 10;
            if (count <= 30) return 15;
            if (count <= 40) return 20;
            return 25;
        }

        function decodeAnswer(code) {
            if (!code || code === '=') return '';
            if (code === '?') return '?';
            if (code === '.') return '.';
            
            if (code >= '0' && code <= '9') return code;
            if (code === '-' || code === '+') return code;
            if (code >= 'A' && code <= 'E') return code;
            
            if (multipleChoiceMap[code] !== undefined) {
                return multipleChoiceMap[code];
            }
            
            return code;
        }

        function scoreAnswer(studentCode, correctCode, questionType) {
            const studentAns = decodeAnswer(studentCode);
            const correctAns = decodeAnswer(correctCode);
            
            if (!studentAns || studentAns === '?' || studentAns === '.') return 0;
            if (!correctAns || correctAns === '') return 0;
            
            if (questionType === 'multiple' || correctAns.length > 1) {
                const studentSet = new Set(studentAns.split(''));
                const correctSet = new Set(correctAns.split(''));
                
                if (studentSet.size !== correctSet.size) return 0;
                for (let choice of studentSet) {
                    if (!correctSet.has(choice)) return 0;
                }
                return 1;
            }
            
            return studentAns === correctAns ? 1 : 0;
        }

        window.generateScoringMatrix = function() {
            const questions = getQuestionsList();
            
            if (questions.length === 0) {
                alert('è«‹å…ˆè¨­å®šé¡Œç›®ï¼');
                return;
            }

            const matrix = csvData.map((student) => {
                const studentAnswer = student['å­¸ç”Ÿç­”æ¡ˆ'] || '';
                
                return questions.map((q) => {
                    if (q.type === 'fill') {
                        let allCorrect = true;
                        for (const originalIdx of q.originalIndices) {
                            const studentCode = studentAnswer[originalIdx] || '';
                            const correctCode = standardAnswer[originalIdx] || '';
                            
                            const studentAns = decodeAnswer(studentCode);
                            const correctAns = decodeAnswer(correctCode);
                            
                            if (!studentAns || !correctAns || studentAns !== correctAns) {
                                allCorrect = false;
                                break;
                            }
                        }
                        return allCorrect ? 1 : 0;
                    } else {
                        const originalIdx = q.originalIndices[0];
                        const studentCode = studentAnswer[originalIdx] || '';
                        const correctCode = standardAnswer[originalIdx] || '';
                        return scoreAnswer(studentCode, correctCode, q.type);
                    }
                });
            });

            const studentTotals = matrix.map(row => row.reduce((a, b) => a + b, 0));
            const questionTotals = questions.map((_, qIdx) => 
                matrix.reduce((sum, row) => sum + row[qIdx], 0)
            );

            scoringMatrix = {
                matrix,
                students: csvData,
                questions,
                studentTotals,
                questionTotals
            };
            
            currentStep = 3;
            updateStepIndicator();
            renderStep3ScoringMatrix();
        };

        function renderStep3ScoringMatrix() {
            const content = document.getElementById('mainContent');
            
            let html = `
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-3xl font-bold mb-6 text-green-600 flex items-center gap-3">
                        âœ“ è©•åˆ†çµæœæª¢æŸ¥ï¼ˆ0èˆ‡1è¡¨ï¼‰
                    </h2>
                    
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="font-semibold">å­¸ç”Ÿäººæ•¸ï¼š</span>
                                <span class="text-blue-600 font-bold ml-2">${csvData.length}</span>
                            </div>
                            <div>
                                <span class="font-semibold">é¡Œç›®æ•¸é‡ï¼š</span>
                                <span class="text-blue-600 font-bold ml-2">${scoringMatrix.questions.length}</span>
                            </div>
                            <div>
                                <span class="font-semibold">ç¸½åˆ†ï¼š</span>
                                <span class="text-blue-600 font-bold ml-2">${scoringMatrix.questions.length}</span>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="score-table w-full">
                            <thead>
                                <tr>
                                    <th class="sticky-col-class" style="min-width: 100px;">ç­ç´š</th>
                                    <th class="sticky-col-name" style="min-width: 100px;">å§“å</th>
                                    ${scoringMatrix.questions.map((q, idx) => {
                                        const qNum = idx + 1;
                                        return `<th style="min-width: 60px;">
                                            Q${qNum}<br>
                                            <span style="font-size: 0.75em;">(${q.typeName})</span>
                                        </th>`;
                                    }).join('')}
                                    <th style="min-width: 70px; background: #ca8a04 !important;">ç¸½åˆ†</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            scoringMatrix.matrix.forEach((row, idx) => {
                const student = scoringMatrix.students[idx];
                const total = scoringMatrix.studentTotals[idx];
                const className = student['ç­ç´š'] || '';
                const studentName = student['å§“å'] || '';
                
                html += `<tr>
                    <td class="sticky-col-class" style="padding: 8px; text-align: left;">${className}</td>
                    <td class="sticky-col-name" style="padding: 8px; text-align: left;">${studentName}</td>`;
                
                row.forEach(score => {
                    html += `<td class="${score === 1 ? 'correct' : 'incorrect'}" style="padding: 8px;">${score}</td>`;
                });
                
                html += `<td style="padding: 8px; background: #fef3c7 !important; font-weight: 700; text-align: center;">${total}</td>
                </tr>`;
            });
            
            html += `
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2" style="text-align: center; font-weight: 700;">ç­”å°äººæ•¸</td>
                                    ${scoringMatrix.questionTotals.map(total => 
                                        `<td style="text-align: center;">${total}</td>`
                                    ).join('')}
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="flex gap-4 mt-6">
                        <button onclick="currentStep=2; updateStepIndicator(); renderStep2();" class="bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600">
                            â† è¿”å›ä¸Šä¸€æ­¥
                        </button>
                        <button onclick="downloadScoringMatrix()" class="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600">
                            ğŸ“¥ ä¸‹è¼‰è©•åˆ†è¡¨
                        </button>
                        <button onclick="proceedToRaschAnalysis()" class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-xl text-xl font-bold hover:shadow-2xl transition-all transform hover:scale-105">
                            ä¸‹ä¸€æ­¥ï¼šé–‹å§‹å°ˆæ¥­åˆ†æ â†’
                        </button>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }

        window.downloadScoringMatrix = function() {
            if (!scoringMatrix) return;
            
            let csv = 'ç­ç´š,å§“å';
            scoringMatrix.questions.forEach((q, idx) => {
                csv += `,Q${idx + 1}(${q.typeName})`;
            });
            csv += ',ç¸½åˆ†\n';
            
            scoringMatrix.matrix.forEach((row, idx) => {
                const student = scoringMatrix.students[idx];
                const className = student['ç­ç´š'] || '';
                const studentName = student['å§“å'] || '';
                csv += `${className},${studentName}`;
                row.forEach(score => {
                    csv += `,${score}`;
                });
                csv += `,${scoringMatrix.studentTotals[idx]}\n`;
            });
            
            csv += 'ç­”å°äººæ•¸,';
            scoringMatrix.questionTotals.forEach(total => {
                csv += `,${total}`;
            });
            csv += '\n';
            
            downloadCSV(csv, 'scoring_matrix.csv');
        };

        window.proceedToRaschAnalysis = function() {
            currentStep = 4;
            updateStepIndicator();
            performRaschAnalysis();
        };

        async function performRaschAnalysis() {
            if (!isWebRReady) {
                alert('WebR å°šæœªæº–å‚™å°±ç·’ï¼Œè«‹ç¨å€™å†è©¦');
                return;
            }

            if (!scoringMatrix) {
                alert('æ²’æœ‰è³‡æ–™å¯åˆ†æ');
                return;
            }

            try {
                renderStep4Loading();

                let csvText = 'CLASS,StudentID,StudentName';
                for (let i = 0; i < scoringMatrix.questions.length; i++) {
                    csvText += ',Q' + (i + 1);
                }
                csvText += '\n';

                scoringMatrix.matrix.forEach((row, idx) => {
                    const student = scoringMatrix.students[idx];
                    const className = student['ç­ç´š'] || '';
                    const studentId = student['å­¸è™Ÿ'] || '';
                    const studentName = student['å§“å'] || '';
                    csvText += className + ',' + studentId + ',' + studentName;
                    row.forEach(score => {
                        csvText += ',' + score;
                    });
                    csvText += '\n';
                });

                await webR.objs.globalEnv.bind('csv_text', csvText);

                await webR.evalR(`
                    data_text <- csv_text
                    con <- textConnection(data_text)
                    fulldata <- read.csv(con, header = TRUE)
                    close(con)
                    
                    class_info <- fulldata$CLASS
                    student_ids <- fulldata$StudentID
                    student_names <- fulldata$StudentName
                    
                    respdata <- fulldata[, -(1:3)]
                    respdata[] <- lapply(respdata, as.numeric)
                    
                    row_sums <- rowSums(respdata, na.rm = TRUE)
                    valid_indices <- which(row_sums > 0)
                    
                    respdata_clean <- respdata[valid_indices, ]
                    class_info_clean <- class_info[valid_indices]
                    student_ids_clean <- student_ids[valid_indices]
                    student_names_clean <- student_names[valid_indices]
                    
                    mod <- TAM::tam.mml(respdata_clean, verbose = FALSE)
                    fit <- TAM::tam.fit(mod)
                    person_params <- TAM::tam.wle(mod)
                    reliability <- mod$EAP.rel
                    
                    total_scores <- rowSums(respdata_clean)
                    item_discrimination <- sapply(1:ncol(respdata_clean), function(i) {
                        cor(respdata_clean[,i], total_scores, use = "complete.obs")
                    })
                    
                    png(filename = "/tmp/wrightmap.png", width = 1200, height = 800, res = 120)
                    WrightMap::wrightMap(
                        person_params$theta, 
                        mod$xsi$xsi,
                        label.items = paste0("Q", 1:ncol(respdata_clean)),
                        main.title = "Wright Map - Person Ability vs Item Difficulty",
                        axis.persons = "Person Ability (Î¸)",
                        axis.items = "Item Difficulty (Î²)"
                    )
                    dev.off()
                    
                    png(filename = "/tmp/ability_dist.png", width = 800, height = 600, res = 100)
                    hist(person_params$theta, breaks = 20, col = "lightblue", border = "white",
                         main = "Student Ability Distribution", xlab = "Ability (Î¸)", ylab = "Frequency")
                    dev.off()
                    
                    png(filename = "/tmp/difficulty_dist.png", width = 800, height = 600, res = 100)
                    hist(mod$xsi$xsi, breaks = 10, col = "lightcoral", border = "white",
                         main = "Item Difficulty Distribution", xlab = "Difficulty (Î²)", ylab = "Frequency")
                    dev.off()
                `);

                const nItems = (await (await webR.evalR('ncol(respdata_clean)')).toJs()).values[0];
                const nPersons = (await (await webR.evalR('nrow(respdata_clean)')).toJs()).values[0];
                
                const itemDifficulty = (await (await webR.evalR('as.numeric(mod$xsi$xsi)')).toJs()).values;
                const itemSE = (await (await webR.evalR('as.numeric(mod$xsi$se.xsi)')).toJs()).values;
                const personAbility = (await (await webR.evalR('as.numeric(person_params$theta)')).toJs()).values;
                const personSE = (await (await webR.evalR('as.numeric(person_params$error)')).toJs()).values;
                const personScores = (await (await webR.evalR('rowSums(respdata_clean)')).toJs()).values;
                
                const classInfo = (await (await webR.evalR('as.character(class_info_clean)')).toJs()).values;
                const studentIds = (await (await webR.evalR('as.character(student_ids_clean)')).toJs()).values;
                const studentNames = (await (await webR.evalR('as.character(student_names_clean)')).toJs()).values;

                const itemInfit = (await (await webR.evalR('as.numeric(fit$itemfit$Infit)')).toJs()).values;
                const itemOutfit = (await (await webR.evalR('as.numeric(fit$itemfit$Outfit)')).toJs()).values;
                const itemInfitT = (await (await webR.evalR('as.numeric(fit$itemfit$Infit_t)')).toJs()).values;
                const itemOutfitT = (await (await webR.evalR('as.numeric(fit$itemfit$Outfit_t)')).toJs()).values;
                
                const itemDiscrimination = (await (await webR.evalR('as.numeric(item_discrimination)')).toJs()).values;
                const reliability = (await (await webR.evalR('as.numeric(reliability)')).toJs()).values[0];

                const responseMatrix = [];
                for (let i = 0; i < nPersons; i++) {
                    const row = (await (await webR.evalR(`as.numeric(respdata_clean[${i+1},])`)).toJs()).values;
                    responseMatrix.push(row);
                }

                const wrightmapFile = await webR.FS.readFile('/tmp/wrightmap.png');
                const wrightmapBlob = new Blob([wrightmapFile], { type: 'image/png' });
                const wrightmapUrl = URL.createObjectURL(wrightmapBlob);

                const abilityDistFile = await webR.FS.readFile('/tmp/ability_dist.png');
                const abilityDistBlob = new Blob([abilityDistFile], { type: 'image/png' });
                const abilityDistUrl = URL.createObjectURL(abilityDistBlob);

                const difficultyDistFile = await webR.FS.readFile('/tmp/difficulty_dist.png');
                const difficultyDistBlob = new Blob([difficultyDistFile], { type: 'image/png' });
                const difficultyDistUrl = URL.createObjectURL(difficultyDistBlob);

                analysisData = {
                    nItems, nPersons, itemDifficulty, itemSE, itemInfit, itemOutfit, 
                    itemInfitT, itemOutfitT, itemDiscrimination, personAbility, personSE, 
                    personScores, classInfo, studentIds, studentNames, responseMatrix, reliability,
                    wrightmapUrl, abilityDistUrl, difficultyDistUrl
                };

                calculateFourCategories(analysisData);
                calculateDistractorAnalysis(analysisData);
                calculateClassStatistics(analysisData);
                renderStep4Results(analysisData);

            } catch (error) {
                alert('åˆ†æéç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
                console.error('Analysis error:', error);
            }
        }

        function calculateFourCategories(data) {
            const individualStats = [];
            
            for (let i = 0; i < data.nPersons; i++) {
                const ability = data.personAbility[i];
                const responses = data.responseMatrix[i];
                
                let reasonableCorrect = [], reasonableWrong = [], advantage = [], misconception = [];
                
                for (let j = 0; j < data.nItems; j++) {
                    const difficulty = data.itemDifficulty[j];
                    const response = responses[j];
                    
                    if (ability > difficulty) {
                        if (response === 1) reasonableCorrect.push(j + 1);
                        else misconception.push(j + 1);
                    } else {
                        if (response === 0) reasonableWrong.push(j + 1);
                        else advantage.push(j + 1);
                    }
                }
                
                individualStats.push({
                    index: i, 
                    class: data.classInfo[i], 
                    studentId: data.studentIds[i],
                    studentName: data.studentNames[i],
                    ability, 
                    score: data.personScores[i],
                    reasonableCorrectCount: reasonableCorrect.length, 
                    reasonableCorrectItems: reasonableCorrect,
                    reasonableWrongCount: reasonableWrong.length, 
                    reasonableWrongItems: reasonableWrong,
                    advantageCount: advantage.length, 
                    advantageItems: advantage,
                    misconceptionCount: misconception.length, 
                    misconceptionItems: misconception
                });
            }
            
            data.individualStats = individualStats;
        }

        // ä¿®æ­£3: å¢åŠ åˆç†ç­”éŒ¯çµ±è¨ˆ
        function calculateClassStatistics(data) {
            const classes = [...new Set(data.classInfo)];
            const classStats = {};
            const classMisconceptionItems = {};
            const classReasonableWrongItems = {};
            
            classes.forEach(cls => {
                const classStudents = data.individualStats.filter(s => s.class === cls);
                
                // è¨ˆç®—ç­ç´šçµ±è¨ˆ
                classStats[cls] = {
                    count: classStudents.length,
                    avgReasonableCorrect: classStudents.reduce((sum, s) => sum + s.reasonableCorrectCount, 0) / classStudents.length,
                    avgReasonableWrong: classStudents.reduce((sum, s) => sum + s.reasonableWrongCount, 0) / classStudents.length,
                    avgAdvantage: classStudents.reduce((sum, s) => sum + s.advantageCount, 0) / classStudents.length,
                    avgMisconception: classStudents.reduce((sum, s) => sum + s.misconceptionCount, 0) / classStudents.length,
                    totalReasonableCorrect: classStudents.reduce((sum, s) => sum + s.reasonableCorrectCount, 0),
                    totalReasonableWrong: classStudents.reduce((sum, s) => sum + s.reasonableWrongCount, 0),
                    totalAdvantage: classStudents.reduce((sum, s) => sum + s.advantageCount, 0),
                    totalMisconception: classStudents.reduce((sum, s) => sum + s.misconceptionCount, 0)
                };
                
                // è¨ˆç®—è¿·æ€æ¦‚å¿µé¡Œç›®çµ±è¨ˆ
                const itemMisconceptionCount = {};
                classStudents.forEach(student => {
                    student.misconceptionItems.forEach(itemNum => {
                        itemMisconceptionCount[itemNum] = (itemMisconceptionCount[itemNum] || 0) + 1;
                    });
                });
                
                classMisconceptionItems[cls] = Object.entries(itemMisconceptionCount)
                    .map(([itemNum, count]) => ({
                        itemNum: parseInt(itemNum), 
                        count,
                        percentage: (count / classStudents.length * 100).toFixed(1)
                    }))
                    .sort((a, b) => b.count - a.count);
                
                // è¨ˆç®—åˆç†ç­”éŒ¯é¡Œç›®çµ±è¨ˆ
                const itemReasonableWrongCount = {};
                classStudents.forEach(student => {
                    student.reasonableWrongItems.forEach(itemNum => {
                        itemReasonableWrongCount[itemNum] = (itemReasonableWrongCount[itemNum] || 0) + 1;
                    });
                });
                
                classReasonableWrongItems[cls] = Object.entries(itemReasonableWrongCount)
                    .map(([itemNum, count]) => ({
                        itemNum: parseInt(itemNum), 
                        count,
                        percentage: (count / classStudents.length * 100).toFixed(1)
                    }))
                    .sort((a, b) => b.count - a.count);
            });
            
            data.classStats = classStats;
            data.classMisconceptionItems = classMisconceptionItems;
            data.classReasonableWrongItems = classReasonableWrongItems;
        }

        function calculateDistractorAnalysis(data) {
            const questions = scoringMatrix.questions;
            const distractorStats = [];
            
            for (let qIdx = 0; qIdx < questions.length; qIdx++) {
                const question = questions[qIdx];
                const originalIdx = question.originalIndices[0];
                const correctAnswer = decodeAnswer(standardAnswer[originalIdx]);
                const optionStats = {};
                
                csvData.forEach((student) => {
                    const validIdx = data.studentIds.indexOf(student['å­¸è™Ÿ'] || '');
                    if (validIdx === -1) return;
                    
                    const studentAnswer = student['å­¸ç”Ÿç­”æ¡ˆ'] || '';
                    const studentChoice = decodeAnswer(studentAnswer[originalIdx]);
                    
                    if (!studentChoice || studentChoice === '?' || studentChoice === '.') return;
                    
                    if (!optionStats[studentChoice]) {
                        optionStats[studentChoice] = { count: 0, abilitySum: 0, abilities: [] };
                    }
                    
                    optionStats[studentChoice].count++;
                    optionStats[studentChoice].abilitySum += data.personAbility[validIdx];
                    optionStats[studentChoice].abilities.push(data.personAbility[validIdx]);
                });
                
                Object.keys(optionStats).forEach(option => {
                    const stat = optionStats[option];
                    stat.avgAbility = stat.abilitySum / stat.count;
                    stat.percentage = (stat.count / data.nPersons * 100).toFixed(1);
                });
                
                distractorStats.push({
                    questionIndex: qIdx + 1, correctAnswer, options: optionStats, totalResponses: data.nPersons
                });
            }
            
            data.distractorStats = distractorStats;
        }

        function updateStepIndicator() {
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`stepIndicator${i}`);
                const circle = indicator.querySelector('div:first-child');
                
                if (i < currentStep) {
                    circle.className = 'w-12 h-12 mx-auto rounded-full bg-green-500 text-white flex items-center justify-center font-bold mb-2';
                } else if (i === currentStep) {
                    circle.className = 'w-12 h-12 mx-auto rounded-full bg-blue-500 text-white flex items-center justify-center font-bold mb-2';
                } else {
                    circle.className = 'w-12 h-12 mx-auto rounded-full bg-gray-300 text-white flex items-center justify-center font-bold mb-2';
                }
            }
        }

        function renderStep1() {
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-3xl font-bold mb-6 text-blue-600 flex items-center gap-3">ğŸ“¤ æ­¥é©Ÿ 1ï¼šä¸Šå‚³ CSV æª”æ¡ˆ</h2>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold mb-2 text-gray-700">é¸æ“‡æª”æ¡ˆç·¨ç¢¼ï¼š</label>
                        <div class="flex gap-4">
                            <button onclick="selectedEncoding='BIG5'; renderStep1();" class="${selectedEncoding === 'BIG5' ? 'bg-blue-500 text-white shadow-lg scale-105' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} px-6 py-3 rounded-lg font-semibold transition-all">BIG5</button>
                            <button onclick="selectedEncoding='UTF-8'; renderStep1();" class="${selectedEncoding === 'UTF-8' ? 'bg-blue-500 text-white shadow-lg scale-105' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} px-6 py-3 rounded-lg font-semibold transition-all">UTF-8</button>
                        </div>
                    </div>
                    <div class="border-4 border-dashed border-blue-300 rounded-xl p-12 text-center bg-blue-50 hover:bg-blue-100 transition-all">
                        <input type="file" id="fileInput" accept=".csv" class="hidden" onchange="handleFile(this.files[0])">
                        <button onclick="document.getElementById('fileInput').click()" class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-8 py-4 rounded-xl text-lg font-bold hover:shadow-2xl transition-all transform hover:scale-105">ğŸ“ é¸æ“‡ CSV æª”æ¡ˆ</button>
                        ${fileName ? `<div class="mt-4 text-green-600 font-semibold">âœ“ å·²é¸æ“‡ï¼š${fileName}</div>` : ''}
                    </div>
                    ${csvData.length > 0 ? `
                        <div class="mt-8 p-6 bg-green-50 rounded-xl border-2 border-green-200">
                            <h3 class="text-xl font-bold text-green-700 mb-4">âœ“ æª”æ¡ˆè¼‰å…¥æˆåŠŸï¼</h3>
                            <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                                <div><span class="font-semibold">å­¸ç”Ÿäººæ•¸ï¼š</span><span class="text-blue-600 font-bold text-lg ml-2">${csvData.length}</span></div>
                                <div><span class="font-semibold">ç­”æ¡ˆæ ¼æ•¸ï¼š</span><span class="text-blue-600 font-bold text-lg ml-2">${totalGrids}</span></div>
                            </div>
                            ${standardAnswer ? `
                                <div class="p-4 bg-white rounded-lg mb-4">
                                    <div class="font-semibold text-green-700 mb-2">âœ“ å·²è‡ªå‹•åµæ¸¬æ¨™æº–ç­”æ¡ˆï¼š</div>
                                    <div class="font-mono text-lg bg-gray-100 p-3 rounded">${standardAnswer}</div>
                                    <div class="text-sm text-gray-600 mt-2">ä¾†æºï¼š${standardAnswerSource}</div>
                                </div>
                                <button onclick="initializeGrids()" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-4 rounded-xl text-xl font-bold hover:shadow-2xl transition-all transform hover:scale-105">ä¸‹ä¸€æ­¥ï¼šè¨­å®šé¡Œå‹ â†’</button>
                            ` : `
                                <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <div class="font-semibold text-yellow-800 mb-3">âš ï¸ æœªåµæ¸¬åˆ°æ¨™æº–ç­”æ¡ˆï¼Œè«‹æ‰‹å‹•è¼¸å…¥ï¼š</div>
                                    <input type="text" id="manualAnswer" placeholder="è«‹è¼¸å…¥ ${totalGrids} å€‹å­—å…ƒçš„æ¨™æº–ç­”æ¡ˆ" class="w-full p-3 border-2 border-yellow-300 rounded-lg font-mono text-lg mb-3">
                                    <button onclick="setManualAnswer()" class="bg-yellow-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-yellow-600">ç¢ºèªæ¨™æº–ç­”æ¡ˆ</button>
                                </div>
                            `}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderStep2() {
            const content = document.getElementById('mainContent');
            const questions = getQuestionsList();
            const gridCols = getGridColumns();
            
            content.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-3xl font-bold mb-6 text-purple-600 flex items-center gap-3">ğŸ“ æ­¥é©Ÿ 2ï¼šè¨­å®šé¡Œç›®é¡å‹</h2>
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-semibold">ç¸½æ ¼æ•¸ï¼š</span><span class="text-blue-600 font-bold ml-2">${grids.length}</span></div>
                            <div><span class="font-semibold">å·²è¨­å®šï¼š</span><span class="text-green-600 font-bold ml-2">${grids.filter(g => g.type).length}</span></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-6 mb-6">
                        <div class="p-6 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl">
                            <h3 class="font-bold text-lg mb-4 text-purple-700">é¸æ“‡é¡Œå‹ï¼š</h3>
                            <div class="space-y-2">
                                <button onclick="setCurrentType('single')" class="${currentType === 'single' ? 'bg-blue-500 text-white shadow-lg scale-105' : 'bg-white text-gray-700 hover:bg-gray-100'} w-full p-3 rounded-lg font-semibold transition-all">å–®é¸é¡Œ</button>
                                <button onclick="setCurrentType('multiple')" class="${currentType === 'multiple' ? 'bg-green-500 text-white shadow-lg scale-105' : 'bg-white text-gray-700 hover:bg-gray-100'} w-full p-3 rounded-lg font-semibold transition-all">å¤šé¸é¡Œ</button>
                                <button onclick="setCurrentType('fill')" class="${currentType === 'fill' ? 'bg-orange-500 text-white shadow-lg scale-105' : 'bg-white text-gray-700 hover:bg-gray-100'} w-full p-3 rounded-lg font-semibold transition-all">é¸å¡«é¡Œ</button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-6 p-6 bg-gray-50 rounded-xl">
                        <h3 class="font-bold text-lg mb-4">é¸æ“‡æ ¼å­ï¼š</h3>
                        <div class="flex gap-4 mb-4">
                            <button onclick="selectionMode='click'; renderStep2();" class="${selectionMode === 'click' ? 'bg-blue-500 text-white' : 'bg-gray-200'} px-6 py-2 rounded-lg font-semibold">é»é¸æ¨¡å¼</button>
                            <button onclick="selectionMode='range'; renderStep2();" class="${selectionMode === 'range' ? 'bg-blue-500 text-white' : 'bg-gray-200'} px-6 py-2 rounded-lg font-semibold">ç¯„åœæ¨¡å¼</button>
                        </div>
                        ${selectionMode === 'range' ? `
                            <div class="flex gap-4 mb-4">
                                <input type="number" id="rangeStartInput" placeholder="èµ·å§‹æ ¼è™Ÿ" value="${rangeStart}" onchange="rangeStart=this.value" class="p-2 border-2 rounded w-32">
                                <span class="self-center">åˆ°</span>
                                <input type="number" id="rangeEndInput" placeholder="çµæŸæ ¼è™Ÿ" value="${rangeEnd}" onchange="rangeEnd=this.value" class="p-2 border-2 rounded w-32">
                                <button onclick="selectGridsByRange()" class="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold">é¸æ“‡ç¯„åœ</button>
                            </div>
                        ` : ''}
                        <div class="grid gap-2 mb-4" style="grid-template-columns: repeat(${gridCols}, minmax(0, 1fr))">
                            ${grids.map((grid, index) => `
                                <button onclick="toggleGridSelection(${index})" class="${
                                    selectedGrids.has(index) ? 'bg-yellow-400 text-black scale-110 shadow-lg' :
                                    grid.type === 'single' ? 'bg-blue-200 text-blue-800' :
                                    grid.type === 'multiple' ? 'bg-green-200 text-green-800' :
                                    grid.type === 'fill' ? 'bg-orange-200 text-orange-800' :
                                    'bg-gray-100 hover:bg-gray-200'
                                } p-2 rounded-lg text-sm font-semibold transition-all">
                                    <div class="text-xs">${grid.number}</div>
                                    <div class="font-mono">${grid.answer}</div>
                                </button>
                            `).join('')}
                        </div>
                        <div class="flex gap-4">
                            <button onclick="markSelectedGrids()" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600">âœ“ æ¨™è¨˜é¸ä¸­çš„æ ¼å­</button>
                            <button onclick="clearSelection()" class="px-6 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400">æ¸…é™¤é¸æ“‡</button>
                            <button onclick="resetAllGrids()" class="px-6 bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600">é‡è¨­å…¨éƒ¨</button>
                        </div>
                    </div>
                    ${questions.length > 0 ? `
                        <div class="mb-6 p-6 bg-green-50 rounded-xl">
                            <h3 class="font-bold text-lg mb-4 text-green-700">é¡Œç›®ç¸½è¦½ï¼š</h3>
                            <div class="space-y-2">
                                ${questions.map((q, idx) => `
                                    <div class="p-3 bg-white rounded-lg flex justify-between items-center">
                                        <div>
                                            <span class="font-semibold">ç¬¬ ${idx + 1} é¡Œï¼š</span>
                                            <span class="ml-2 px-2 py-1 rounded text-sm ${
                                                q.type === 'single' ? 'bg-blue-100 text-blue-700' :
                                                q.type === 'multiple' ? 'bg-green-100 text-green-700' :
                                                'bg-orange-100 text-orange-700'
                                            }">${q.typeName}</span>
                                            <span class="ml-2 text-gray-600">æ ¼ ${q.originalIndices.map(i => i + 1).join('+')}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <button onclick="generateScoringMatrix()" class="mt-6 w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-xl text-xl font-bold hover:shadow-2xl transition-all transform hover:scale-105">ä¸‹ä¸€æ­¥ï¼šç”Ÿæˆè©•åˆ†è¡¨ â†’</button>
                        </div>
                    ` : ''}
                    <button onclick="currentStep=1; updateStepIndicator(); renderStep1();" class="mt-4 bg-gray-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-600">â† è¿”å›ä¸Šä¸€æ­¥</button>
                </div>
            `;
        }

        function renderStep4Loading() {
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mx-auto mb-4"></div>
                    <h2 class="text-2xl font-bold text-gray-700 mb-2">æ­£åœ¨åŸ·è¡Œå°ˆæ¥­åˆ†æ...</h2>
                    <p class="text-gray-500">Rasch æ¨¡å‹ä¼°è¨ˆ | é©é…åº¦æª¢å®š | é‘‘åˆ¥åº¦è¨ˆç®— | èª˜ç­”åˆ†æ | å››å‘åº¦è¨ºæ–·</p>
                </div>
            `;
        }

        function renderStep4Results(data) {
            const content = document.getElementById('mainContent');
            content.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-3xl font-bold mb-6 text-green-600">âœ… å°ˆæ¥­è©¦é¡Œåˆ†æå®Œæˆï¼</h2>
                    <div class="tab-container">
                        <button class="tab active" onclick="switchTab(event, 'summary')">ğŸ“Š ç¸½è¦½</button>
                        <button class="tab" onclick="switchTab(event, 'wrightmap')">ğŸ—ºï¸ Wright Map</button>
                        <button class="tab" onclick="switchTab(event, 'itemfit')">ğŸ”¬ é¡Œç›®é©é…åº¦</button>
                        <button class="tab" onclick="switchTab(event, 'discrimination')">ğŸ“ˆ é¡Œç›®é‘‘åˆ¥åº¦</button>
                        <button class="tab" onclick="switchTab(event, 'bubble')">ğŸ«§ æ°£æ³¡åœ–åˆ†æ</button>
                        <button class="tab" onclick="switchTab(event, 'distractor')">ğŸ¯ èª˜ç­”åˆ†æ</button>
                        <button class="tab" onclick="switchTab(event, 'individual')">ğŸ‘¥ å€‹äººå››å‘åº¦</button>
                        <button class="tab" onclick="switchTab(event, 'class')">ğŸ“š ç­ç´šçµ±è¨ˆ</button>
                    </div>
                    <div id="tab-summary" class="tab-content active">${createSummaryView(data)}</div>
                    <div id="tab-wrightmap" class="tab-content">${createWrightMapView(data)}</div>
                    <div id="tab-itemfit" class="tab-content">${createItemFitView(data)}</div>
                    <div id="tab-discrimination" class="tab-content">${createDiscriminationView(data)}</div>
                    <div id="tab-bubble" class="tab-content">${createBubbleChartView(data)}</div>
                    <div id="tab-distractor" class="tab-content">${createDistractorView(data)}</div>
                    <div id="tab-individual" class="tab-content">${createIndividualTable(data)}</div>
                    <div id="tab-class" class="tab-content">${createClassStats(data)}</div>
                    <button onclick="location.reload()" class="mt-6 bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-600">ğŸ”„ é‡æ–°é–‹å§‹</button>
                </div>
            `;
            setupFilters();
        }

        function createSummaryView(data) {
            return `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-6 text-gray-800">ğŸ“Š åˆ†æç¸½è¦½èˆ‡ä¿¡åº¦çµ±è¨ˆ</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg"><div class="text-sm text-blue-600 font-semibold">å—æ¸¬äººæ•¸</div><div class="text-3xl font-bold text-blue-800">${data.nPersons}</div></div>
                    <div class="bg-green-100 p-4 rounded-lg"><div class="text-sm text-green-600 font-semibold">é¡Œç›®æ•¸é‡</div><div class="text-3xl font-bold text-green-800">${data.nItems}</div></div>
                    <div class="bg-purple-100 p-4 rounded-lg"><div class="text-sm text-purple-600 font-semibold">å¹³å‡èƒ½åŠ›å€¼</div><div class="text-3xl font-bold text-purple-800">${(data.personAbility.reduce((a,b)=>a+b,0)/data.nPersons).toFixed(3)}</div></div>
                    <div class="bg-orange-100 p-4 rounded-lg"><div class="text-sm text-orange-600 font-semibold">EAP ä¿¡åº¦</div><div class="text-3xl font-bold text-orange-800">${data.reliability.toFixed(3)}</div></div>
                </div>
                <div class="info-box mb-6">
                    <h4 class="font-bold mb-2">ğŸ“Œ ä¿¡åº¦åˆ¤æ–·æ¨™æº–ï¼š</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Î± â‰¥ 0.9</strong>ï¼šå„ªç§€ï¼ˆExcellentï¼‰</li>
                        <li><strong>0.8 â‰¤ Î± < 0.9</strong>ï¼šè‰¯å¥½ï¼ˆGoodï¼‰</li>
                        <li><strong>0.7 â‰¤ Î± < 0.8</strong>ï¼šå°šå¯ï¼ˆAcceptableï¼‰</li>
                        <li><strong>0.6 â‰¤ Î± < 0.7</strong>ï¼šå¯ç–‘ï¼ˆQuestionableï¼‰</li>
                        <li><strong>Î± < 0.6</strong>ï¼šä¸ä½³ï¼ˆPoorï¼‰ï¼Œå»ºè­°å¢åŠ é¡Œæ•¸æˆ–æ”¹å–„é¡Œç›®</li>
                    </ul>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg"><h4 class="font-bold mb-2 text-center">å­¸ç”Ÿèƒ½åŠ›åˆ†å¸ƒ</h4><img src="${data.abilityDistUrl}" class="w-full"></div>
                    <div class="bg-white p-4 rounded-lg"><h4 class="font-bold mb-2 text-center">é¡Œç›®é›£åº¦åˆ†å¸ƒ</h4><img src="${data.difficultyDistUrl}" class="w-full"></div>
                </div>
            </div>`;
        }

        function createWrightMapView(data) {
            return `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">ğŸ—ºï¸ Wright Map - å—æ¸¬è€…èƒ½åŠ›èˆ‡é¡Œç›®é›£åº¦åˆ†å¸ƒåœ–</h3>
                <div class="info-box mb-4">
                    <p class="font-semibold mb-2">åœ–è¡¨èªªæ˜ï¼š</p>
                    <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                        <li><strong>å·¦å´</strong>ï¼šå—æ¸¬è€…èƒ½åŠ›åˆ†å¸ƒï¼ˆæ¯å€‹ X ä»£è¡¨ä¸€ä½å—æ¸¬è€…ï¼‰</li>
                        <li><strong>å³å´</strong>ï¼šé¡Œç›®é›£åº¦åˆ†å¸ƒï¼ˆé¡¯ç¤ºé¡Œè™Ÿï¼‰</li>
                        <li><strong>ç›¸åŒé«˜åº¦</strong>ï¼šè¡¨ç¤ºèƒ½åŠ›å€¼æˆ–é›£åº¦å€¼ç›¸è¿‘</li>
                        <li><strong>è§£è®€</strong>ï¼šå—æ¸¬è€…ä½ç½®é«˜æ–¼é¡Œç›® â†’ èƒ½åŠ› > é›£åº¦ â†’ é æœŸç­”å°</li>
                        <li><strong>è§£è®€</strong>ï¼šå—æ¸¬è€…ä½ç½®ä½æ–¼é¡Œç›® â†’ èƒ½åŠ› < é›£åº¦ â†’ é æœŸç­”éŒ¯</li>
                    </ul>
                </div>
                <div class="bg-white p-4 rounded-lg"><img src="${data.wrightmapUrl}" class="max-w-full h-auto mx-auto"></div>
            </div>`;
        }

        function createItemFitView(data) {
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">ğŸ”¬ é¡Œç›®é©é…åº¦åˆ†æï¼ˆInfit / Outfitï¼‰</h3>
                <div class="info-box mb-4">
                    <h4 class="font-bold mb-2">ğŸ“Œ é©é…åº¦åˆ¤æ–·æ¨™æº–ï¼š</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>0.7 â‰¤ MNSQ â‰¤ 1.3</strong>ï¼šğŸŸ¢ è‰¯å¥½ï¼ˆé¡Œç›®ç¬¦åˆ Rasch æ¨¡å‹ï¼‰</li>
                        <li><strong>0.6 â‰¤ MNSQ < 0.7 æˆ– 1.3 < MNSQ â‰¤ 1.4</strong>ï¼šğŸŸ¡ å¯æ¥å—</li>
                        <li><strong>MNSQ < 0.6 æˆ– MNSQ > 1.4</strong>ï¼šğŸ”´ éœ€æª¢è¨</li>
                    </ul>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-sm bg-white">
                    <thead class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                        <tr><th class="p-3 text-left">é¡Œè™Ÿ</th><th class="p-3 text-left">é›£åº¦ (Î²)</th><th class="p-3 text-left">SE</th><th class="p-3 text-left">Infit MNSQ</th><th class="p-3 text-left">Infit t</th><th class="p-3 text-left">Outfit MNSQ</th><th class="p-3 text-left">Outfit t</th><th class="p-3 text-left">åˆ¤æ–·</th></tr>
                    </thead><tbody>`;
            
            for (let i = 0; i < data.nItems; i++) {
                const infit = data.itemInfit[i], outfit = data.itemOutfit[i];
                let status = 'ğŸŸ¢ è‰¯å¥½', statusClass = 'bg-green-100';
                if (infit > 1.4 || outfit > 1.4 || infit < 0.6 || outfit < 0.6) {
                    status = 'ğŸ”´ éœ€æª¢è¨'; statusClass = 'bg-red-100';
                } else if ((infit > 1.3 && infit <= 1.4) || (outfit > 1.3 && outfit <= 1.4) || (infit >= 0.6 && infit < 0.7) || (outfit >= 0.6 && outfit < 0.7)) {
                    status = 'ğŸŸ¡ å¯æ¥å—'; statusClass = 'bg-yellow-100';
                }
                html += `<tr class="border-b hover:bg-gray-50 ${statusClass}">
                    <td class="p-3 font-semibold">Q${i+1}</td><td class="p-3">${data.itemDifficulty[i].toFixed(3)}</td><td class="p-3">${data.itemSE[i].toFixed(3)}</td>
                    <td class="p-3 ${infit > 1.3 || infit < 0.7 ? 'font-bold text-red-600' : ''}">${infit.toFixed(3)}</td><td class="p-3">${data.itemInfitT[i].toFixed(2)}</td>
                    <td class="p-3 ${outfit > 1.3 || outfit < 0.7 ? 'font-bold text-red-600' : ''}">${outfit.toFixed(3)}</td><td class="p-3">${data.itemOutfitT[i].toFixed(2)}</td>
                    <td class="p-3">${status}</td></tr>`;
            }
            html += `</tbody></table></div>
                <button class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600" onclick="downloadItemFit()">ğŸ“¥ åŒ¯å‡ºé©é…åº¦çµ±è¨ˆ</button>
            </div>`;
            return html;
        }

        function createDiscriminationView(data) {
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“ˆ é¡Œç›®é‘‘åˆ¥åº¦åˆ†æï¼ˆPoint-Biserial Correlationï¼‰</h3>
                <div class="info-box mb-4">
                    <h4 class="font-bold mb-2">ğŸ“Œ é‘‘åˆ¥åº¦åˆ¤æ–·æ¨™æº–ï¼š</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>rpb â‰¥ 0.4</strong>ï¼šğŸŸ¢ å„ªç§€</li><li><strong>0.3 â‰¤ rpb < 0.4</strong>ï¼šğŸŸ¢ è‰¯å¥½</li><li><strong>0.2 â‰¤ rpb < 0.3</strong>ï¼šğŸŸ¡ å°šå¯</li><li><strong>rpb < 0.2</strong>ï¼šğŸ”´ ä¸ä½³</li>
                    </ul>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-sm bg-white">
                    <thead class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                        <tr><th class="p-3 text-left">é¡Œè™Ÿ</th><th class="p-3 text-left">é›£åº¦ (Î²)</th><th class="p-3 text-left">é‘‘åˆ¥åº¦ (rpb)</th><th class="p-3 text-left">ç­‰ç´š</th><th class="p-3 text-left">åˆ¤æ–·</th></tr>
                    </thead><tbody>`;
            
            for (let i = 0; i < data.nItems; i++) {
                const disc = data.itemDiscrimination[i];
                let level = '', status = '', statusClass = '';
                if (disc < 0) { level = 'åš´é‡å•é¡Œ'; status = 'ğŸ”´ğŸ”´ é¡Œç›®æœ‰èª¤'; statusClass = 'bg-red-200'; }
                else if (disc < 0.1) { level = 'æ¥µå·®'; status = 'ğŸ”´ å»ºè­°åˆªé™¤'; statusClass = 'bg-red-100'; }
                else if (disc < 0.2) { level = 'ä¸ä½³'; status = 'ğŸ”´ ç¼ºä¹é‘‘åˆ¥åŠ›'; statusClass = 'bg-orange-100'; }
                else if (disc < 0.3) { level = 'å°šå¯'; status = 'ğŸŸ¡ å»ºè­°æ”¹å–„'; statusClass = 'bg-yellow-100'; }
                else if (disc < 0.4) { level = 'è‰¯å¥½'; status = 'ğŸŸ¢ å¯æ¥å—'; statusClass = 'bg-green-100'; }
                else { level = 'å„ªç§€'; status = 'ğŸŸ¢ é‘‘åˆ¥åŠ›ä½³'; statusClass = 'bg-green-200'; }
                html += `<tr class="border-b hover:bg-gray-50 ${statusClass}">
                    <td class="p-3 font-semibold">Q${i+1}</td><td class="p-3">${data.itemDifficulty[i].toFixed(3)}</td>
                    <td class="p-3 ${disc < 0.2 ? 'font-bold text-red-600' : disc >= 0.4 ? 'font-bold text-green-600' : ''}">${disc.toFixed(3)}</td>
                    <td class="p-3">${level}</td><td class="p-3">${status}</td></tr>`;
            }
            html += `</tbody></table></div>
                <button class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600" onclick="downloadDiscrimination()">ğŸ“¥ åŒ¯å‡ºé‘‘åˆ¥åº¦çµ±è¨ˆ</button>
            </div>`;
            return html;
        }

        function createBubbleChartView(data) {
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">ğŸ«§ é¡Œç›®å“è³ªæ°£æ³¡åœ–</h3>
                <div class="info-box mb-4">
                    <h4 class="font-bold mb-2">ğŸ“Œ æ°£æ³¡åœ–èªªæ˜ï¼š</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>Xè»¸</strong>ï¼šé›£åº¦å€¼ï¼ˆRasch Î²ï¼‰</li><li><strong>Yè»¸</strong>ï¼šé‘‘åˆ¥åº¦ï¼ˆrpbï¼‰</li><li><strong>æ°£æ³¡å¤§å°</strong>ï¼šæ¨™æº–èª¤ï¼ˆSEï¼‰</li><li><strong>é¡è‰²</strong>ï¼šç¶ è‰²=å„ªè‰¯ã€æ©˜è‰²=å°šå¯ã€ç´…è‰²=éœ€æ”¹é€²</li>
                    </ul>
                </div>
                <div class="bg-white p-4 rounded-lg mb-4"><canvas id="bubbleChartCanvas" style="max-height: 600px;"></canvas></div>`;
            
            const anomalies = [];
            for (let i = 0; i < data.nItems; i++) {
                const issues = [];
                if (data.itemDiscrimination[i] < 0.2) issues.push('é‘‘åˆ¥åº¦éä½');
                if (data.itemInfit[i] > 1.4 || data.itemOutfit[i] > 1.4) issues.push('é©é…åº¦ä¸è‰¯');
                if (data.itemSE[i] > 0.5) issues.push('æ¸¬é‡èª¤å·®å¤§');
                if (issues.length > 0) anomalies.push({ itemNum: i + 1, issues });
            }
            
            if (anomalies.length > 0) {
                html += '<div class="error-box"><h4 class="font-bold mb-2">âš ï¸ ç•°å¸¸é¡Œç›®è­¦ç¤ºï¼š</h4><table class="w-full text-sm"><thead><tr><th class="p-2 text-left">é¡Œè™Ÿ</th><th class="p-2 text-left">å•é¡Œ</th></tr></thead><tbody>';
                anomalies.forEach(a => {
                    html += `<tr class="border-b"><td class="p-2">Q${a.itemNum}</td><td class="p-2">${a.issues.map(issue => `<span class="badge poor-badge">${issue}</span>`).join(' ')}</td></tr>`;
                });
                html += '</tbody></table></div>';
            } else {
                html += '<div class="info-box">âœ… æ‰€æœ‰é¡Œç›®å“è³ªè‰¯å¥½ï¼Œç„¡ç•°å¸¸é¡Œç›®</div>';
            }
            html += '</div>';
            setTimeout(() => renderBubbleChart(data), 100);
            return html;
        }

        function renderBubbleChart(data) {
            const ctx = document.getElementById('bubbleChartCanvas');
            if (!ctx) return;
            
            const bubbleData = [];
            for (let i = 0; i < data.nItems; i++) {
                const difficulty = data.itemDifficulty[i];
                const discrimination = data.itemDiscrimination[i];
                const se = data.itemSE[i];
                let color = (discrimination >= 0.3 && se < 0.3) ? 'rgba(34, 197, 94, 0.7)' : 
                           (discrimination >= 0.2 && se < 0.4) ? 'rgba(251, 146, 60, 0.7)' : 'rgba(239, 68, 68, 0.7)';
                bubbleData.push({ x: difficulty, y: discrimination, r: se * 50, label: `Q${i+1}`, backgroundColor: color });
            }
            
            new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: bubbleData.map(d => ({
                        label: d.label,
                        data: [{ x: d.x, y: d.y, r: d.r }],
                        backgroundColor: d.backgroundColor
                    }))
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { title: { display: true, text: 'é›£åº¦å€¼ Î² (logit)' } }, y: { title: { display: true, text: 'é‘‘åˆ¥åº¦ rpb' }, beginAtZero: true } },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return [`é¡Œè™Ÿ: ${context.dataset.label}`, `é›£åº¦: ${context.parsed.x.toFixed(3)}`, `é‘‘åˆ¥åº¦: ${context.parsed.y.toFixed(3)}`, `æ¨™æº–èª¤: ${(context.parsed.r / 50).toFixed(3)}`];
                                }
                            }
                        }
                    }
                }
            });
        }

        function createDistractorView(data) {
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">ğŸ¯ èª˜ç­”é¸é …åˆ†æ</h3>
                <div class="info-box mb-4">
                    <h4 class="font-bold mb-2">ğŸ“Œ èª˜ç­”é¸é …å“è³ªåˆ¤æ–·ï¼š</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li><strong>æœ‰æ•ˆèª˜ç­”</strong>ï¼šğŸŸ¢ ä½èƒ½åŠ›å­¸ç”Ÿé¸æ“‡</li><li><strong>éœ€æª¢è¨èª˜ç­”</strong>ï¼šğŸŸ¡ ä¸­é«˜èƒ½åŠ›å­¸ç”Ÿé¸æ“‡</li><li><strong>ç„¡æ•ˆèª˜ç­”</strong>ï¼šğŸ”´ å¹¾ä¹æ²’äººé¸æ“‡ï¼ˆæ¯”ä¾‹ < 5%ï¼‰</li><li><strong>æ··æ·†é¸é …</strong>ï¼šğŸ”´ğŸ”´ é«˜èƒ½åŠ›å­¸ç”Ÿé¸æ“‡æ¯”ä¾‹é«˜</li>
                    </ul>
                </div>`;
            
            if (!data.distractorStats || data.distractorStats.length === 0) {
                html += '<div class="warning-box">âš ï¸ ç„¡æ³•é€²è¡Œèª˜ç­”åˆ†æï¼ˆå¯èƒ½æ˜¯é¸å¡«é¡Œæˆ–è³‡æ–™ä¸è¶³ï¼‰</div></div>';
                return html;
            }
            
            data.distractorStats.forEach(item => {
                html += `<div class="bg-white p-4 rounded-lg mb-4"><h4 class="font-bold mb-3 text-lg">Q${item.questionIndex} é¸é …åˆ†æ</h4>`;
                const options = Object.keys(item.options).sort();
                
                if (options.length === 0) {
                    html += '<div class="text-gray-500">ç„¡æœ‰æ•ˆä½œç­”è³‡æ–™</div>';
                } else {
                    html += '<table class="w-full text-sm"><thead class="bg-gray-200"><tr><th class="p-2 text-left">é¸é …</th><th class="p-2 text-left">é¸æ“‡äººæ•¸</th><th class="p-2 text-left">æ¯”ä¾‹</th><th class="p-2 text-left">å¹³å‡èƒ½åŠ›å€¼</th><th class="p-2 text-left">åˆ¤æ–·</th></tr></thead><tbody>';
                    const correctOption = item.correctAnswer;
                    const correctAvgAbility = item.options[correctOption] ? item.options[correctOption].avgAbility : 0;
                    
                    options.forEach(option => {
                        const stat = item.options[option];
                        const isCorrect = (option === correctOption);
                        const percentage = parseFloat(stat.percentage);
                        const avgAbility = stat.avgAbility;
                        let judgment = '', rowClass = '';
                        
                        if (isCorrect) { judgment = 'âœ“ æ­£ç¢ºç­”æ¡ˆ'; rowClass = 'bg-green-50 font-semibold'; }
                        else {
                            if (percentage < 5) { judgment = 'ğŸ”´ ç„¡æ•ˆèª˜ç­”'; rowClass = 'bg-red-50'; }
                            else if (avgAbility >= correctAvgAbility - 0.2) { judgment = 'ğŸ”´ğŸ”´ æ··æ·†é¸é …'; rowClass = 'bg-red-100'; }
                            else if (avgAbility >= correctAvgAbility - 0.5) { judgment = 'ğŸŸ¡ éœ€æª¢è¨'; rowClass = 'bg-yellow-50'; }
                            else { judgment = 'ğŸŸ¢ æœ‰æ•ˆèª˜ç­”'; rowClass = 'bg-gray-50'; }
                        }
                        html += `<tr class="${rowClass}"><td class="p-2">${option}${isCorrect ? ' â˜…' : ''}</td><td class="p-2">${stat.count}</td><td class="p-2">${stat.percentage}%</td><td class="p-2">${avgAbility.toFixed(3)}</td><td class="p-2">${judgment}</td></tr>`;
                    });
                    html += '</tbody></table>';
                }
                html += '</div>';
            });
            html += '<button class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600" onclick="downloadDistractor()">ğŸ“¥ åŒ¯å‡ºèª˜ç­”åˆ†æ</button></div>';
            return html;
        }

        // ä¿®æ­£1: å¢åŠ å§“åæ¬„ä½
        function createIndividualTable(data) {
            const classes = [...new Set(data.classInfo)];
            let html = `<div class="p-6 bg-gray-50 rounded-xl">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">ğŸ‘¥ å€‹äººå››å‘åº¦ç­”é¡Œåˆ†æï¼ˆå« KIDMAP è¨ºæ–·ï¼‰</h3>
                <div class="flex gap-4 mb-4 items-end flex-wrap">
                    <div><label class="block text-sm font-semibold mb-1">ç­ç´šç¯©é¸ï¼š</label>
                        <select id="classFilter" class="p-2 border-2 rounded-lg"><option value="all">å…¨éƒ¨ç­ç´š</option>`;
            classes.forEach(cls => { html += `<option value="${cls}">${cls}</option>`; });
            html += `</select></div>
                    <button class="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600" onclick="downloadFilteredIndividualStats()">ğŸ“¥ åŒ¯å‡ºå€‹äººçµ±è¨ˆ</button>
                </div>
                <div class="overflow-x-auto"><table class="w-full text-sm" id="individualTable">
                    <thead class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                        <tr><th class="p-3 text-left">ç­ç´š</th><th class="p-3 text-left">å­¸è™Ÿ</th><th class="p-3 text-left">å§“å</th><th class="p-3 text-left">èƒ½åŠ›å€¼ (Î¸)</th><th class="p-3 text-left">ç¸½åˆ†</th>
                        <th class="p-3 text-left bg-green-600">åˆç†ç­”å°</th><th class="p-3 text-left bg-orange-600">åˆç†ç­”éŒ¯</th>
                        <th class="p-3 text-left bg-blue-600">å„ªå‹¢æ¦‚å¿µ</th><th class="p-3 text-left bg-red-600">è¿·æ€æ¦‚å¿µ</th><th class="p-3 text-left">KIDMAP</th></tr>
                    </thead><tbody class="bg-white">`;
            
            data.individualStats.forEach(student => {
                const rowClass = student.misconceptionCount > 3 ? 'misconception-highlight' : '';
                html += `<tr class="${rowClass} border-b hover:bg-gray-50" data-class="${student.class}">
                    <td class="p-3">${student.class}</td>
                    <td class="p-3 font-semibold">${student.studentId}</td>
                    <td class="p-3">${student.studentName}</td>
                    <td class="p-3">${student.ability.toFixed(3)}</td>
                    <td class="p-3">${student.score} / ${data.nItems}</td>
                    <td class="p-3"><span class="badge reasonable-correct-badge">${student.reasonableCorrectCount} é¡Œ</span></td>
                    <td class="p-3"><span class="badge reasonable-wrong-badge">${student.reasonableWrongCount} é¡Œ</span></td>
                    <td class="p-3"><span class="badge advantage-badge">${student.advantageCount} é¡Œ</span></td>
                    <td class="p-3"><span class="badge misconception-badge">${student.misconceptionCount} é¡Œ</span></td>
                    <td class="p-3"><button class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg font-semibold hover:shadow-lg transition-all" onclick="showKidmapReport(${student.index})">ğŸ“Š æŸ¥çœ‹KIDMAP</button></td>
                </tr>`;
            });
            html += '</tbody></table></div></div>';
            return html;
        }

        // ä¿®æ­£1: å¢åŠ é€é¡Œåˆ†æè¡¨æ ¼
        window.showKidmapReport = function(studentIndex) {
            const student = analysisData.individualStats[studentIndex];
            const responses = analysisData.responseMatrix[studentIndex];
            const items = analysisData.itemDifficulty;
            
            const itemAnalysis = items.map((difficulty, i) => {
                const prob = 1 / (1 + Math.exp(-(student.ability - difficulty)));
                const actual = responses[i];
                const expected = prob > 0.5 ? 1 : 0;
                const unexpected = (actual === 1 && expected === 0) || (actual === 0 && expected === 1);
                return { name: `Q${i + 1}`, difficulty, actual, expected, probability: prob, unexpected };
            });
            
            const kidmapHTML = generateVisualKidmap(student, itemAnalysis);
            const diagnosticStats = generateDiagnosticStats(student, itemAnalysis);
            const itemAnalysisTable = generateItemAnalysisTable(itemAnalysis);
            
            document.getElementById('kidmapModalTitle').textContent = `KIDMAP è¨ºæ–·å ±å‘Š - ${student.class} ${student.studentId} ${student.studentName}`;
            document.getElementById('kidmapModalBody').innerHTML = `
                <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border-2 border-blue-200">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">åŸºæœ¬è³‡è¨Š</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="bg-white p-3 rounded-lg"><div class="text-xs text-gray-600 mb-1">å­¸è™Ÿ</div><div class="text-lg font-bold text-gray-800">${student.studentId}</div></div>
                        <div class="bg-white p-3 rounded-lg"><div class="text-xs text-gray-600 mb-1">å§“å</div><div class="text-lg font-bold text-gray-800">${student.studentName}</div></div>
                        <div class="bg-white p-3 rounded-lg"><div class="text-xs text-gray-600 mb-1">ç­ç´š</div><div class="text-lg font-bold text-gray-800">${student.class}</div></div>
                        <div class="bg-white p-3 rounded-lg"><div class="text-xs text-gray-600 mb-1">èƒ½åŠ›å€¼ (Î¸)</div><div class="text-lg font-bold text-blue-600">${student.ability.toFixed(3)}</div></div>
                        <div class="bg-white p-3 rounded-lg"><div class="text-xs text-gray-600 mb-1">å¾—åˆ†</div><div class="text-lg font-bold text-green-600">${student.score}/${analysisData.nItems}</div></div>
                    </div>
                </div>
                ${diagnosticStats}
                ${kidmapHTML}
                ${itemAnalysisTable}
                <div class="mt-6 p-4 bg-yellow-50 rounded-xl border-2 border-yellow-200">
                    <h4 class="font-bold text-lg mb-3 text-yellow-800">ğŸ“ æ•™å­¸å»ºè­°</h4>
                    <ul class="list-disc list-inside space-y-2 text-sm">
                        ${student.misconceptionCount > 0 ? `<li class="text-red-700"><strong>è¿·æ€æ¦‚å¿µé¡Œç›®ï¼ˆ${student.misconceptionCount}é¡Œï¼‰ï¼š</strong>é¡Œè™Ÿ ${student.misconceptionItems.join(', ')} - å»ºè­°åŠ å¼·åŸºç¤è§€å¿µè¤‡ç¿’</li>` : ''}
                        ${student.advantageCount > 0 ? `<li class="text-blue-700"><strong>å„ªå‹¢æ¦‚å¿µé¡Œç›®ï¼ˆ${student.advantageCount}é¡Œï¼‰ï¼š</strong>é¡Œè™Ÿ ${student.advantageItems.join(', ')} - å¯æŒ‘æˆ°æ›´é«˜é›£åº¦</li>` : ''}
                        ${student.reasonableCorrectCount > analysisData.nItems * 0.7 ? `<li class="text-green-700"><strong>æ•´é«”è¡¨ç¾å„ªç•°</strong> - å»ºè­°é€²è¡Œå»¶ä¼¸å­¸ç¿’èˆ‡æ·±åŒ–ç†è§£</li>` : ''}
                    </ul>
                </div>
            `;
            document.getElementById('kidmapModal').style.display = 'block';
        };

        // æ–°å¢é€é¡Œåˆ†æè¡¨æ ¼
        function generateItemAnalysisTable(itemAnalysis) {
            return `
                <div class="mt-6 p-4 bg-white rounded-xl border-2 border-gray-200">
                    <h4 class="font-bold text-lg mb-3 text-gray-800">ğŸ“‹ é€é¡Œä½œç­”åˆ†æ</h4>
                    <div class="overflow-x-auto">
                        <table class="item-analysis-table">
                            <thead>
                                <tr>
                                    <th>é¡Œè™Ÿ</th>
                                    <th>é›£åº¦å€¼</th>
                                    <th>ä½œç­”çµæœ</th>
                                    <th>é æœŸçµæœ</th>
                                    <th>ç­”å°æ©Ÿç‡</th>
                                    <th>ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemAnalysis.map(item => `
                                    <tr class="${item.unexpected ? 'unexpected-cell' : ''}">
                                        <td><strong>${item.name}</strong></td>
                                        <td>${item.difficulty.toFixed(3)}</td>
                                        <td class="${item.actual === 1 ? 'correct-cell' : 'incorrect-cell'}">
                                            ${item.actual === 1 ? 'âœ“ ç­”å°' : 'âœ— ç­”éŒ¯'}
                                        </td>
                                        <td>${item.expected === 1 ? 'âœ“' : 'âœ—'}</td>
                                        <td>${(item.probability * 100).toFixed(1)}%</td>
                                        <td>${item.unexpected ? '<span class="badge poor-badge">æ„å¤–åæ‡‰</span>' : '<span class="badge good-badge">ç¬¦åˆé æœŸ</span>'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        window.closeKidmapModal = function() {
            document.getElementById('kidmapModal').style.display = 'none';
        };

        document.getElementById('kidmapModal').addEventListener('click', (e) => {
            if (e.target.id === 'kidmapModal') closeKidmapModal();
        });

        function generateDiagnosticStats(student, itemAnalysis) {
            const unexpected = itemAnalysis.filter(i => i.unexpected).length;
            const total = itemAnalysis.length;
            
            return `<div class="diagnostic-stats">
                <div class="diag-card ${unexpected > total * 0.2 ? 'warning' : 'success'}"><div class="diag-label">æ„å¤–åæ‡‰</div><div class="diag-value">${unexpected}/${total}</div><div class="text-xs mt-2">${((unexpected/total)*100).toFixed(1)}%</div></div>
                <div class="diag-card success"><div class="diag-label">åˆç†ç­”å°</div><div class="diag-value">${student.reasonableCorrectCount}</div><div class="text-xs mt-2">èƒ½åŠ›å€¼ > é›£åº¦</div></div>
                <div class="diag-card warning"><div class="diag-label">åˆç†ç­”éŒ¯</div><div class="diag-value">${student.reasonableWrongCount}</div><div class="text-xs mt-2">é›£åº¦ > èƒ½åŠ›å€¼</div></div>
                <div class="diag-card ${student.advantageCount > 0 ? 'success' : ''}"><div class="diag-label">å„ªå‹¢æ¦‚å¿µ</div><div class="diag-value">${student.advantageCount}</div><div class="text-xs mt-2">ç­”å°é›£é¡Œ</div></div>
                <div class="diag-card ${student.misconceptionCount > 0 ? 'danger' : 'success'}"><div class="diag-label">è¿·æ€æ¦‚å¿µ</div><div class="diag-value">${student.misconceptionCount}</div><div class="text-xs mt-2">ç­”éŒ¯æ˜“é¡Œ</div></div>
            </div>`;
        }

        // ä¿®æ­£1: ç¢ºä¿èƒ½åŠ›ç·šæ­£ç¢ºé¡¯ç¤º
        function generateVisualKidmap(student, itemAnalysis) {
            const sortedItems = [...itemAnalysis].sort((a, b) => b.difficulty - a.difficulty);
            const maxDiff = Math.max(...sortedItems.map(i => i.difficulty));
            const minDiff = Math.min(...sortedItems.map(i => i.difficulty));
            const range = maxDiff - minDiff || 1;
            
            // è¨ˆç®—èƒ½åŠ›ç·šä½ç½® (0-100çš„ç™¾åˆ†æ¯”)
            const abilityLinePosition = ((maxDiff - student.ability) / range) * 100;
            
            const advantageConcept = [], reasonableCorrect = [], misconception = [], reasonableIncorrect = [];
            
            sortedItems.forEach(item => {
                const badge = `<span class="item-badge ${item.actual === 1 ? 'correct' : 'incorrect'} ${item.unexpected ? 'unexpected' : ''}">${item.name} <span class="item-info">(${item.difficulty.toFixed(2)})</span></span>`;
                if (item.difficulty > student.ability) {
                    if (item.actual === 1) advantageConcept.push(badge);
                    else reasonableIncorrect.push(badge);
                } else {
                    if (item.actual === 1) reasonableCorrect.push(badge);
                    else misconception.push(badge);
                }
            });
            
            return `<div class="kidmap-visual">
                <style>
                    .kidmap-quadrants-container {
                        position: relative;
                    }
                    .kidmap-ability-line {
                        position: absolute;
                        left: 0;
                        right: 0;
                        height: 3px;
                        background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
                        z-index: 100;
                        box-shadow: 0 0 10px rgba(245, 87, 108, 0.5);
                        pointer-events: none;
top: calc(40px + ${abilityLinePosition}% * (100% - 80px) / 100);
}
</style>
<div class="kidmap-quadrants-container">
<div class="kidmap-quadrants">
<div class="kidmap-header">ğŸ“Š è¦–è¦ºåŒ– KIDMAP è¨ºæ–·åœ– - èƒ½åŠ›æ¸¬é‡ vs é¡Œç›®é›£åº¦åˆ†å¸ƒ</div>
<div class="quadrant quadrant-top-left">
                        <div class="quadrant-title">ğŸŒŸ å„ªå‹¢æ¦‚å¿µï¼ˆç­”å°è¼ƒé›£é¡Œç›®ï¼‰</div>
                        ${advantageConcept.length > 0 ? advantageConcept.join('') : '<div class="text-gray-500">ç„¡å„ªå‹¢æ¦‚å¿µé¡Œç›®</div>'}
                    </div>
                    <div class="quadrant quadrant-top-right">
                        <div class="quadrant-title">ğŸŸ  åˆç†ç­”éŒ¯ï¼ˆå¤ªé›£çš„é¡Œç›®ï¼‰</div>
                        ${reasonableIncorrect.length > 0 ? reasonableIncorrect.join('') : '<div class="text-gray-500">ç„¡åˆç†ç­”éŒ¯é¡Œç›®</div>'}
                    </div>
                    
                    <div class="quadrant quadrant-bottom-left">
                        <div class="quadrant-title">ğŸŸ¢ åˆç†ç­”å°ï¼ˆèƒ½åŠ›è¶³å¤ ï¼‰</div>
                        ${reasonableCorrect.length > 0 ? reasonableCorrect.join('') : '<div class="text-gray-500">ç„¡åˆç†ç­”å°é¡Œç›®</div>'}
                    </div>
                    <div class="quadrant quadrant-bottom-right">
                        <div class="quadrant-title">ğŸ”´ è¿·æ€æ¦‚å¿µï¼ˆæ‡‰æœƒå»ä¸æœƒï¼‰</div>
                        ${misconception.length > 0 ? misconception.join('') : '<div class="text-green-600 font-semibold">âœ… ç„¡è¿·æ€æ¦‚å¿µï¼Œè¡¨ç¾è‰¯å¥½ï¼</div>'}
                    </div>
                    
                    <div class="kidmap-footer">
                        <strong>åˆ¤è®€èªªæ˜ï¼š</strong>èƒ½åŠ›ç·šä»¥ä¸Šç‚ºã€Œè¼ƒé›£é¡Œç›®ã€ï¼Œä»¥ä¸‹ç‚ºã€Œè¼ƒç°¡å–®é¡Œç›®ã€ã€‚
                        <strong>ç¶ è‰²å¾½ç« </strong> = ç­”å° | <strong>ç´…è‰²å¾½ç« </strong> = ç­”éŒ¯ | <strong>é–ƒçˆé‚Šæ¡†</strong> = æ„å¤–åæ‡‰
                    </div>
                </div>
                <div class="kidmap-ability-line">
                    <div class="ability-label">å­¸ç”Ÿèƒ½åŠ›å€¼ Î¸ = ${student.ability.toFixed(3)}</div>
                </div>
            </div>
        </div>`;
    }

    // ä¿®æ­£3: å¢åŠ åˆç†ç­”éŒ¯æ’è¡Œ
    function createClassStats(data) {
        const classes = Object.keys(data.classStats);
        let html = `<div class="p-6 bg-gray-50 rounded-xl">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“š ç­ç´šå››å‘åº¦çµ±è¨ˆæ‘˜è¦</h3>
            
            <div class="download-section">
                <h4 class="text-xl font-bold mb-4 text-blue-800 flex items-center gap-2">
                    ğŸ“„ ä¸‹è¼‰ PDF å ±å‘Š
                </h4>
                <div class="flex gap-4 mb-4 flex-wrap">
                    ${classes.map(cls => `
                        <label class="flex items-center gap-2 bg-white px-4 py-2 rounded-lg border-2 border-gray-200 hover:border-blue-400 cursor-pointer transition-all">
                            <input type="checkbox" class="class-checkbox w-4 h-4" value="${cls}">
                            <span class="font-semibold">${cls} (${data.classStats[cls].count}äºº)</span>
                        </label>
                    `).join('')}
                </div>
                <div class="flex gap-4 flex-wrap">
                    <button onclick="downloadSelectedClassPDF()" class="download-btn">
                        ğŸ“¥ ä¸‹è¼‰å·²é¸ç­ç´š
                    </button>
                    <button onclick="downloadAllClassPDF()" class="download-btn">
                        ğŸ“¥ ä¸‹è¼‰å…¨éƒ¨ç­ç´š
                    </button>
                </div>
                
                <div class="progress-container" style="display: none; margin-top: 20px;">
                    <div class="progress-text" style="text-align: center; margin-bottom: 10px; font-weight: 600; color: #4facfe;">
                        æº–å‚™ç”Ÿæˆ PDF...
                    </div>
                    <div class="progress-bar" style="width: 100%; height: 30px; background: #e0e0e0; border-radius: 15px; overflow: hidden;">
                        <div class="progress-fill" style="height: 100%; width: 0%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                            0%
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto mb-6"><table class="w-full text-sm bg-white">
                <thead class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                    <tr><th class="p-3 text-left">ç­ç´š</th><th class="p-3 text-left">äººæ•¸</th><th class="p-3 text-left bg-green-600">å¹³å‡åˆç†ç­”å°</th><th class="p-3 text-left bg-orange-600">å¹³å‡åˆç†ç­”éŒ¯</th><th class="p-3 text-left bg-blue-600">å¹³å‡å„ªå‹¢æ¦‚å¿µ</th><th class="p-3 text-left bg-red-600">å¹³å‡è¿·æ€æ¦‚å¿µ</th><th class="p-3 text-left">ç¸½è¿·æ€æ¦‚å¿µ</th></tr>
                </thead><tbody>`;
        
        classes.forEach(cls => {
            const stats = data.classStats[cls];
            html += `<tr class="border-b hover:bg-gray-50">
                <td class="p-3 font-semibold">${cls}</td><td class="p-3">${stats.count}</td>
                <td class="p-3"><span class="badge reasonable-correct-badge">${stats.avgReasonableCorrect.toFixed(2)} é¡Œ</span></td>
                <td class="p-3"><span class="badge reasonable-wrong-badge">${stats.avgReasonableWrong.toFixed(2)} é¡Œ</span></td>
                <td class="p-3"><span class="badge advantage-badge">${stats.avgAdvantage.toFixed(2)} é¡Œ</span></td>
                <td class="p-3"><span class="badge misconception-badge">${stats.avgMisconception.toFixed(2)} é¡Œ</span></td>
                <td class="p-3">${stats.totalMisconception} æ¬¡</td></tr>`;
        });
        
        html += '</tbody></table></div>';
        
        // ä¿®æ­£3: ä¸¦åˆ—é¡¯ç¤ºè¿·æ€æ¦‚å¿µå’Œåˆç†ç­”éŒ¯
        html += '<div class="grid md:grid-cols-2 gap-6">';
        
        // è¿·æ€æ¦‚å¿µæ’è¡Œ
        html += '<div><h3 class="text-2xl font-bold mb-4 text-red-600">ğŸ”´ å„ç­è¿·æ€æ¦‚å¿µé¡Œè™Ÿæ’è¡Œ</h3>';
        classes.forEach(cls => {
            const misconceptionItems = data.classMisconceptionItems[cls] || [];
            html += `<div class="bg-white p-4 rounded-lg mb-4 border-2 border-red-200">
                <h4 class="font-bold mb-3 text-lg">${cls} ç­è¿·æ€é¡Œç›®æ’è¡Œ</h4>`;
            if (misconceptionItems.length === 0) {
                html += '<div class="text-green-600">âœ… æœ¬ç­ç„¡è¿·æ€æ¦‚å¿µé¡Œç›®</div>';
            } else {
                html += '<table class="w-full text-sm"><thead class="bg-red-100"><tr><th class="p-2 text-left">æ’å</th><th class="p-2 text-left">é¡Œè™Ÿ</th><th class="p-2 text-left">éŒ¯èª¤äººæ•¸</th><th class="p-2 text-left">éŒ¯èª¤ç‡</th></tr></thead><tbody>';
                misconceptionItems.slice(0, 10).forEach((item, idx) => {
                    html += `<tr class="border-b hover:bg-red-50"><td class="p-2 font-bold text-red-600">#${idx + 1}</td><td class="p-2">Q${item.itemNum}</td><td class="p-2">${item.count} äºº</td><td class="p-2">${item.percentage}%</td></tr>`;
                });
                html += '</tbody></table>';
            }
            html += '</div>';
        });
        html += '</div>';
        
        // åˆç†ç­”éŒ¯æ’è¡Œ
        html += '<div><h3 class="text-2xl font-bold mb-4 text-orange-600">ğŸŸ  å„ç­åˆç†ç­”éŒ¯é¡Œè™Ÿæ’è¡Œ</h3>';
        classes.forEach(cls => {
            const reasonableWrongItems = data.classReasonableWrongItems[cls] || [];
            html += `<div class="bg-white p-4 rounded-lg mb-4 border-2 border-orange-200">
                <h4 class="font-bold mb-3 text-lg">${cls} ç­åˆç†ç­”éŒ¯æ’è¡Œ</h4>`;
            if (reasonableWrongItems.length === 0) {
                html += '<div class="text-green-600">âœ… æœ¬ç­ç„¡åˆç†ç­”éŒ¯é¡Œç›®</div>';
            } else {
                html += '<table class="w-full text-sm"><thead class="bg-orange-100"><tr><th class="p-2 text-left">æ’å</th><th class="p-2 text-left">é¡Œè™Ÿ</th><th class="p-2 text-left">ç­”éŒ¯äººæ•¸</th><th class="p-2 text-left">ç­”éŒ¯ç‡</th></tr></thead><tbody>';
                reasonableWrongItems.slice(0, 10).forEach((item, idx) => {
                    html += `<tr class="border-b hover:bg-orange-50"><td class="p-2 font-bold text-orange-600">#${idx + 1}</td><td class="p-2">Q${item.itemNum}</td><td class="p-2">${item.count} äºº</td><td class="p-2">${item.percentage}%</td></tr>`;
                });
                html += '</tbody></table>';
            }
            html += '</div>';
        });
        html += '</div>';
        
        html += '</div>'; // close grid
        
        html += '<button class="mt-4 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600" onclick="downloadClassStats()">ğŸ“¥ åŒ¯å‡ºç­ç´šçµ±è¨ˆ</button></div>';
        return html;
    }

    function setupFilters() {
        const classFilter = document.getElementById('classFilter');
        const table = document.getElementById('individualTable');
        if (!classFilter || !table) return;
        classFilter.addEventListener('change', () => {
            const selectedClass = classFilter.value;
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const rowClass = row.dataset.class;
                row.style.display = (selectedClass === 'all' || rowClass === selectedClass) ? '' : 'none';
            });
        });
    }

    window.switchTab = function(event, tabName) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
    };

    // ä¿®æ­£2: æ ¹æ“šç¯©é¸åŒ¯å‡ºå€‹äººçµ±è¨ˆ
    window.downloadFilteredIndividualStats = function() {
        if (!analysisData) return;
        
        const classFilter = document.getElementById('classFilter');
        const selectedClass = classFilter ? classFilter.value : 'all';
        
        let filteredStats = analysisData.individualStats;
        if (selectedClass !== 'all') {
            filteredStats = filteredStats.filter(s => s.class === selectedClass);
        }
        
        let csv = 'CLASS,StudentID,StudentName,Ability,Score,åˆç†ç­”å°,åˆç†ç­”éŒ¯,å„ªå‹¢æ¦‚å¿µ,è¿·æ€æ¦‚å¿µ,åˆç†ç­”å°é¡Œç›®,åˆç†ç­”éŒ¯é¡Œç›®,å„ªå‹¢æ¦‚å¿µé¡Œç›®,è¿·æ€æ¦‚å¿µé¡Œç›®\n';
        filteredStats.forEach(s => {
            csv += `${s.class},${s.studentId},${s.studentName},${s.ability.toFixed(3)},${s.score},${s.reasonableCorrectCount},${s.reasonableWrongCount},${s.advantageCount},${s.misconceptionCount},"${s.reasonableCorrectItems.join(',')}","${s.reasonableWrongItems.join(',')}","${s.advantageItems.join(',')}","${s.misconceptionItems.join(',')}"\n`;
        });
        
        const filename = selectedClass === 'all' ? 'individual_four_categories_all.csv' : `individual_four_categories_${selectedClass}.csv`;
        downloadCSV(csv, filename);
    };

    window.downloadClassStats = function() {
        if (!analysisData) return;
        const classes = Object.keys(analysisData.classStats);
        let csv = 'CLASS,Count,å¹³å‡åˆç†ç­”å°,å¹³å‡åˆç†ç­”éŒ¯,å¹³å‡å„ªå‹¢æ¦‚å¿µ,å¹³å‡è¿·æ€æ¦‚å¿µ,ç¸½åˆç†ç­”å°,ç¸½åˆç†ç­”éŒ¯,ç¸½å„ªå‹¢æ¦‚å¿µ,ç¸½è¿·æ€æ¦‚å¿µ\n';
        classes.forEach(cls => {
            const s = analysisData.classStats[cls];
            csv += `${cls},${s.count},${s.avgReasonableCorrect.toFixed(2)},${s.avgReasonableWrong.toFixed(2)},${s.avgAdvantage.toFixed(2)},${s.avgMisconception.toFixed(2)},${s.totalReasonableCorrect},${s.totalReasonableWrong},${s.totalAdvantage},${s.totalMisconception}\n`;
        });
        downloadCSV(csv, 'class_four_categories.csv');
    };

    window.downloadItemFit = function() {
        if (!analysisData) return;
        let csv = 'Item,Difficulty,SE,Infit_MNSQ,Infit_t,Outfit_MNSQ,Outfit_t\n';
        for (let i = 0; i < analysisData.nItems; i++) {
            csv += `Q${i+1},${analysisData.itemDifficulty[i].toFixed(3)},${analysisData.itemSE[i].toFixed(3)},${analysisData.itemInfit[i].toFixed(3)},${analysisData.itemInfitT[i].toFixed(2)},${analysisData.itemOutfit[i].toFixed(3)},${analysisData.itemOutfitT[i].toFixed(2)}\n`;
        }
        downloadCSV(csv, 'item_fit_statistics.csv');
    };

    window.downloadDiscrimination = function() {
        if (!analysisData) return;
        let csv = 'Item,Difficulty,Discrimination\n';
        for (let i = 0; i < analysisData.nItems; i++) {
            csv += `Q${i+1},${analysisData.itemDifficulty[i].toFixed(3)},${analysisData.itemDiscrimination[i].toFixed(3)}\n`;
        }
        downloadCSV(csv, 'item_discrimination.csv');
    };

    window.downloadDistractor = function() {
        if (!analysisData || !analysisData.distractorStats) return;
        let csv = 'Item,Option,Count,Percentage,AvgAbility,IsCorrect\n';
        analysisData.distractorStats.forEach(item => {
            const options = Object.keys(item.options).sort();
            options.forEach(option => {
                const stat = item.options[option];
                const isCorrect = (option === item.correctAnswer) ? 'Yes' : 'No';
                csv += `Q${item.questionIndex},${option},${stat.count},${stat.percentage},${stat.avgAbility.toFixed(3)},${isCorrect}\n`;
            });
        });
        downloadCSV(csv, 'distractor_analysis.csv');
    };

    function downloadCSV(csvContent, filename) {
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // PDF ä¸‹è¼‰åŠŸèƒ½ä¿æŒä¸è®Š...
    window.downloadSelectedClassPDF = async function() {
        const checkboxes = document.querySelectorAll('.class-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç­ç´š');
            return;
        }
        
        const selectedClasses = Array.from(checkboxes).map(cb => cb.value);
        const selectedStudents = analysisData.individualStats
            .map((student, index) => ({ student, index }))
            .filter(({ student }) => selectedClasses.includes(student.class));
        
        await generatePDFZip(selectedStudents, 'å·²é¸ç­ç´š');
    };

    window.downloadAllClassPDF = async function() {
        if (!analysisData) return;
        const allStudents = analysisData.individualStats.map((student, index) => ({ student, index }));
        await generatePDFZip(allStudents, 'å…¨éƒ¨ç­ç´š');
    };

    async function generatePDFZip(studentList, description) {
        const zip = new JSZip();
        
        const progressContainer = document.querySelector('.progress-container');
        const progressFill = document.querySelector('.progress-fill');
        const progressText = document.querySelector('.progress-text');
        
        if (!progressContainer || !progressFill || !progressText) {
            console.error('æ‰¾ä¸åˆ°é€²åº¦æ¢å…ƒç´ ');
            alert('ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é€²åº¦æ¢å…ƒç´ ');
            return;
        }
        
        progressContainer.style.display = 'block';
        progressFill.style.width = '0%';
        progressFill.textContent = '0%';
        progressText.textContent = 'æº–å‚™ç”Ÿæˆ PDF...';
        
        document.querySelectorAll('.download-btn').forEach(btn => btn.disabled = true);
        
        try {
            const classFolders = {};
            studentList.forEach(({ student, index }) => {
                const className = student.class;
                if (!classFolders[className]) {
                    classFolders[className] = [];
                }
                classFolders[className].push({ student, index });
            });
            
            const totalStudents = studentList.length;
            let processedCount = 0;
            
            console.log(`é–‹å§‹ç”Ÿæˆ ${totalStudents} ä»½ PDF å ±å‘Š...`);
            
            for (const [className, students] of Object.entries(classFolders)) {
                for (const { student, index } of students) {
                    try {
                        progressText.textContent = `æ­£åœ¨ç”Ÿæˆ ${student.class} - ${student.studentId} ${student.studentName} çš„å ±å‘Š... (${processedCount + 1}/${totalStudents})`;
                        
                        const pdfBlob = await generateStudentPDF(student, index);
                        
                        const fileName = `${student.class}_${student.studentId}_${student.studentName}.pdf`;
                        zip.folder(className).file(fileName, pdfBlob);
                        
                        processedCount++;
                        const progress = Math.round((processedCount / totalStudents) * 100);
                        progressFill.style.width = progress + '%';
                        progressFill.textContent = progress + '%';
                        
                        if (processedCount % 5 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                        
                    } catch (error) {
                        console.error(`ç”Ÿæˆ ${student.studentId} çš„ PDF æ™‚å‡ºéŒ¯:`, error);
                    }
                }
            }
            
            progressText.textContent = 'æ­£åœ¨å£“ç¸®æª”æ¡ˆ...';
            console.log('æ­£åœ¨å£“ç¸® ZIP æª”æ¡ˆ...');
            
            const zipBlob = await zip.generateAsync({ 
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            });
            
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(zipBlob);
            downloadLink.download = `KIDMAPè¨ºæ–·å ±å‘Š_${description}_${new Date().toISOString().slice(0,10)}.zip`;
            downloadLink.click();
            
            alert(`æˆåŠŸç”Ÿæˆ ${totalStudents} ä»½ PDF å ±å‘Šä¸¦ä¸‹è¼‰ï¼`);
            console.log(`ZIP æª”æ¡ˆä¸‹è¼‰å®Œæˆï¼Œå…± ${totalStudents} ä»½å ±å‘Š`);
            
        } catch (error) {
            console.error('PDF ç”ŸæˆéŒ¯èª¤:', error);
            alert('PDF ç”Ÿæˆå¤±æ•—: ' + error.message);
        } finally {
            progressContainer.style.display = 'none';
            document.querySelectorAll('.download-btn').forEach(btn => btn.disabled = false);
        }
    }
    
    async function generateStudentPDF(student, studentIndex) {
        const { jsPDF } = window.jspdf;
        
        const responses = analysisData.responseMatrix[studentIndex];
        const items = analysisData.itemDifficulty;
        
        const itemAnalysis = items.map((difficulty, i) => {
            const prob = 1 / (1 + Math.exp(-(student.ability - difficulty)));
            const actual = responses[i];
            const expected = prob > 0.5 ? 1 : 0;
            const unexpected = (actual === 1 && expected === 0) || (actual === 0 && expected === 1);
            
            return {
                name: `Q${i + 1}`,
                difficulty: difficulty,
                actual: actual,
                expected: expected,
                probability: prob,
                unexpected: unexpected
            };
        });
        
        const page1HTML = generatePage1HTML(student, itemAnalysis);
        const page2HTML = generatePage2HTML(student, itemAnalysis);
        
        const pdfContainer = document.getElementById('pdfContainer');
        
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4',
            compress: true
        });
        
        pdfContainer.innerHTML = page1HTML;
        await new Promise(resolve => setTimeout(resolve, 300));
        
        const canvas1 = await html2canvas(pdfContainer.querySelector('.pdf-page-1'), {
            scale: 3,
            useCORS: true,
            logging: false,
            width: 794,
            windowWidth: 794
        });
        
        const imgData1 = canvas1.toDataURL('image/png', 1.0);
        pdf.addImage(imgData1, 'PNG', 0, 0, 210, 297, undefined, 'FAST');
        
        pdfContainer.innerHTML = page2HTML;
        await new Promise(resolve => setTimeout(resolve, 300));
        
        const canvas2 = await html2canvas(pdfContainer.querySelector('.pdf-page-2'), {
            scale: 3,
            useCORS: true,
            logging: false,
            width: 794,
            windowWidth: 794
        });
        
        const imgData2 = canvas2.toDataURL('image/png', 1.0);
        pdf.addPage();
        pdf.addImage(imgData2, 'PNG', 0, 0, 210, 297, undefined, 'FAST');
        
        return pdf.output('blob');
    }
    
    function generatePage1HTML(student, itemAnalysis) {
        const kidmapHTML = generateVisualKidmap(student, itemAnalysis);
        const diagnosticStats = generateDiagnosticStats(student, itemAnalysis);
        const feedback = generateFeedback(student, itemAnalysis);
        
        return `
            <div class="pdf-page pdf-page-1" style="font-family: 'Microsoft JhengHei', sans-serif;">
                <div class="header-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; text-align: center; border-radius: 8px; margin-bottom: 10px;">
                    <h1 style="margin: 0; font-size: 22px;">KIDMAP å­¸ç¿’è¨ºæ–·å ±å‘Š</h1>
                    <p style="margin: 5px 0 0 0; font-size: 10px;">Rasch æ¸¬é‡ç†è«–åˆ†æ</p>
                </div>
                
                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                    <h2 style="color: #333; margin: 0 0 8px 0; font-size: 16px;">åŸºæœ¬è³‡è¨Š</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                        <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #667eea;">
                            <div style="font-size: 9px; color: #666; margin-bottom: 3px;">å­¸è™Ÿ</div>
                            <div style="font-size: 14px; font-weight: 700; color: #333;">${student.studentId}</div>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #667eea;">
                            <div style="font-size: 9px; color: #666; margin-bottom: 3px;">å§“å</div>
                            <div style="font-size: 14px; font-weight: 700; color: #333;">${student.studentName}</div>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #667eea;">
                            <div style="font-size: 9px; color: #666; margin-bottom: 3px;">ç­ç´š</div>
                            <div style="font-size: 14px; font-weight: 700; color: #333;">${student.class}</div>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #667eea;">
                            <div style="font-size: 9px; color: #666; margin-bottom: 3px;">èƒ½åŠ›å€¼ (Î¸)</div>
                            <div style="font-size: 14px; font-weight: 700; color: #333;">${student.ability.toFixed(2)}</div>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #667eea;">
                            <div style="font-size: 9px; color: #666; margin-bottom: 3px;">åŸå§‹åˆ†æ•¸</div>
                            <div style="font-size: 14px; font-weight: 700; color: #333;">${student.score}/${analysisData.nItems}</div>
                        </div>
                        <div style="background: white; padding: 8px; border-radius: 6px; border-left: 3px solid #667eea;">
                            <div style="font-size: 9px; color: #666; margin-bottom: 3px;">å¾—åˆ†ç‡</div>
                            <div style="font-size: 14px; font-weight: 700; color: #333;">${((student.score/analysisData.nItems)*100).toFixed(1)}%</div>
                        </div>
                    </div>
                </div>
                
                ${diagnosticStats}
                ${feedback}
                ${kidmapHTML}
                
                <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 6px; text-align: center; font-size: 8px; color: #666;">
                    <p style="margin: 0;">ç¬¬ 1 é ï¼Œå…± 2 é  | å ±å‘Šç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}</p>
                </div>
            </div>
        `;
    }
    
    function generatePage2HTML(student, itemAnalysis) {
        return `
            <div class="pdf-page pdf-page-2" style="font-family: 'Microsoft JhengHei', sans-serif;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; text-align: center; border-radius: 8px; margin-bottom: 15px;">
                    <h2 style="margin: 0; font-size: 18px;">é€é¡Œåˆ†æ - ${student.class} ${student.studentId} ${student.studentName}</h2>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; font-size: 9px;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <th style="padding: 8px; text-align: left;">é¡Œè™Ÿ</th>
                            <th style="padding: 8px; text-align: center;">é›£åº¦å€¼</th>
                            <th style="padding: 8px; text-align: center;">ä½œç­”</th>
                            <th style="padding: 8px; text-align: center;">é æœŸ</th>
                            <th style="padding: 8px; text-align: center;">é€šéæ©Ÿç‡</th>
                            <th style="padding: 8px; text-align: center;">å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemAnalysis.map(item => `
                            <tr style="border-bottom: 1px solid #e0e0e0;">
                                <td style="padding: 6px 8px;"><strong>${item.name}</strong></td>
                                <td style="padding: 6px 8px; text-align: center;">${item.difficulty.toFixed(2)}</td>
                                <td style="padding: 6px 8px; text-align: center; color: ${item.actual === 1 ? '#198754' : '#dc3545'}; font-weight: 700;">
                                    ${item.actual === 1 ? 'âœ“' : 'âœ—'}
                                </td>
                                <td style="padding: 6px 8px; text-align: center;">${item.expected === 1 ? 'âœ“' : 'âœ—'}</td>
                                <td style="padding: 6px 8px; text-align: center;">${(item.probability * 100).toFixed(1)}%</td>
                                <td style="padding: 6px 8px; text-align: center; font-size: 7px;">${item.unexpected ? '<span style="background: #fff3cd; padding: 2px 6px; border-radius: 4px;">âš  æ„å¤–</span>' : ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 8px; color: #666;">
                    <p style="margin: 0 0 5px 0;"><strong>èªªæ˜ï¼š</strong></p>
                    <p style="margin: 0;">â€¢ <strong>é›£åº¦å€¼</strong>ï¼šé¡Œç›®çš„ Rasch é›£åº¦åƒæ•¸ï¼Œæ•¸å€¼è¶Šå¤§è¡¨ç¤ºé¡Œç›®è¶Šé›£</p>
                    <p style="margin: 0;">â€¢ <strong>ä½œç­”</strong>ï¼šå­¸ç”Ÿå¯¦éš›ä½œç­”çµæœï¼ˆâœ“ ç­”å° / âœ— ç­”éŒ¯ï¼‰</p>
                    <p style="margin: 0;">â€¢ <strong>é æœŸ</strong>ï¼šåŸºæ–¼å­¸ç”Ÿèƒ½åŠ›å€¼é æœŸçš„ä½œç­”çµæœ</p>
                    <p style="margin: 0;">â€¢ <strong>é€šéæ©Ÿç‡</strong>ï¼šæ ¹æ“š Rasch æ¨¡å‹è¨ˆç®—çš„ç­”å°æ©Ÿç‡</p>
                    <p style="margin: 0;">â€¢ <strong>âš  æ„å¤–åæ‡‰</strong>ï¼šå¯¦éš›ä½œç­”èˆ‡é æœŸä¸ç¬¦ï¼Œéœ€ç‰¹åˆ¥é—œæ³¨</p>
                    <p style="margin: 10px 0 0 0; font-size: 7px; color: #999;">ç¬¬ 2 é ï¼Œå…± 2 é  | KIDMAP è¨ºæ–·ç³»çµ± - åŸºæ–¼ Rasch æ¸¬é‡ç†è«–</p>
                </div>
            </div>
        `;
    }

    function generateFeedback(student, itemAnalysis) {
        const unexpected = itemAnalysis.filter(i => i.unexpected);
        const hardCorrect = itemAnalysis.filter(i => i.actual === 1 && i.difficulty > student.ability);
        const easyIncorrect = itemAnalysis.filter(i => i.actual === 0 && i.difficulty < student.ability);
        
        let feedback = '<div style="background: #fff5e6; padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #ff9800;">';
        feedback += '<h3 style="color: #e65100; margin: 0 0 8px 0; font-size: 14px;">ğŸ“ è¨ºæ–·å›é¥‹èˆ‡å»ºè­°</h3>';
        
        if (hardCorrect.length > 0) {
            feedback += `<p style="font-size: 10px; margin: 5px 0; line-height: 1.4;"><span style="color: #2e7d32; font-weight: 600;">âœ“ å„ªå‹¢è¡¨ç¾ï¼š</span>æ‚¨åœ¨è¼ƒé›£é¡Œç›®ï¼ˆ${hardCorrect.map(i => i.name).join('ã€')}ï¼‰è¡¨ç¾å„ªç•°ã€‚</p>`;
        }
        
        if (easyIncorrect.length > 0) {
            feedback += `<p style="font-size: 10px; margin: 5px 0; line-height: 1.4;"><span style="color: #c62828; font-weight: 600;">âœ— éœ€åŠ å¼·ï¼š</span>å»ºè­°è¤‡ç¿’è¼ƒç°¡å–®çš„é¡Œç›®ï¼ˆ${easyIncorrect.map(i => i.name).join('ã€')}ï¼‰ã€‚</p>`;
        }
        
        if (unexpected.length > itemAnalysis.length * 0.2) {
            feedback += `<p style="font-size: 10px; margin: 5px 0; line-height: 1.4;"><span style="color: #c62828; font-weight: 600;">âš  æ³¨æ„ï¼š</span>ä½œç­”æ¨¡å¼é¡¯ç¤ºè¼ƒå¤šæ„å¤–åæ‡‰ï¼ˆ${unexpected.length}é¡Œï¼‰ï¼Œå»ºè­°æ³¨æ„ç­”é¡Œä¸€è‡´æ€§ã€‚</p>`;
        }
        
        feedback += '</div>';
        
        return feedback;
    }

    initWebR();
    updateStepIndicator();
    renderStep1();
</script>
</body>
</html>
